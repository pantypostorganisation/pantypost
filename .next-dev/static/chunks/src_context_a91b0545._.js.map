{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/AuthContext.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, {\r\n  createContext,\r\n  useContext,\r\n  useEffect,\r\n  useState,\r\n  ReactNode,\r\n  useCallback,\r\n  useRef,\r\n} from 'react';\r\nimport { usePathname, useRouter } from 'next/navigation';\r\nimport { apiConfig } from '@/config/environment';\r\nimport { z } from 'zod';\r\nimport { sanitizeUsername } from '@/utils/security/sanitization';\r\n\r\n// ==================== TYPES ====================\r\n\r\nexport interface User {\r\n  id: string;\r\n  username: string;\r\n  role: 'buyer' | 'seller' | 'admin';\r\n  email?: string;\r\n  profilePicture?: string;\r\n  isVerified: boolean;\r\n  tier?: 'Tease' | 'Flirt' | 'Obsession' | 'Desire' | 'Goddess';\r\n  subscriberCount?: number;\r\n  totalSales?: number;\r\n  rating?: number;\r\n  reviewCount?: number;\r\n  createdAt: string;\r\n  lastActive: string;\r\n  bio?: string;\r\n  isBanned?: boolean;\r\n  banReason?: string;\r\n  banExpiresAt?: string;\r\n  verificationStatus: 'pending' | 'verified' | 'rejected' | 'unverified';\r\n  verificationRequestedAt?: string;\r\n  verificationRejectionReason?: string;\r\n  verificationDocs?: any;\r\n}\r\n\r\ninterface AuthTokens {\r\n  token: string;\r\n  refreshToken: string;\r\n  expiresAt: number; // Unix timestamp (ms)\r\n}\r\n\r\ninterface AuthContextType {\r\n  user: User | null;\r\n  isAuthReady: boolean;\r\n  login: (\r\n    username: string,\r\n    password: string,\r\n    role?: 'buyer' | 'seller' | 'admin'\r\n  ) => Promise<boolean>;\r\n  logout: () => Promise<void>;\r\n  updateUser: (updates: Partial<User>) => Promise<void>;\r\n  isLoggedIn: boolean;\r\n  loading: boolean;\r\n  error: string | null;\r\n  clearError: () => void;\r\n  refreshSession: () => Promise<void>;\r\n  getAuthToken: () => string | null;\r\n  apiClient: ApiClient;\r\n  token: string | null; // compatibility\r\n}\r\n\r\n// ==================== SCHEMAS ====================\r\n\r\nconst LoginPayloadSchema = z.object({\r\n  username: z.string().min(1).max(60),\r\n  password: z.string().min(1),\r\n  role: z.enum(['buyer', 'seller', 'admin']).optional(),\r\n});\r\n\r\ntype LoginPayload = z.infer<typeof LoginPayloadSchema>;\r\n\r\n// ==================== HELPERS ====================\r\n\r\nfunction safeNow(): number {\r\n  try {\r\n    return Date.now();\r\n  } catch {\r\n    return new Date().getTime();\r\n  }\r\n}\r\n\r\n/**\r\n * Safely parse JSON; return null if empty/invalid.\r\n */\r\nasync function safeParseJson<T>(resp: Response): Promise<T | null> {\r\n  try {\r\n    const text = await resp.text();\r\n    if (!text) return null;\r\n    return JSON.parse(text) as T;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Derive absolute expiry from `expiresIn` (seconds or ms).\r\n * Fallback to defaultMs when not provided.\r\n */\r\nfunction deriveExpiry(expiresIn: unknown, defaultMs: number): number {\r\n  const now = safeNow();\r\n  if (typeof expiresIn === 'number' && Number.isFinite(expiresIn)) {\r\n    // Heuristic: values <= 24*60*60*100 (i.e., less than 1 day if treated as ms)\r\n    // are likely seconds; multiply by 1000. Otherwise assume ms.\r\n    const asMs = expiresIn < 86_400 ? expiresIn * 1000 : expiresIn;\r\n    return now + asMs;\r\n  }\r\n  return now + defaultMs;\r\n}\r\n\r\n// ==================== API CLIENT ====================\r\n\r\nclass ApiClient {\r\n  private baseURL: string;\r\n  private authContext: {\r\n    getTokens: () => AuthTokens | null;\r\n    setTokens: (tokens: AuthTokens | null) => void;\r\n    onTokenRefresh?: () => Promise<void>;\r\n  };\r\n  private refreshPromise: Promise<AuthTokens | null> | null = null;\r\n\r\n  constructor(\r\n    baseURL: string,\r\n    authContext: {\r\n      getTokens: () => AuthTokens | null;\r\n      setTokens: (tokens: AuthTokens | null) => void;\r\n      onTokenRefresh?: () => Promise<void>;\r\n    }\r\n  ) {\r\n    this.baseURL = baseURL.replace(/\\/+$/, ''); // strip trailing slashes\r\n    this.authContext = authContext;\r\n  }\r\n\r\n  /**\r\n   * Build full API URL - handles both relative and absolute endpoints\r\n   */\r\n  private buildUrl(endpoint: string): string {\r\n    // If endpoint already starts with http/https, return as is\r\n    if (endpoint.startsWith('http://') || endpoint.startsWith('https://')) {\r\n      return endpoint;\r\n    }\r\n\r\n    // Ensure endpoint starts with /\r\n    const path = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;\r\n\r\n    // If baseURL already ends with /api, don't add it again\r\n    if (this.baseURL.endsWith('/api')) {\r\n      return `${this.baseURL}${path}`;\r\n    }\r\n\r\n    // Otherwise, add /api prefix to the path\r\n    return `${this.baseURL}/api${path}`;\r\n  }\r\n\r\n  private async refreshTokens(): Promise<AuthTokens | null> {\r\n    // Prevent multiple simultaneous refresh attempts\r\n    if (this.refreshPromise) {\r\n      return this.refreshPromise;\r\n    }\r\n\r\n    const tokens = this.authContext.getTokens();\r\n    if (!tokens?.refreshToken) {\r\n      return null;\r\n    }\r\n\r\n    this.refreshPromise = (async () => {\r\n      try {\r\n        const response = await fetch(this.buildUrl('/auth/refresh'), {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ refreshToken: tokens.refreshToken }),\r\n        });\r\n\r\n        // Gracefully parse JSON (may be empty on some implementations)\r\n        const data = await safeParseJson<any>(response);\r\n\r\n        if (response.ok && data?.success && data?.data) {\r\n          const expiresAt = deriveExpiry(\r\n            // try both common fields\r\n            data.data.expiresIn ?? data.data.tokenExpiresIn,\r\n            30 * 60 * 1000 // fallback 30 minutes\r\n          );\r\n\r\n          const newTokens: AuthTokens = {\r\n            token: data.data.token,\r\n            refreshToken: data.data.refreshToken || tokens.refreshToken,\r\n            expiresAt,\r\n          };\r\n\r\n          this.authContext.setTokens(newTokens);\r\n\r\n          // Fire token update event for WebSocket\r\n          if (typeof window !== 'undefined') {\r\n            window.dispatchEvent(\r\n              new CustomEvent('auth-token-updated', {\r\n                detail: { token: newTokens.token },\r\n              })\r\n            );\r\n          }\r\n\r\n          // Call the refresh callback if provided\r\n          if (this.authContext.onTokenRefresh) {\r\n            await this.authContext.onTokenRefresh();\r\n          }\r\n\r\n          return newTokens;\r\n        }\r\n\r\n        // If refresh failed, clear tokens\r\n        throw new Error('Invalid refresh response');\r\n      } catch (error) {\r\n        console.error('Token refresh failed:', error);\r\n        this.authContext.setTokens(null);\r\n\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('auth-token-cleared'));\r\n        }\r\n\r\n        return null;\r\n      } finally {\r\n        this.refreshPromise = null;\r\n      }\r\n    })();\r\n\r\n    return this.refreshPromise;\r\n  }\r\n\r\n  private async getValidToken(): Promise<string | null> {\r\n    const tokens = this.authContext.getTokens();\r\n\r\n    if (!tokens) {\r\n      return null;\r\n    }\r\n\r\n    // Check if token is expired or about to expire (5 minutes buffer)\r\n    const isExpiringSoon = tokens.expiresAt <= safeNow() + 5 * 60 * 1000;\r\n\r\n    if (isExpiringSoon) {\r\n      const newTokens = await this.refreshTokens();\r\n      return newTokens?.token || null;\r\n    }\r\n\r\n    return tokens.token;\r\n  }\r\n\r\n  async request<T = any>(\r\n    endpoint: string,\r\n    options: RequestInit = {}\r\n  ): Promise<{ success: boolean; data?: T; error?: any }> {\r\n    const token = await this.getValidToken();\r\n\r\n    // Create headers as a plain object first\r\n    const headerObj: Record<string, string> = {\r\n      'Content-Type': 'application/json',\r\n    };\r\n\r\n    // Add existing headers from options\r\n    if (options.headers) {\r\n      const existingHeaders =\r\n        options.headers instanceof Headers\r\n          ? Object.fromEntries(options.headers.entries())\r\n          : Array.isArray(options.headers)\r\n          ? Object.fromEntries(options.headers)\r\n          : (options.headers as Record<string, string>);\r\n\r\n      Object.assign(headerObj, existingHeaders);\r\n    }\r\n\r\n    // Add auth token if available\r\n    if (token) {\r\n      headerObj['Authorization'] = `Bearer ${token}`;\r\n    }\r\n\r\n    const url = this.buildUrl(endpoint);\r\n\r\n    const doFetch = async () => {\r\n      const resp = await fetch(url, { ...options, headers: headerObj });\r\n      const json = await safeParseJson<any>(resp);\r\n\r\n      // If server returns our standard shape, just return it as-is\r\n      if (json && typeof json.success === 'boolean') {\r\n        return json;\r\n      }\r\n\r\n      // Otherwise normalize a minimal shape\r\n      if (resp.ok) {\r\n        return { success: true, data: json as T };\r\n      }\r\n      return {\r\n        success: false,\r\n        error: {\r\n          code: resp.status || 'HTTP_ERROR',\r\n          message: json?.error?.message || resp.statusText || 'Request failed',\r\n        },\r\n      };\r\n    };\r\n\r\n    try {\r\n      const result = await doFetch();\r\n\r\n      // Handle 401 Unauthorized - try to refresh token once\r\n      if (!result.success && (result as any)?.error?.code === 401 && token) {\r\n        const newTokens = await this.refreshTokens();\r\n        if (newTokens) {\r\n          headerObj['Authorization'] = `Bearer ${newTokens.token}`;\r\n          const retry = await doFetch();\r\n          return retry;\r\n        }\r\n      }\r\n\r\n      return result;\r\n    } catch (error) {\r\n      console.error('API request failed:', error);\r\n      return {\r\n        success: false,\r\n        error: {\r\n          code: 'NETWORK_ERROR',\r\n          message: 'Network request failed',\r\n        },\r\n      };\r\n    }\r\n  }\r\n\r\n  // Convenience methods\r\n  get<T = any>(endpoint: string, options?: RequestInit) {\r\n    return this.request<T>(endpoint, { ...options, method: 'GET' });\r\n  }\r\n\r\n  post<T = any>(endpoint: string, body?: any, options?: RequestInit) {\r\n    return this.request<T>(endpoint, {\r\n      ...options,\r\n      method: 'POST',\r\n      body: body ? JSON.stringify(body) : undefined,\r\n    });\r\n  }\r\n\r\n  patch<T = any>(endpoint: string, body?: any, options?: RequestInit) {\r\n    return this.request<T>(endpoint, {\r\n      ...options,\r\n      method: 'PATCH',\r\n      body: body ? JSON.stringify(body) : undefined,\r\n    });\r\n  }\r\n\r\n  delete<T = any>(endpoint: string, options?: RequestInit) {\r\n    return this.request<T>(endpoint, { ...options, method: 'DELETE' });\r\n  }\r\n}\r\n\r\n// ==================== AUTH CONTEXT ====================\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\n// Get API base URL from environment config\r\nconst API_BASE_URL =\r\n  apiConfig?.baseUrl || process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000';\r\n\r\n// Enhanced Token storage with WebSocket event support\r\nclass TokenStorage {\r\n  private memoryTokens: AuthTokens | null = null;\r\n\r\n  constructor() {\r\n    // Try to restore from sessionStorage on initialization\r\n    if (typeof window !== 'undefined') {\r\n      try {\r\n        const stored = sessionStorage.getItem('auth_tokens');\r\n        if (stored) {\r\n          this.memoryTokens = JSON.parse(stored);\r\n          // Fire initial token event if we have tokens\r\n          if (this.memoryTokens?.token) {\r\n            setTimeout(() => {\r\n              window.dispatchEvent(\r\n                new CustomEvent('auth-token-updated', {\r\n                  detail: { token: this.memoryTokens!.token },\r\n                })\r\n              );\r\n            }, 100);\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error('Failed to restore tokens:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  setTokens(tokens: AuthTokens | null) {\r\n    this.memoryTokens = tokens;\r\n\r\n    if (typeof window !== 'undefined') {\r\n      if (tokens) {\r\n        try {\r\n          sessionStorage.setItem('auth_tokens', JSON.stringify(tokens));\r\n          // Fire token update event\r\n          window.dispatchEvent(\r\n            new CustomEvent('auth-token-updated', {\r\n              detail: { token: tokens.token },\r\n            })\r\n          );\r\n        } catch (error) {\r\n          console.error('Failed to store tokens:', error);\r\n        }\r\n      } else {\r\n        sessionStorage.removeItem('auth_tokens');\r\n        // Fire token cleared event\r\n        window.dispatchEvent(new CustomEvent('auth-token-cleared'));\r\n      }\r\n    }\r\n  }\r\n\r\n  getTokens(): AuthTokens | null {\r\n    return this.memoryTokens;\r\n  }\r\n\r\n  clear() {\r\n    this.memoryTokens = null;\r\n    if (typeof window !== 'undefined') {\r\n      sessionStorage.removeItem('auth_tokens');\r\n      // Fire token cleared event\r\n      window.dispatchEvent(new CustomEvent('auth-token-cleared'));\r\n    }\r\n  }\r\n}\r\n\r\nexport function AuthProvider({ children }: { children: ReactNode }) {\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [isAuthReady, setIsAuthReady] = useState(false);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const pathname = usePathname();\r\n  const router = useRouter();\r\n\r\n  // Token storage instance\r\n  const tokenStorageRef = useRef(new TokenStorage());\r\n\r\n  // API client instance with auth context\r\n  const apiClientRef = useRef<ApiClient | null>(null);\r\n\r\n  // Refresh session - fetch current user\r\n  const refreshSession = useCallback(async () => {\r\n    const tokens = tokenStorageRef.current.getTokens();\r\n    if (!tokens?.token) {\r\n      setUser(null);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await apiClientRef.current!.get<User>('/auth/me');\r\n\r\n      if (response.success && response.data) {\r\n        setUser(response.data);\r\n      } else {\r\n        setUser(null);\r\n        tokenStorageRef.current.clear();\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to refresh session:', error);\r\n      setUser(null);\r\n      tokenStorageRef.current.clear();\r\n    }\r\n  }, []);\r\n\r\n  // Initialize API client\r\n  if (!apiClientRef.current) {\r\n    apiClientRef.current = new ApiClient(API_BASE_URL, {\r\n      getTokens: () => tokenStorageRef.current.getTokens(),\r\n      setTokens: (tokens) => tokenStorageRef.current.setTokens(tokens),\r\n      onTokenRefresh: async () => {\r\n        // Refresh user data after token refresh\r\n        await refreshSession();\r\n      },\r\n    });\r\n  }\r\n\r\n  // Clear error\r\n  const clearError = useCallback(() => {\r\n    setError(null);\r\n  }, []);\r\n\r\n  // Get auth token\r\n  const getAuthToken = useCallback(() => {\r\n    const tokens = tokenStorageRef.current.getTokens();\r\n    return tokens?.token || null;\r\n  }, []);\r\n\r\n  // Initialize auth state on mount\r\n  useEffect(() => {\r\n    const initAuth = async () => {\r\n      console.log('[Auth] Initializing...');\r\n      console.log('[Auth] API_BASE_URL:', API_BASE_URL);\r\n\r\n      try {\r\n        await refreshSession();\r\n      } catch (error) {\r\n        console.error('[Auth] Init error:', error);\r\n      } finally {\r\n        setIsAuthReady(true);\r\n        console.log('[Auth] Ready');\r\n      }\r\n    };\r\n\r\n    initAuth();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []); // refreshSession is stable here; intentional single-run\r\n\r\n  const login = useCallback(\r\n    async (\r\n      username: string,\r\n      password: string,\r\n      role: 'buyer' | 'seller' | 'admin' = 'buyer'\r\n    ): Promise<boolean> => {\r\n      console.log('[Auth] Login attempt:', { username, role, hasPassword: !!password });\r\n\r\n      setLoading(true);\r\n      setError(null);\r\n\r\n      try {\r\n        // Validate & sanitize inputs\r\n        const parsed = LoginPayloadSchema.safeParse({ username, password, role });\r\n        if (!parsed.success) {\r\n          setError('Please enter a valid username and password.');\r\n          setLoading(false);\r\n          return false;\r\n        }\r\n\r\n        const cleanUsername = sanitizeUsername\r\n          ? sanitizeUsername(parsed.data.username)\r\n          : parsed.data.username.trim();\r\n\r\n        const payload: LoginPayload = {\r\n          username: cleanUsername,\r\n          password: parsed.data.password,\r\n          role: parsed.data.role, // optional on backend; we pass it if present\r\n        };\r\n\r\n        // Use the API client which handles URL construction properly\r\n        const response = await apiClientRef.current!.post('/auth/login', payload);\r\n\r\n        console.log('[Auth] Login response:', {\r\n          success: response.success,\r\n          hasUser: !!response.data?.user,\r\n        });\r\n\r\n        if (response.success && response.data) {\r\n          // Calculate token expiration (prefer backend hints)\r\n          const expiresAt =\r\n            deriveExpiry(\r\n              // try common fields the backend might send\r\n              response.data.expiresIn ?? response.data.tokenExpiresIn,\r\n              7 * 24 * 60 * 60 * 1000 // fallback 7 days\r\n            );\r\n\r\n          const tokens: AuthTokens = {\r\n            token: response.data.token,\r\n            refreshToken: response.data.refreshToken,\r\n            expiresAt,\r\n          };\r\n\r\n          // Store tokens securely (fires auth-token-updated)\r\n          tokenStorageRef.current.setTokens(tokens);\r\n\r\n          // Set user state\r\n          setUser(response.data.user);\r\n\r\n          console.log('[Auth] Login successful');\r\n          setLoading(false);\r\n          return true;\r\n        } else {\r\n          const errorMessage = (response as any)?.error?.message || 'Login failed';\r\n          setError(errorMessage);\r\n          setLoading(false);\r\n          return false;\r\n        }\r\n      } catch (error) {\r\n        console.error('[Auth] Login error:', error);\r\n        setError('Network error. Please check your connection and try again.');\r\n        setLoading(false);\r\n        return false;\r\n      }\r\n    },\r\n    []\r\n  );\r\n\r\n  const logout = useCallback(async () => {\r\n    console.log('[Auth] Logging out...');\r\n\r\n    try {\r\n      const token = getAuthToken();\r\n      if (token) {\r\n        // Even if the server returns 204, our client handles it safely\r\n        await apiClientRef.current!.post('/auth/logout');\r\n      }\r\n    } catch (error) {\r\n      console.error('[Auth] Logout API error:', error);\r\n    }\r\n\r\n    // Clear local state regardless of API response (fires auth-token-cleared)\r\n    tokenStorageRef.current.clear();\r\n    setUser(null);\r\n    setError(null);\r\n\r\n    // Redirect to login page\r\n    router.push('/login');\r\n\r\n    console.log('[Auth] Logout complete');\r\n  }, [getAuthToken, router]);\r\n\r\n  // Update user function\r\n  const updateUser = useCallback(\r\n    async (updates: Partial<User>) => {\r\n      if (!user) {\r\n        setError('No user to update');\r\n        return;\r\n      }\r\n\r\n      try {\r\n        const response = await apiClientRef.current!.patch<User>(\r\n          `/users/${user.username}/profile`,\r\n          updates\r\n        );\r\n\r\n        if (response.success && response.data) {\r\n          setUser(response.data);\r\n        } else {\r\n          setError(response.error?.message || 'Failed to update user');\r\n        }\r\n      } catch (error: any) {\r\n        console.error('Update user error:', error);\r\n        setError(error.message || 'Failed to update user');\r\n      }\r\n    },\r\n    [user]\r\n  );\r\n\r\n  const contextValue: AuthContextType = {\r\n    user,\r\n    isAuthReady,\r\n    login,\r\n    logout,\r\n    updateUser,\r\n    isLoggedIn: !!user,\r\n    loading,\r\n    error,\r\n    clearError,\r\n    refreshSession,\r\n    getAuthToken,\r\n    apiClient: apiClientRef.current!,\r\n    token: getAuthToken(), // compatibility; use getAuthToken() for up-to-date value\r\n  };\r\n\r\n  return <AuthContext.Provider value={contextValue}>{children}</AuthContext.Provider>;\r\n}\r\n\r\nexport function useAuth() {\r\n  const context = useContext(AuthContext);\r\n  if (context === undefined) {\r\n    throw new Error('useAuth must be used within an AuthProvider');\r\n  }\r\n  return context;\r\n}\r\n\r\n// Export getAuthToken globally for WebSocket access\r\nexport const getGlobalAuthToken = (): string | null => {\r\n  if (typeof window === 'undefined') return null;\r\n\r\n  try {\r\n    const stored = sessionStorage.getItem('auth_tokens');\r\n    if (stored) {\r\n      const tokens = JSON.parse(stored);\r\n      return tokens?.token || null;\r\n    }\r\n  } catch (error) {\r\n    console.error('Failed to get global auth token:', error);\r\n  }\r\n\r\n  return null;\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 592, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/ToastContext.tsx"],"sourcesContent":["// src/context/ToastContext.tsx\r\n'use client';\r\n\r\nimport React, { createContext, useContext, useState, useCallback, useEffect, useRef } from 'react';\r\nimport { X, CheckCircle, AlertCircle, Info, AlertTriangle, Loader2 } from 'lucide-react';\r\nimport { AnimatePresence, motion } from 'framer-motion';\r\n\r\n// Toast types\r\nexport type ToastType = 'success' | 'error' | 'info' | 'warning' | 'loading';\r\n\r\nexport interface Toast {\r\n  id: string;\r\n  type: ToastType;\r\n  title: string;\r\n  message?: string;\r\n  duration?: number;\r\n  action?: {\r\n    label: string;\r\n    onClick: () => void;\r\n  };\r\n  dismissible?: boolean;\r\n  persistent?: boolean;\r\n}\r\n\r\ninterface ToastContextType {\r\n  toasts: Toast[];\r\n  showToast: (toast: Omit<Toast, 'id'>) => string;\r\n  updateToast: (id: string, updates: Partial<Toast>) => void;\r\n  removeToast: (id: string) => void;\r\n  clearToasts: () => void;\r\n  // Convenience methods\r\n  success: (title: string, message?: string) => string;\r\n  error: (title: string, message?: string) => string;\r\n  info: (title: string, message?: string) => string;\r\n  warning: (title: string, message?: string) => string;\r\n  loading: (title: string, message?: string) => string;\r\n  promise: <T>(\r\n    promise: Promise<T>,\r\n    messages: {\r\n      loading: string;\r\n      success: string | ((data: T) => string);\r\n      error: string | ((error: any) => string);\r\n    }\r\n  ) => Promise<T>;\r\n}\r\n\r\nconst ToastContext = createContext<ToastContextType | undefined>(undefined);\r\n\r\n// Default durations by type\r\nconst DEFAULT_DURATIONS: Record<ToastType, number> = {\r\n  success: 4000,\r\n  error: 6000,\r\n  info: 5000,\r\n  warning: 5000,\r\n  loading: 0, // No auto-dismiss for loading\r\n};\r\n\r\n// Toast icons\r\nconst TOAST_ICONS: Record<ToastType, React.FC<{ className?: string }>> = {\r\n  success: CheckCircle,\r\n  error: AlertCircle,\r\n  info: Info,\r\n  warning: AlertTriangle,\r\n  loading: Loader2,\r\n};\r\n\r\n// Toast colors\r\nconst TOAST_COLORS: Record<ToastType, { bg: string; border: string; icon: string }> = {\r\n  success: {\r\n    bg: 'bg-green-900/20',\r\n    border: 'border-green-700',\r\n    icon: 'text-green-400',\r\n  },\r\n  error: {\r\n    bg: 'bg-red-900/20',\r\n    border: 'border-red-700',\r\n    icon: 'text-red-400',\r\n  },\r\n  info: {\r\n    bg: 'bg-blue-900/20',\r\n    border: 'border-blue-700',\r\n    icon: 'text-blue-400',\r\n  },\r\n  warning: {\r\n    bg: 'bg-yellow-900/20',\r\n    border: 'border-yellow-700',\r\n    icon: 'text-yellow-400',\r\n  },\r\n  loading: {\r\n    bg: 'bg-gray-900/20',\r\n    border: 'border-gray-700',\r\n    icon: 'text-[#ff950e]',\r\n  },\r\n};\r\n\r\nexport function ToastProvider({ children }: { children: React.ReactNode }) {\r\n  const [toasts, setToasts] = useState<Toast[]>([]);\r\n  const timersRef = useRef<Map<string, NodeJS.Timeout>>(new Map());\r\n\r\n  // Generate unique ID\r\n  const generateId = () => `toast_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n  // Show toast\r\n  const showToast = useCallback((toast: Omit<Toast, 'id'>): string => {\r\n    const id = generateId();\r\n    const newToast: Toast = {\r\n      ...toast,\r\n      id,\r\n      duration: toast.duration ?? DEFAULT_DURATIONS[toast.type],\r\n      dismissible: toast.dismissible ?? true,\r\n    };\r\n\r\n    setToasts(prev => [...prev, newToast]);\r\n\r\n    // Auto-dismiss if duration is set and not persistent\r\n    if (newToast.duration && !newToast.persistent) {\r\n      const timer = setTimeout(() => {\r\n        removeToast(id);\r\n      }, newToast.duration);\r\n      timersRef.current.set(id, timer);\r\n    }\r\n\r\n    return id;\r\n  }, []);\r\n\r\n  // Update toast\r\n  const updateToast = useCallback((id: string, updates: Partial<Toast>) => {\r\n    setToasts(prev =>\r\n      prev.map(toast =>\r\n        toast.id === id\r\n          ? { ...toast, ...updates }\r\n          : toast\r\n      )\r\n    );\r\n\r\n    // Handle duration updates\r\n    if (updates.duration !== undefined) {\r\n      const existingTimer = timersRef.current.get(id);\r\n      if (existingTimer) {\r\n        clearTimeout(existingTimer);\r\n        timersRef.current.delete(id);\r\n      }\r\n\r\n      if (updates.duration && !updates.persistent) {\r\n        const timer = setTimeout(() => {\r\n          removeToast(id);\r\n        }, updates.duration);\r\n        timersRef.current.set(id, timer);\r\n      }\r\n    }\r\n  }, []);\r\n\r\n  // Remove toast\r\n  const removeToast = useCallback((id: string) => {\r\n    // Clear any existing timer\r\n    const timer = timersRef.current.get(id);\r\n    if (timer) {\r\n      clearTimeout(timer);\r\n      timersRef.current.delete(id);\r\n    }\r\n\r\n    setToasts(prev => prev.filter(toast => toast.id !== id));\r\n  }, []);\r\n\r\n  // Clear all toasts\r\n  const clearToasts = useCallback(() => {\r\n    // Clear all timers\r\n    timersRef.current.forEach(timer => clearTimeout(timer));\r\n    timersRef.current.clear();\r\n    \r\n    setToasts([]);\r\n  }, []);\r\n\r\n  // Convenience methods\r\n  const success = useCallback((title: string, message?: string) => \r\n    showToast({ type: 'success', title, message }), [showToast]);\r\n  \r\n  const error = useCallback((title: string, message?: string) => \r\n    showToast({ type: 'error', title, message }), [showToast]);\r\n  \r\n  const info = useCallback((title: string, message?: string) => \r\n    showToast({ type: 'info', title, message }), [showToast]);\r\n  \r\n  const warning = useCallback((title: string, message?: string) => \r\n    showToast({ type: 'warning', title, message }), [showToast]);\r\n  \r\n  const loading = useCallback((title: string, message?: string) => \r\n    showToast({ type: 'loading', title, message, persistent: true }), [showToast]);\r\n\r\n  // Promise handler\r\n  const promise = useCallback(async <T,>(\r\n    promise: Promise<T>,\r\n    messages: {\r\n      loading: string;\r\n      success: string | ((data: T) => string);\r\n      error: string | ((error: any) => string);\r\n    }\r\n  ): Promise<T> => {\r\n    const id = loading(messages.loading);\r\n\r\n    try {\r\n      const result = await promise;\r\n      const successMessage = typeof messages.success === 'function' \r\n        ? messages.success(result) \r\n        : messages.success;\r\n      \r\n      updateToast(id, { \r\n        type: 'success', \r\n        title: successMessage,\r\n        message: undefined,\r\n        duration: DEFAULT_DURATIONS.success,\r\n        persistent: false,\r\n      });\r\n      \r\n      return result;\r\n    } catch (error) {\r\n      const errorMessage = typeof messages.error === 'function' \r\n        ? messages.error(error) \r\n        : messages.error;\r\n      \r\n      updateToast(id, { \r\n        type: 'error', \r\n        title: errorMessage,\r\n        message: error instanceof Error ? error.message : undefined,\r\n        duration: DEFAULT_DURATIONS.error,\r\n        persistent: false,\r\n      });\r\n      \r\n      throw error;\r\n    }\r\n  }, [loading, updateToast]);\r\n\r\n  // Cleanup timers on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      timersRef.current.forEach(timer => clearTimeout(timer));\r\n      timersRef.current.clear();\r\n    };\r\n  }, []);\r\n\r\n  const value: ToastContextType = {\r\n    toasts,\r\n    showToast,\r\n    updateToast,\r\n    removeToast,\r\n    clearToasts,\r\n    success,\r\n    error,\r\n    info,\r\n    warning,\r\n    loading,\r\n    promise,\r\n  };\r\n\r\n  return (\r\n    <ToastContext.Provider value={value}>\r\n      {children}\r\n      <ToastContainer />\r\n    </ToastContext.Provider>\r\n  );\r\n}\r\n\r\n// Toast Container Component\r\nfunction ToastContainer() {\r\n  const context = useContext(ToastContext);\r\n  if (!context) return null;\r\n\r\n  const { toasts, removeToast } = context;\r\n\r\n  return (\r\n    <div className=\"fixed top-4 right-4 z-50 pointer-events-none\">\r\n      <AnimatePresence mode=\"popLayout\">\r\n        {toasts.map(toast => (\r\n          <ToastItem\r\n            key={toast.id}\r\n            toast={toast}\r\n            onRemove={() => removeToast(toast.id)}\r\n          />\r\n        ))}\r\n      </AnimatePresence>\r\n    </div>\r\n  );\r\n}\r\n\r\n// Individual Toast Component\r\nfunction ToastItem({ toast, onRemove }: { toast: Toast; onRemove: () => void }) {\r\n  const Icon = TOAST_ICONS[toast.type];\r\n  const colors = TOAST_COLORS[toast.type];\r\n\r\n  return (\r\n    <motion.div\r\n      initial={{ opacity: 0, y: -20, scale: 0.95 }}\r\n      animate={{ opacity: 1, y: 0, scale: 1 }}\r\n      exit={{ opacity: 0, scale: 0.95 }}\r\n      transition={{ duration: 0.2 }}\r\n      className=\"pointer-events-auto mb-3\"\r\n    >\r\n      <div className={`\r\n        ${colors.bg} ${colors.border}\r\n        border rounded-lg shadow-lg p-4\r\n        max-w-sm min-w-[300px]\r\n        backdrop-blur-sm\r\n      `}>\r\n        <div className=\"flex items-start gap-3\">\r\n          <Icon className={`w-5 h-5 ${colors.icon} flex-shrink-0 ${\r\n            toast.type === 'loading' ? 'animate-spin' : ''\r\n          }`} />\r\n          \r\n          <div className=\"flex-1\">\r\n            <h3 className=\"text-sm font-semibold text-white\">\r\n              {toast.title}\r\n            </h3>\r\n            {toast.message && (\r\n              <p className=\"text-xs text-gray-400 mt-1\">\r\n                {toast.message}\r\n              </p>\r\n            )}\r\n            {toast.action && (\r\n              <button\r\n                onClick={toast.action.onClick}\r\n                className=\"text-xs text-[#ff950e] hover:text-[#ff7a00] mt-2 font-medium\"\r\n              >\r\n                {toast.action.label}\r\n              </button>\r\n            )}\r\n          </div>\r\n          \r\n          {toast.dismissible && (\r\n            <button\r\n              onClick={onRemove}\r\n              className=\"text-gray-400 hover:text-white transition-colors\"\r\n            >\r\n              <X className=\"w-4 h-4\" />\r\n            </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </motion.div>\r\n  );\r\n}\r\n\r\n// Hook to use toast\r\nexport function useToast() {\r\n  const context = useContext(ToastContext);\r\n  if (!context) {\r\n    throw new Error('useToast must be used within a ToastProvider');\r\n  }\r\n  return context;\r\n}\r\n\r\n// Helper function for API errors\r\nexport function toastApiError(error: any, fallbackMessage = 'An error occurred') {\r\n  const context = useContext(ToastContext);\r\n  if (!context) return;\r\n\r\n  let message = fallbackMessage;\r\n  \r\n  if (error?.response?.data?.error?.message) {\r\n    message = error.response.data.error.message;\r\n  } else if (error?.message) {\r\n    message = error.message;\r\n  }\r\n\r\n  context.error('Error', message);\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1044, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/BanContext.tsx"],"sourcesContent":["'use client';\r\n\r\nimport {\r\n  createContext,\r\n  useContext,\r\n  useState,\r\n  useEffect,\r\n  ReactNode,\r\n  useCallback,\r\n  useRef,\r\n} from 'react';\r\nimport { storageService } from '@/services';\r\nimport { banService } from '@/services/ban.service';\r\nimport { usersService } from '@/services/users.service';\r\nimport { sanitizeStrict, sanitizeUsername } from '@/utils/security/sanitization';\r\nimport { z } from 'zod';\r\nimport { useAuth } from './AuthContext';\r\nimport { isAdmin } from '@/utils/security/permissions';\r\n\r\n// ================== Types ==================\r\nexport type BanType = 'temporary' | 'permanent';\r\nexport type BanReason =\r\n  | 'harassment'\r\n  | 'spam'\r\n  | 'inappropriate_content'\r\n  | 'scam'\r\n  | 'underage'\r\n  | 'payment_fraud'\r\n  | 'other';\r\nexport type AppealStatus = 'pending' | 'under_review' | 'approved' | 'rejected' | 'escalated';\r\n\r\nexport type UserBan = {\r\n  id: string;\r\n  username: string;\r\n  banType: BanType;\r\n  reason: BanReason;\r\n  customReason?: string;\r\n  startTime: string; // ISO\r\n  endTime?: string; // ISO for temporary\r\n  remainingHours?: number; // derived\r\n  bannedBy: string; // admin username\r\n  active: boolean;\r\n  appealable: boolean;\r\n  appealSubmitted?: boolean;\r\n  appealText?: string;\r\n  appealDate?: string;\r\n  appealStatus?: AppealStatus;\r\n  appealEvidence?: string[]; // base64 images\r\n  notes?: string;\r\n  reportIds?: string[];\r\n  ipAddress?: string;\r\n  expirationTimer?: ReturnType<typeof setTimeout>;\r\n};\r\n\r\nexport type BanHistory = {\r\n  id: string;\r\n  username: string;\r\n  action:\r\n    | 'banned'\r\n    | 'unbanned'\r\n    | 'appeal_submitted'\r\n    | 'appeal_approved'\r\n    | 'appeal_rejected'\r\n    | 'appeal_escalated';\r\n  details: string;\r\n  timestamp: string;\r\n  adminUsername: string;\r\n  metadata?: Record<string, any>;\r\n};\r\n\r\nexport type AppealReview = {\r\n  reviewId: string;\r\n  banId: string;\r\n  reviewerAdmin: string;\r\n  reviewNotes: string;\r\n  decision: 'approve' | 'reject' | 'escalate';\r\n  reviewDate: string;\r\n  escalationReason?: string;\r\n};\r\n\r\nexport type IPBan = {\r\n  ipAddress: string;\r\n  bannedUsernames: string[];\r\n  banDate: string;\r\n  expiryDate?: string;\r\n  reason: string;\r\n};\r\n\r\n// ================== Constants ==================\r\nconst STORAGE_KEYS = {\r\n  BANS: 'panty_user_bans',\r\n  HISTORY: 'panty_ban_history',\r\n  REVIEWS: 'panty_appeal_reviews',\r\n  IP_BANS: 'panty_ip_bans',\r\n} as const;\r\n\r\n/**\r\n * Reserved usernames that should never be bannable (system/service accounts).\r\n * NOTE: Not human admins; real admin checks use role via isAdmin(user).\r\n */\r\nconst RESERVED_USERNAMES = ['system', 'platform', 'admin', 'administrator', 'moderator', 'mod'] as const;\r\n\r\n/** Exact-match, case-insensitive protection for reserved accounts */\r\nconst isProtectedUsername = (username: string): boolean => {\r\n  const clean = (username || '').toLowerCase().trim();\r\n  return RESERVED_USERNAMES.includes(clean as (typeof RESERVED_USERNAMES)[number]);\r\n};\r\n\r\n// Ask backend for role (defensive, in case caller doesn’t pass role)\r\nconst checkUserRole = async (\r\n  username: string\r\n): Promise<'buyer' | 'seller' | 'admin' | null> => {\r\n  try {\r\n    const result = await usersService.getUser(username);\r\n    if (result.success && result.data?.role) return result.data.role;\r\n    return null;\r\n  } catch (err) {\r\n    console.error('[BanContext] Error checking user role:', err);\r\n    return null;\r\n  }\r\n};\r\n\r\ntype BanContextType = {\r\n  bans: UserBan[];\r\n  banHistory: BanHistory[];\r\n  appealReviews: AppealReview[];\r\n  ipBans: IPBan[];\r\n\r\n  // Enhanced ban management\r\n  banUser: (\r\n    username: string,\r\n    hours: number | 'permanent',\r\n    reason: BanReason,\r\n    customReason?: string,\r\n    adminUsername?: string,\r\n    reportIds?: string[],\r\n    notes?: string,\r\n    targetUserRole?: 'buyer' | 'seller' | 'admin'\r\n  ) => Promise<boolean>;\r\n  unbanUser: (username: string, adminUsername?: string, reason?: string) => Promise<boolean>;\r\n  isUserBanned: (username: string) => UserBan | null;\r\n  getBanInfo: (username: string) => UserBan | null;\r\n\r\n  // Ban queries\r\n  getActiveBans: () => UserBan[];\r\n  getExpiredBans: () => UserBan[];\r\n  getUserBanHistory: (username: string) => UserBan[];\r\n\r\n  // Appeals\r\n  submitAppeal: (username: string, appealText: string, evidence?: File[]) => Promise<boolean>;\r\n  reviewAppeal: (\r\n    banId: string,\r\n    decision: 'approve' | 'reject' | 'escalate',\r\n    reviewNotes: string,\r\n    adminUsername: string\r\n  ) => boolean;\r\n  approveAppeal: (banId: string, adminUsername: string) => boolean;\r\n  rejectAppeal: (banId: string, adminUsername: string, reason?: string) => boolean;\r\n  escalateAppeal: (banId: string, adminUsername: string, escalationReason: string) => boolean;\r\n\r\n  // IP management\r\n  banUserIP: (username: string, ipAddress: string, reason: string) => boolean;\r\n  isIPBanned: (ipAddress: string) => boolean;\r\n\r\n  // Utilities\r\n  updateExpiredBans: () => void;\r\n  scheduleExpiration: (ban: UserBan) => void;\r\n  clearExpirationTimer: (banId: string) => void;\r\n  getBanStats: () => {\r\n    totalActiveBans: number;\r\n    temporaryBans: number;\r\n    permanentBans: number;\r\n    pendingAppeals: number;\r\n    recentBans24h: number;\r\n    bansByReason: Record<BanReason, number>;\r\n    appealStats: {\r\n      totalAppeals: number;\r\n      pendingAppeals: number;\r\n      approvedAppeals: number;\r\n      rejectedAppeals: number;\r\n    };\r\n  };\r\n\r\n  // Validation\r\n  validateBanInput: (\r\n    username: string,\r\n    hours: number | 'permanent',\r\n    reason: BanReason,\r\n    targetUserRole?: 'buyer' | 'seller' | 'admin'\r\n  ) => Promise<{ valid: boolean; error?: string }>;\r\n\r\n  // Force refresh\r\n  refreshBanData: () => Promise<void>;\r\n};\r\n\r\nconst BanContext = createContext<BanContextType | undefined>(undefined);\r\n\r\n// ================== Validation Schemas ==================\r\nconst banReasonSchema = z.enum([\r\n  'harassment',\r\n  'spam',\r\n  'inappropriate_content',\r\n  'scam',\r\n  'underage',\r\n  'payment_fraud',\r\n  'other',\r\n]);\r\n\r\nconst banDurationSchema = z.union([z.literal('permanent'), z.number().positive().max(8760)]);\r\nconst appealTextSchema = z.string().min(10).max(1000);\r\nconst customReasonSchema = z.string().min(5).max(500);\r\nconst banNotesSchema = z.string().max(1000);\r\n\r\n// Simple IPv4, conservative; adjust if you need IPv6\r\nconst ipAddressSchema = z.string().regex(/^(?:\\d{1,3}\\.){3}\\d{1,3}$/);\r\n\r\n// ---- Conservative mock data detector/scrubber ----\r\nconst isMockString = (val?: string) => {\r\n  if (!val) return false;\r\n  const v = String(val).trim().toLowerCase();\r\n  const patterns = [\r\n    'spammer',\r\n    'scammer',\r\n    'troublemaker',\r\n    'oldbanner',\r\n    'mock',\r\n    'sample',\r\n    'demo',\r\n    'test',\r\n    'lorem',\r\n    'ipsum',\r\n    'john_doe',\r\n    'jane_doe',\r\n  ];\r\n  return patterns.some((p) => v.includes(p));\r\n};\r\n\r\nconst isMockBan = (b: UserBan) => {\r\n  return (\r\n    isMockString(b.username) ||\r\n    isMockString(b.bannedBy) ||\r\n    isMockString(b.customReason) ||\r\n    isMockString(b.notes) ||\r\n    (b.id && (b.id.startsWith('mock_') || b.id.includes('sample') || b.id.includes('test')))\r\n  );\r\n};\r\n\r\nconst isMockHistory = (h: BanHistory) => {\r\n  return (\r\n    isMockString(h.username) ||\r\n    isMockString(h.details) ||\r\n    isMockString(h.adminUsername) ||\r\n    (h.id && (h.id.startsWith('mock_') || h.id.includes('sample') || h.id.includes('test')))\r\n  );\r\n};\r\n\r\nconst scrubMocks = async (\r\n  bans: UserBan[],\r\n  history: BanHistory[],\r\n  reviews: AppealReview[],\r\n  ipBans: IPBan[]\r\n) => {\r\n  const cleanBans = bans.filter((b) => !isMockBan(b));\r\n  const cleanHistory = history.filter((h) => !isMockHistory(h));\r\n  const cleanReviews = reviews.filter(\r\n    (r) =>\r\n      !(\r\n        r.reviewId?.startsWith?.('mock_') ||\r\n        isMockString(r.reviewerAdmin) ||\r\n        isMockString(r.reviewNotes)\r\n      )\r\n  );\r\n  const cleanIPBans = ipBans.filter((ip) => !(ip.ipAddress?.startsWith?.('0.0.0') || isMockString(ip.reason)));\r\n\r\n  const removed = {\r\n    bans: bans.length - cleanBans.length,\r\n    history: history.length - cleanHistory.length,\r\n    reviews: reviews.length - cleanReviews.length,\r\n    ipBans: ipBans.length - cleanIPBans.length,\r\n  };\r\n\r\n  if (removed.bans || removed.history || removed.reviews || removed.ipBans) {\r\n    console.warn('[BanContext] Removed mock/dev data from storage:', removed);\r\n    await storageService.setItem(STORAGE_KEYS.BANS, cleanBans);\r\n    await storageService.setItem(STORAGE_KEYS.HISTORY, cleanHistory);\r\n    await storageService.setItem(STORAGE_KEYS.REVIEWS, cleanReviews);\r\n    await storageService.setItem(STORAGE_KEYS.IP_BANS, cleanIPBans);\r\n  }\r\n\r\n  return { cleanBans, cleanHistory, cleanReviews, cleanIPBans };\r\n};\r\n// --------------------------------------------------\r\n\r\n// Image compression for appeal evidence (defensive checks)\r\nconst compressImage = (file: File): Promise<string> =>\r\n  new Promise((resolve, reject) => {\r\n    try {\r\n      if (!file || !file.type.startsWith('image/')) {\r\n        return reject(new Error('Invalid file type'));\r\n      }\r\n      // Limit ~5MB files to avoid memory issues\r\n      if (typeof file.size === 'number' && file.size > 5 * 1024 * 1024) {\r\n        console.warn('[BanContext] Evidence file is large; compressing aggressively');\r\n      }\r\n\r\n      const reader = new FileReader();\r\n      reader.onload = (event) => {\r\n        const img = new Image();\r\n        img.onload = () => {\r\n          const canvas = document.createElement('canvas');\r\n          const ctx = canvas.getContext('2d');\r\n          const maxDimension = 800;\r\n          let { width, height } = img;\r\n\r\n          if (width > height) {\r\n            if (width > maxDimension) {\r\n              height = (height * maxDimension) / width;\r\n              width = maxDimension;\r\n            }\r\n          } else {\r\n            if (height > maxDimension) {\r\n              width = (width * maxDimension) / height;\r\n              height = maxDimension;\r\n            }\r\n          }\r\n\r\n          canvas.width = width;\r\n          canvas.height = height;\r\n          ctx?.drawImage(img, 0, 0, width, height);\r\n          resolve(canvas.toDataURL('image/jpeg', 0.7));\r\n        };\r\n        img.onerror = () => reject(new Error('Image load failed'));\r\n        img.src = event.target?.result as string;\r\n      };\r\n      reader.onerror = () => reject(new Error('File read failed'));\r\n      reader.readAsDataURL(file);\r\n    } catch (e) {\r\n      reject(e);\r\n    }\r\n  });\r\n\r\n// ================== Provider ==================\r\nexport const BanProvider: React.FC<{ children: ReactNode }> = ({ children }) => {\r\n  const [bans, setBans] = useState<UserBan[]>([]);\r\n  const [banHistory, setBanHistory] = useState<BanHistory[]>([]);\r\n  const [appealReviews, setAppealReviews] = useState<AppealReview[]>([]);\r\n  const [ipBans, setIPBans] = useState<IPBan[]>([]);\r\n  const [isInitialized, setIsInitialized] = useState(false);\r\n\r\n  const { user } = useAuth();\r\n\r\n  // Track active timers to prevent leaks\r\n  const activeTimers = useRef<Map<string, ReturnType<typeof setTimeout>>>(new Map());\r\n\r\n  // Saving guard\r\n  const isSavingRef = useRef(false);\r\n\r\n  // Dev override to allow non-admin actions locally when explicitly enabled\r\n  const canAdminAct = useCallback(\r\n    (action: string): boolean => {\r\n      const devBypass = process.env.NEXT_PUBLIC_ALLOW_LOCAL_BAN === '1';\r\n      if (devBypass && user) {\r\n        console.warn(`[BanContext] Dev override enabled for action: ${action} by ${user.username}`);\r\n        return true;\r\n      }\r\n      return !!(user && isAdmin(user));\r\n    },\r\n    [user]\r\n  );\r\n\r\n  // Force refresh function\r\n  const refreshBanData = useCallback(async () => {\r\n    console.log('[BanContext] Force refreshing ban data...');\r\n    setIsInitialized(false);\r\n    await loadData(true);\r\n  }, []);\r\n\r\n  // Load from storage using service\r\n  const loadData = useCallback(\r\n    async (forceRefresh = false) => {\r\n      if (typeof window === 'undefined') return;\r\n      if (isInitialized && !forceRefresh) return;\r\n\r\n      try {\r\n        console.log('[BanContext] Loading ban data...', { forceRefresh });\r\n\r\n        const storedBans = await storageService.getItem<UserBan[]>(STORAGE_KEYS.BANS, []);\r\n        const storedHistory = await storageService.getItem<BanHistory[]>(STORAGE_KEYS.HISTORY, []);\r\n        const storedAppealReviews = await storageService.getItem<AppealReview[]>(\r\n          STORAGE_KEYS.REVIEWS,\r\n          []\r\n        );\r\n        const storedIPBans = await storageService.getItem<IPBan[]>(STORAGE_KEYS.IP_BANS, []);\r\n\r\n        // Scrub any clear mock remnants\r\n        const { cleanBans, cleanHistory, cleanReviews, cleanIPBans } = await scrubMocks(\r\n          storedBans || [],\r\n          storedHistory || [],\r\n          storedAppealReviews || [],\r\n          storedIPBans || []\r\n        );\r\n\r\n        // Auto-expire any temporary bans already past endTime\r\n        const now = new Date();\r\n        const updatedBans = cleanBans.map((ban) => {\r\n          if (ban.active && ban.banType === 'temporary' && ban.endTime) {\r\n            if (now >= new Date(ban.endTime)) {\r\n              console.log(`[BanContext] Auto-expiring ban for ${ban.username}`);\r\n              return { ...ban, active: false };\r\n            }\r\n          }\r\n          return ban;\r\n        });\r\n\r\n        setBans(updatedBans);\r\n        setBanHistory(cleanHistory);\r\n        setAppealReviews(cleanReviews);\r\n        setIPBans(cleanIPBans);\r\n\r\n        // Persist only if any changed\r\n        const anyExpiredChanged =\r\n          updatedBans.length === cleanBans.length &&\r\n          updatedBans.some((b, i) => b.active !== cleanBans[i]?.active);\r\n        if (anyExpiredChanged) {\r\n          isSavingRef.current = true;\r\n          await storageService.setItem(STORAGE_KEYS.BANS, updatedBans);\r\n          isSavingRef.current = false;\r\n        }\r\n\r\n        // Schedule expiration for active temporary bans\r\n        updatedBans.forEach((ban) => {\r\n          if (ban.active && ban.banType === 'temporary' && ban.endTime) {\r\n            scheduleExpiration(ban);\r\n          }\r\n        });\r\n\r\n        console.log('[BanContext] Data loaded:', {\r\n          activeBans: updatedBans.filter((b) => b.active).length,\r\n          totalBans: updatedBans.length,\r\n        });\r\n\r\n        setIsInitialized(true);\r\n      } catch (error) {\r\n        console.error('[BanContext] Error loading ban data:', error);\r\n        setIsInitialized(true);\r\n      }\r\n    },\r\n    [isInitialized]\r\n  );\r\n\r\n  useEffect(() => {\r\n    loadData();\r\n  }, [loadData]);\r\n\r\n  // Persistors (guarded to avoid loops)\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined' && isInitialized && !isSavingRef.current) {\r\n      isSavingRef.current = true;\r\n      storageService.setItem(STORAGE_KEYS.BANS, bans).finally(() => {\r\n        isSavingRef.current = false;\r\n      });\r\n    }\r\n  }, [bans, isInitialized]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined' && isInitialized && !isSavingRef.current) {\r\n      storageService.setItem(STORAGE_KEYS.HISTORY, banHistory);\r\n    }\r\n  }, [banHistory, isInitialized]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined' && isInitialized && !isSavingRef.current) {\r\n      storageService.setItem(STORAGE_KEYS.REVIEWS, appealReviews);\r\n    }\r\n  }, [appealReviews, isInitialized]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined' && isInitialized && !isSavingRef.current) {\r\n      storageService.setItem(STORAGE_KEYS.IP_BANS, ipBans);\r\n    }\r\n  }, [ipBans, isInitialized]);\r\n\r\n  // Cleanup timers on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      activeTimers.current.forEach((t) => clearTimeout(t));\r\n      activeTimers.current.clear();\r\n    };\r\n  }, []);\r\n\r\n  // ---------- Validation (async because we may look up role) ----------\r\n  const validateBanInput = useCallback(\r\n    async (\r\n      username: string,\r\n      hours: number | 'permanent',\r\n      reason: BanReason,\r\n      targetUserRole?: 'buyer' | 'seller' | 'admin'\r\n    ): Promise<{ valid: boolean; error?: string }> => {\r\n      const sanitized = sanitizeUsername(username);\r\n      if (!sanitized) return { valid: false, error: 'Invalid username format' };\r\n\r\n      // Avoid banning reserved/system accounts\r\n      if (isProtectedUsername(sanitized)) {\r\n        return { valid: false, error: 'This account is protected and cannot be banned' };\r\n      }\r\n\r\n      // Block admins\r\n      if (targetUserRole === 'admin') {\r\n        return { valid: false, error: 'Admin accounts cannot be banned' };\r\n      }\r\n      if (!targetUserRole) {\r\n        const role = await checkUserRole(sanitized);\r\n        if (role === 'admin') return { valid: false, error: 'Admin accounts cannot be banned' };\r\n      }\r\n\r\n      const dur = banDurationSchema.safeParse(hours);\r\n      if (!dur.success) return { valid: false, error: 'Invalid ban duration (max 1 year)' };\r\n\r\n      const reasonOk = banReasonSchema.safeParse(reason);\r\n      if (!reasonOk.success) return { valid: false, error: 'Invalid ban reason' };\r\n\r\n      return { valid: true };\r\n    },\r\n    []\r\n  );\r\n\r\n  // ---------- History helper ----------\r\n  const addBanHistory = useCallback(\r\n    (\r\n      action: BanHistory['action'],\r\n      username: string,\r\n      details: string,\r\n      adminUsername: string,\r\n      metadata?: Record<string, any>\r\n    ) => {\r\n      const historyEntry: BanHistory = {\r\n        id: Date.now().toString() + Math.random().toString(36).slice(2, 11),\r\n        username: sanitizeUsername(username) || username,\r\n        action,\r\n        details: sanitizeStrict(details),\r\n        timestamp: new Date().toISOString(),\r\n        adminUsername: sanitizeUsername(adminUsername) || adminUsername,\r\n        metadata,\r\n      };\r\n      setBanHistory((prev) => [...prev, historyEntry]);\r\n    },\r\n    []\r\n  );\r\n\r\n  // ---------- Unban first (used by scheduler) ----------\r\n  const clearExpirationTimer = useCallback((banId: string) => {\r\n    const t = activeTimers.current.get(banId);\r\n    if (t) {\r\n      clearTimeout(t);\r\n      activeTimers.current.delete(banId);\r\n    }\r\n  }, []);\r\n\r\n  const unbanUser = useCallback(\r\n    async (username: string, adminUsername?: string, reason?: string): Promise<boolean> => {\r\n      // Admin-only\r\n      if (!canAdminAct('unban')) {\r\n        console.warn('[BanContext] Unban blocked: admin privileges required');\r\n        return false;\r\n      }\r\n\r\n      try {\r\n        const cleanUsername = sanitizeUsername(username) || username;\r\n        const cleanAdmin = sanitizeUsername(adminUsername || user?.username || 'system')!;\r\n        const cleanReason = reason ? sanitizeStrict(reason) : 'Ban lifted by admin';\r\n\r\n        const banToUnban = bans.find((b) => b.username === cleanUsername && b.active);\r\n        if (!banToUnban) {\r\n          console.warn('[BanContext] No active ban found for', cleanUsername);\r\n          return false;\r\n        }\r\n\r\n        // stop any scheduled expiration\r\n        clearExpirationTimer(banToUnban.id);\r\n\r\n        const updated = bans.map((b) => (b.id === banToUnban.id ? { ...b, active: false } : b));\r\n\r\n        // Persist first to avoid race\r\n        isSavingRef.current = true;\r\n        await storageService.setItem(STORAGE_KEYS.BANS, updated);\r\n        isSavingRef.current = false;\r\n\r\n        setBans(updated);\r\n        addBanHistory('unbanned', cleanUsername, cleanReason, cleanAdmin);\r\n\r\n        // UI event\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(\r\n            new CustomEvent('banUpdated', {\r\n              detail: { banId: banToUnban.id, username: cleanUsername, action: 'unbanned' },\r\n            })\r\n          );\r\n        }\r\n\r\n        console.log('[BanContext] User unbanned:', cleanUsername);\r\n        return true;\r\n      } catch (err) {\r\n        console.error('[BanContext] Error unbanning user:', err);\r\n        isSavingRef.current = false;\r\n        return false;\r\n      }\r\n    },\r\n    [bans, addBanHistory, clearExpirationTimer, canAdminAct, user?.username]\r\n  );\r\n\r\n  // ---------- Scheduler ----------\r\n  const scheduleExpiration = useCallback(\r\n    (ban: UserBan) => {\r\n      if (ban.banType === 'permanent' || !ban.endTime || !ban.active) return;\r\n\r\n      const ms = new Date(ban.endTime).getTime() - Date.now();\r\n      if (ms <= 0) return;\r\n\r\n      console.log(\r\n        `[BanContext] Scheduling expiration for ${ban.username} in ~${Math.round(\r\n          ms / 60000\r\n        )} minutes`\r\n      );\r\n\r\n      const t = setTimeout(async () => {\r\n        console.log(`[BanContext] Auto-expiring ban for ${ban.username}`);\r\n        await unbanUser(ban.username, 'system', 'Automatic expiration');\r\n\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(\r\n            new CustomEvent('banExpired', { detail: { banId: ban.id, username: ban.username } })\r\n          );\r\n        }\r\n\r\n        activeTimers.current.delete(ban.id);\r\n      }, ms);\r\n\r\n      activeTimers.current.set(ban.id, t);\r\n    },\r\n    [unbanUser]\r\n  );\r\n\r\n  // ---------- Ban user ----------\r\n  const banUser = useCallback(\r\n    async (\r\n      username: string,\r\n      hours: number | 'permanent',\r\n      reason: BanReason,\r\n      customReason?: string,\r\n      adminUsername?: string,\r\n      reportIds: string[] = [],\r\n      notes?: string,\r\n      targetUserRole?: 'buyer' | 'seller' | 'admin'\r\n    ): Promise<boolean> => {\r\n      // Admin-only\r\n      if (!canAdminAct('ban')) {\r\n        console.warn('[BanContext] Ban blocked: admin privileges required');\r\n        if (typeof window !== 'undefined') {\r\n          alert('Only admins can ban users.');\r\n        }\r\n        return false;\r\n      }\r\n\r\n      console.log('[BanContext] Attempting to ban user:', {\r\n        username,\r\n        hours,\r\n        reason,\r\n        targetUserRole,\r\n      });\r\n\r\n      const validation = await validateBanInput(username, hours, reason, targetUserRole);\r\n      if (!validation.valid) {\r\n        console.error('[BanContext] Ban validation failed:', validation.error);\r\n        if (\r\n          validation.error === 'Admin accounts cannot be banned' ||\r\n          validation.error === 'This account is protected and cannot be banned'\r\n        ) {\r\n          if (typeof window !== 'undefined') alert(validation.error);\r\n        }\r\n        return false;\r\n      }\r\n\r\n      // Sanitize inputs\r\n      const cleanUsername = sanitizeUsername(username) || username;\r\n      const cleanAdmin = sanitizeUsername(adminUsername || user?.username || 'system')!;\r\n      const cleanNotes = notes ? sanitizeStrict(notes) : undefined;\r\n\r\n      let cleanCustomReason: string | undefined;\r\n      if (customReason) {\r\n        const cr = customReasonSchema.safeParse(customReason);\r\n        if (!cr.success) {\r\n          console.error('[BanContext] Custom reason too short/long');\r\n          return false;\r\n        }\r\n        cleanCustomReason = sanitizeStrict(cr.data);\r\n      }\r\n\r\n      // Lock to avoid duplicate bans\r\n      const lockKey = `ban_user_${cleanUsername}`;\r\n      const existingLock = await storageService.getItem<any>(lockKey, null);\r\n      if (existingLock) {\r\n        try {\r\n          const age = Date.now() - (existingLock.timestamp || 0);\r\n          if (age < 30_000) {\r\n            console.warn(`[BanContext] Ban already in progress for ${cleanUsername}`);\r\n            return false;\r\n          }\r\n        } catch {\r\n          // ignore bad lock\r\n        }\r\n      }\r\n      await storageService.setItem(lockKey, {\r\n        timestamp: Date.now(),\r\n        adminUser: cleanAdmin,\r\n      });\r\n\r\n      try {\r\n        // Already banned?\r\n        const already = bans.find((b) => b.username === cleanUsername && b.active);\r\n        if (already) {\r\n          console.warn(`[BanContext] ${cleanUsername} is already banned`);\r\n          return false;\r\n        }\r\n\r\n        // Save to DB (best-effort)\r\n        const apiResponse = await banService.createBan({\r\n          username: cleanUsername,\r\n          reason: cleanCustomReason || reason,\r\n          customReason: cleanCustomReason,\r\n          duration: hours,\r\n          notes: cleanNotes,\r\n          relatedReportIds: reportIds,\r\n          bannedBy: cleanAdmin,\r\n        });\r\n        if (!apiResponse.success) {\r\n          console.warn('[BanContext] MongoDB save failed; continuing with local cache', apiResponse.error);\r\n        }\r\n\r\n        const now = new Date();\r\n        const banId = Date.now().toString() + Math.random().toString(36).slice(2, 11);\r\n        const end =\r\n          hours === 'permanent'\r\n            ? undefined\r\n            : new Date(now.getTime() + (hours as number) * 60 * 60 * 1000).toISOString();\r\n\r\n        const newBan: UserBan = {\r\n          id: banId,\r\n          username: cleanUsername,\r\n          banType: hours === 'permanent' ? 'permanent' : 'temporary',\r\n          reason,\r\n          customReason: cleanCustomReason,\r\n          startTime: now.toISOString(),\r\n          endTime: end,\r\n          remainingHours: hours === 'permanent' ? undefined : (hours as number),\r\n          bannedBy: cleanAdmin,\r\n          active: true,\r\n          appealable: true,\r\n          notes: cleanNotes,\r\n          reportIds: reportIds,\r\n          appealStatus: undefined,\r\n        };\r\n\r\n        setBans((prev) => [...prev, newBan]);\r\n\r\n        if (newBan.banType === 'temporary' && newBan.endTime) {\r\n          scheduleExpiration(newBan);\r\n        }\r\n\r\n        const durationText = hours === 'permanent' ? 'permanently' : `for ${hours} hours`;\r\n        addBanHistory(\r\n          'banned',\r\n          cleanUsername,\r\n          `Banned ${durationText} for ${reason}${cleanCustomReason ? `: ${cleanCustomReason}` : ''}`,\r\n          cleanAdmin,\r\n          { banId, mongoSaved: apiResponse.success }\r\n        );\r\n\r\n        console.log('[BanContext] Ban created successfully', { mongoSaved: apiResponse.success });\r\n        return true;\r\n      } catch (error) {\r\n        console.error('[BanContext] Error banning user:', error);\r\n        return false;\r\n      } finally {\r\n        await storageService.removeItem(lockKey);\r\n      }\r\n    },\r\n    [bans, addBanHistory, scheduleExpiration, validateBanInput, canAdminAct, user?.username]\r\n  );\r\n\r\n  // ---------- Appeals ----------\r\n  const submitAppeal = useCallback(\r\n    async (username: string, appealText: string, evidence?: File[]): Promise<boolean> => {\r\n      try {\r\n        // Allow the banned user themselves OR an admin acting on their behalf\r\n        const requester = user?.username;\r\n        const isSelf = requester && sanitizeUsername(requester) === sanitizeUsername(username);\r\n        if (!isSelf && !canAdminAct('submitAppeal')) {\r\n          console.warn('[BanContext] Appeal submission blocked: not the user or admin');\r\n          return false;\r\n        }\r\n\r\n        const cleanUsername = sanitizeUsername(username) || username;\r\n        const appealValidation = appealTextSchema.safeParse(appealText);\r\n        if (!appealValidation.success) {\r\n          console.error('[BanContext] Invalid appeal text:', appealValidation.error);\r\n          return false;\r\n        }\r\n        const cleanAppealText = sanitizeStrict(appealValidation.data);\r\n\r\n        let appealEvidence: string[] = [];\r\n        if (evidence && evidence.length > 0) {\r\n          try {\r\n            // Only first 3 images\r\n            const trimmed = evidence.slice(0, 3);\r\n            appealEvidence = await Promise.all(trimmed.map((f) => compressImage(f)));\r\n          } catch (err) {\r\n            console.error('[BanContext] Evidence processing failed:', err);\r\n          }\r\n        }\r\n\r\n        setBans((prev) =>\r\n          prev.map((ban) =>\r\n            ban.username === cleanUsername && ban.active && ban.appealable\r\n              ? {\r\n                  ...ban,\r\n                  appealSubmitted: true,\r\n                  appealText: cleanAppealText,\r\n                  appealDate: new Date().toISOString(),\r\n                  appealStatus: 'pending' as AppealStatus,\r\n                  appealEvidence,\r\n                }\r\n              : ban\r\n          )\r\n        );\r\n\r\n        addBanHistory(\r\n          'appeal_submitted',\r\n          cleanUsername,\r\n          `Appeal submitted: \"${cleanAppealText.substring(0, 100)}${\r\n            cleanAppealText.length > 100 ? '...' : ''\r\n          }\"`,\r\n          cleanUsername,\r\n          { evidenceCount: appealEvidence.length }\r\n        );\r\n\r\n        return true;\r\n      } catch (err) {\r\n        console.error('[BanContext] Error submitting appeal:', err);\r\n        return false;\r\n      }\r\n    },\r\n    [addBanHistory, canAdminAct, user?.username]\r\n  );\r\n\r\n  const reviewAppeal = useCallback(\r\n    (\r\n      banId: string,\r\n      decision: 'approve' | 'reject' | 'escalate',\r\n      reviewNotes: string,\r\n      adminUsername: string\r\n    ): boolean => {\r\n      // Admin-only\r\n      if (!canAdminAct('reviewAppeal')) {\r\n        console.warn('[BanContext] Review appeal blocked: admin privileges required');\r\n        return false;\r\n      }\r\n\r\n      try {\r\n        const cleanNotes = sanitizeStrict(reviewNotes);\r\n        const cleanAdmin = sanitizeUsername(adminUsername || user?.username || 'system')!;\r\n\r\n        const review: AppealReview = {\r\n          reviewId: Date.now().toString() + Math.random().toString(36).slice(2, 11),\r\n          banId,\r\n          reviewerAdmin: cleanAdmin,\r\n          reviewNotes: cleanNotes,\r\n          decision,\r\n          reviewDate: new Date().toISOString(),\r\n          escalationReason: decision === 'escalate' ? cleanNotes : undefined,\r\n        };\r\n\r\n        setAppealReviews((prev) => [...prev, review]);\r\n\r\n        const ban = bans.find((b) => b.id === banId);\r\n        if (!ban) return false;\r\n\r\n        if (decision === 'approve') return approveAppeal(banId, cleanAdmin);\r\n        if (decision === 'reject') return rejectAppeal(banId, cleanAdmin, cleanNotes);\r\n        if (decision === 'escalate') return escalateAppeal(banId, cleanAdmin, cleanNotes);\r\n\r\n        return true;\r\n      } catch (err) {\r\n        console.error('[BanContext] Error reviewing appeal:', err);\r\n        return false;\r\n      }\r\n    },\r\n    [bans, canAdminAct, user?.username]\r\n  );\r\n\r\n  const approveAppeal = useCallback(\r\n    (banId: string, adminUsername: string): boolean => {\r\n      // Admin-only\r\n      if (!canAdminAct('approveAppeal')) return false;\r\n\r\n      try {\r\n        const ban = bans.find((b) => b.id === banId);\r\n        if (!ban) return false;\r\n\r\n        setBans((prev) =>\r\n          prev.map((b) => (b.id === banId ? { ...b, active: false, appealStatus: 'approved' } : b))\r\n        );\r\n\r\n        clearExpirationTimer(banId);\r\n        addBanHistory('appeal_approved', ban.username, 'Appeal approved and ban lifted', adminUsername);\r\n        return true;\r\n      } catch (err) {\r\n        console.error('[BanContext] Error approving appeal:', err);\r\n        return false;\r\n      }\r\n    },\r\n    [bans, addBanHistory, clearExpirationTimer, canAdminAct]\r\n  );\r\n\r\n  const rejectAppeal = useCallback(\r\n    (banId: string, adminUsername: string, reason?: string): boolean => {\r\n      // Admin-only\r\n      if (!canAdminAct('rejectAppeal')) return false;\r\n\r\n      try {\r\n        const ban = bans.find((b) => b.id === banId);\r\n        if (!ban) return false;\r\n\r\n        setBans((prev) =>\r\n          prev.map((b) =>\r\n            b.id === banId\r\n              ? {\r\n                  ...b,\r\n                  appealSubmitted: false,\r\n                  appealText: undefined,\r\n                  appealable: false,\r\n                  appealStatus: 'rejected',\r\n                }\r\n              : b\r\n          )\r\n        );\r\n\r\n        addBanHistory('appeal_rejected', ban.username, reason || 'Appeal rejected', adminUsername);\r\n        return true;\r\n      } catch (err) {\r\n        console.error('[BanContext] Error rejecting appeal:', err);\r\n        return false;\r\n      }\r\n    },\r\n    [bans, addBanHistory, canAdminAct]\r\n  );\r\n\r\n  const escalateAppeal = useCallback(\r\n    (banId: string, adminUsername: string, escalationReason: string): boolean => {\r\n      // Admin-only\r\n      if (!canAdminAct('escalateAppeal')) return false;\r\n\r\n      try {\r\n        const ban = bans.find((b) => b.id === banId);\r\n        if (!ban) return false;\r\n\r\n        setBans((prev) =>\r\n          prev.map((b) => (b.id === banId ? { ...b, appealStatus: 'escalated' } : b))\r\n        );\r\n\r\n        addBanHistory(\r\n          'appeal_escalated',\r\n          ban.username,\r\n          `Appeal escalated: ${sanitizeStrict(escalationReason)}`,\r\n          adminUsername\r\n        );\r\n        return true;\r\n      } catch (err) {\r\n        console.error('[BanContext] Error escalating appeal:', err);\r\n        return false;\r\n      }\r\n    },\r\n    [bans, addBanHistory, canAdminAct]\r\n  );\r\n\r\n  // ---------- IP banning ----------\r\n  const banUserIP = useCallback(\r\n    (username: string, ipAddress: string, reason: string): boolean => {\r\n      // Admin-only\r\n      if (!canAdminAct('banUserIP')) {\r\n        console.warn('[BanContext] IP ban blocked: admin privileges required');\r\n        return false;\r\n      }\r\n\r\n      try {\r\n        const cleanUsername = sanitizeUsername(username) || username;\r\n        const ipValidation = ipAddressSchema.safeParse(ipAddress);\r\n        if (!ipValidation.success) {\r\n          console.error('[BanContext] Invalid IP address format');\r\n          return false;\r\n        }\r\n        const cleanReason = sanitizeStrict(reason);\r\n\r\n        const ipBan: IPBan = {\r\n          ipAddress: ipValidation.data,\r\n          bannedUsernames: [cleanUsername],\r\n          banDate: new Date().toISOString(),\r\n          expiryDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days\r\n          reason: cleanReason,\r\n        };\r\n\r\n        setIPBans((prev) => {\r\n          const existing = prev.find((b) => b.ipAddress === ipValidation.data);\r\n          if (existing) {\r\n            return prev.map((b) =>\r\n              b.ipAddress === ipValidation.data\r\n                ? { ...b, bannedUsernames: [...new Set([...b.bannedUsernames, cleanUsername])] }\r\n                : b\r\n            );\r\n          }\r\n          return [...prev, ipBan];\r\n        });\r\n\r\n        return true;\r\n      } catch (err) {\r\n        console.error('[BanContext] Error banning IP:', err);\r\n        return false;\r\n      }\r\n    },\r\n    [canAdminAct]\r\n  );\r\n\r\n  const isIPBanned = useCallback(\r\n    (ipAddress: string): boolean => {\r\n      const now = new Date();\r\n      return ipBans.some(\r\n        (ban) => ban.ipAddress === ipAddress && (!ban.expiryDate || new Date(ban.expiryDate) > now)\r\n      );\r\n    },\r\n    [ipBans]\r\n  );\r\n\r\n  // ---------- Queries ----------\r\n  const isUserBanned = useCallback(\r\n    (username: string): UserBan | null => {\r\n      const cleanUsername = sanitizeUsername(username) || username;\r\n      const activeBan = bans.find((b) => b.username === cleanUsername && b.active);\r\n      if (!activeBan) return null;\r\n\r\n      if (activeBan.banType === 'temporary' && activeBan.endTime) {\r\n        const now = new Date();\r\n        const end = new Date(activeBan.endTime);\r\n        if (now >= end) {\r\n          // Auto unban expired\r\n          unbanUser(cleanUsername, 'system', 'Temporary ban expired');\r\n          return null;\r\n        }\r\n        const remainingMs = end.getTime() - now.getTime();\r\n        activeBan.remainingHours = Math.max(0, Math.ceil(remainingMs / 3_600_000));\r\n      }\r\n\r\n      return activeBan;\r\n    },\r\n    [bans, unbanUser]\r\n  );\r\n\r\n  const getBanInfo = useCallback((username: string): UserBan | null => {\r\n    return isUserBanned(username);\r\n  }, [isUserBanned]);\r\n\r\n  const getActiveBans = useCallback((): UserBan[] => {\r\n    const active = bans.filter((b) => b.active).map((b) => {\r\n      if (b.banType === 'temporary' && b.endTime) {\r\n        const now = new Date();\r\n        const end = new Date(b.endTime);\r\n        const remainingMs = end.getTime() - now.getTime();\r\n        b.remainingHours = Math.max(0, Math.ceil(remainingMs / 3_600_000));\r\n      }\r\n      return b;\r\n    });\r\n\r\n    console.log('[BanContext] Getting active bans:', {\r\n      total: bans.length,\r\n      active: active.length,\r\n      usernames: active.map((b) => b.username),\r\n    });\r\n\r\n    return active;\r\n  }, [bans]);\r\n\r\n  const getExpiredBans = useCallback((): UserBan[] => {\r\n    return bans.filter((b) => !b.active);\r\n  }, [bans]);\r\n\r\n  const getUserBanHistory = useCallback(\r\n    (username: string): UserBan[] => bans.filter((b) => b.username === username),\r\n    [bans]\r\n  );\r\n\r\n  const updateExpiredBans = useCallback(() => {\r\n    const now = new Date();\r\n    let changed = false;\r\n\r\n    setBans((prev) =>\r\n      prev.map((b) => {\r\n        if (b.active && b.banType === 'temporary' && b.endTime) {\r\n          if (now >= new Date(b.endTime)) {\r\n            clearExpirationTimer(b.id);\r\n            changed = true;\r\n            addBanHistory('unbanned', b.username, 'Temporary ban expired automatically', 'system');\r\n            return { ...b, active: false };\r\n          }\r\n        }\r\n        return b;\r\n      })\r\n    );\r\n\r\n    if (changed) console.log('[BanContext] Expired bans updated');\r\n  }, [addBanHistory, clearExpirationTimer]);\r\n\r\n  const getBanStats = useCallback(() => {\r\n    const active = getActiveBans();\r\n    const now = new Date();\r\n    const hours24Ago = new Date(now.getTime() - 24 * 60 * 60 * 1000);\r\n\r\n    const bansByReason: Record<BanReason, number> = {\r\n      harassment: 0,\r\n      spam: 0,\r\n      inappropriate_content: 0,\r\n      scam: 0,\r\n      underage: 0,\r\n      payment_fraud: 0,\r\n      other: 0,\r\n    };\r\n    active.forEach((b) => {\r\n      bansByReason[b.reason]++;\r\n    });\r\n\r\n    const allAppeals = bans.filter((b) => b.appealSubmitted);\r\n    const appealStats = {\r\n      totalAppeals: allAppeals.length,\r\n      pendingAppeals: allAppeals.filter((b) => b.appealStatus === 'pending').length,\r\n      approvedAppeals: banHistory.filter((h) => h.action === 'appeal_approved').length,\r\n      rejectedAppeals: banHistory.filter((h) => h.action === 'appeal_rejected').length,\r\n    };\r\n\r\n    const stats = {\r\n      totalActiveBans: active.length,\r\n      temporaryBans: active.filter((b) => b.banType === 'temporary').length,\r\n      permanentBans: active.filter((b) => b.banType === 'permanent').length,\r\n      pendingAppeals: active.filter((b) => b.appealSubmitted && b.appealStatus === 'pending').length,\r\n      recentBans24h: bans.filter((b) => new Date(b.startTime) >= hours24Ago).length,\r\n      bansByReason,\r\n      appealStats,\r\n    };\r\n\r\n    console.log('[BanContext] Ban stats:', stats);\r\n    return stats;\r\n  }, [getActiveBans, bans, banHistory]);\r\n\r\n  return (\r\n    <BanContext.Provider\r\n      value={{\r\n        bans,\r\n        banHistory,\r\n        appealReviews,\r\n        ipBans,\r\n        banUser,\r\n        unbanUser,\r\n        isUserBanned,\r\n        getBanInfo,\r\n        getActiveBans,\r\n        getExpiredBans,\r\n        getUserBanHistory,\r\n        submitAppeal,\r\n        reviewAppeal,\r\n        approveAppeal,\r\n        rejectAppeal,\r\n        escalateAppeal,\r\n        banUserIP,\r\n        isIPBanned,\r\n        updateExpiredBans,\r\n        scheduleExpiration,\r\n        clearExpirationTimer,\r\n        getBanStats,\r\n        validateBanInput,\r\n        refreshBanData,\r\n      }}\r\n    >\r\n      {children}\r\n    </BanContext.Provider>\r\n  );\r\n};\r\n\r\nexport const useBans = () => {\r\n  const ctx = useContext(BanContext);\r\n  if (!ctx) {\r\n    throw new Error('useBans must be used within a BanProvider');\r\n  }\r\n  return ctx;\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2169, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/WebSocketContext.tsx"],"sourcesContent":["// src/context/WebSocketContext.tsx\r\n\r\n'use client';\r\n\r\nimport React, { createContext, useContext, useEffect, useState, useCallback, useRef } from 'react';\r\nimport { useAuth, getGlobalAuthToken } from '@/context/AuthContext';\r\nimport { authService } from '@/services';\r\nimport { \r\n  createWebSocketService, \r\n  getWebSocketService, \r\n  destroyWebSocketService \r\n} from '@/services/websocket.service';\r\nimport { \r\n  WebSocketEvent, \r\n  WebSocketState, \r\n  WebSocketHandler,\r\n  TypingData,\r\n  OnlineStatusData,\r\n  RealtimeNotification\r\n} from '@/types/websocket';\r\nimport { apiConfig, websocketConfig } from '@/config/environment';\r\n\r\ninterface WebSocketContextType {\r\n  // Connection state\r\n  isConnected: boolean;\r\n  connectionState: WebSocketState;\r\n  \r\n  // Core methods\r\n  connect: () => void;\r\n  disconnect: () => void;\r\n  \r\n  // Event subscription\r\n  subscribe: <T = any>(event: WebSocketEvent | string, handler: WebSocketHandler<T>) => () => void;\r\n  \r\n  // Sending events\r\n  sendMessage: (event: WebSocketEvent | string, data: any) => void;\r\n  \r\n  // Typing indicators\r\n  sendTyping: (conversationId: string, isTyping: boolean) => void;\r\n  typingUsers: Map<string, TypingData>;\r\n  \r\n  // Online status\r\n  onlineUsers: Set<string>;\r\n  updateOnlineStatus: (isOnline: boolean) => void;\r\n  \r\n  // Notifications\r\n  notifications: RealtimeNotification[];\r\n  markNotificationRead: (notificationId: string) => void;\r\n  clearNotifications: () => void;\r\n}\r\n\r\nconst WebSocketContext = createContext<WebSocketContextType | undefined>(undefined);\r\n\r\nexport const useWebSocket = () => {\r\n  const context = useContext(WebSocketContext);\r\n  // Return null instead of throwing to allow components to handle missing context gracefully\r\n  return context || null;\r\n};\r\n\r\nexport const WebSocketProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n  const { user, getAuthToken } = useAuth();\r\n  const [isConnected, setIsConnected] = useState(false);\r\n  const [connectionState, setConnectionState] = useState<WebSocketState>(WebSocketState.DISCONNECTED);\r\n  const [typingUsers, setTypingUsers] = useState<Map<string, TypingData>>(new Map());\r\n  const [onlineUsers, setOnlineUsers] = useState<Set<string>>(new Set());\r\n  const [notifications, setNotifications] = useState<RealtimeNotification[]>([]);\r\n  \r\n  const typingTimers = useRef<Map<string, NodeJS.Timeout>>(new Map());\r\n  const wsService = useRef(getWebSocketService());\r\n  const currentToken = useRef<string | null>(null);\r\n  const hasInitialized = useRef(false);\r\n  const pendingSubscriptions = useRef<Array<{ event: string; handler: WebSocketHandler }>>([]); // Store pending subscriptions\r\n\r\n  // Listen for auth token events from AuthContext\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n\r\n    const handleTokenUpdate = (event: CustomEvent) => {\r\n      const newToken = event.detail?.token;\r\n      console.log('[WebSocket] Auth token updated:', !!newToken);\r\n      \r\n      if (newToken !== currentToken.current) {\r\n        currentToken.current = newToken;\r\n        \r\n        // Reconnect with new token if we have a user and WebSocket is enabled\r\n        if (user && websocketConfig.enabled && wsService.current) {\r\n          console.log('[WebSocket] Reconnecting with new token...');\r\n          wsService.current.disconnect();\r\n          setTimeout(() => {\r\n            initializeWebSocket();\r\n          }, 1000);\r\n        }\r\n      }\r\n    };\r\n\r\n    const handleTokenClear = () => {\r\n      console.log('[WebSocket] Auth token cleared');\r\n      currentToken.current = null;\r\n      \r\n      // Disconnect WebSocket when token is cleared\r\n      if (wsService.current) {\r\n        wsService.current.disconnect();\r\n      }\r\n      \r\n      setIsConnected(false);\r\n      setConnectionState(WebSocketState.DISCONNECTED);\r\n      setOnlineUsers(new Set());\r\n      setTypingUsers(new Map());\r\n    };\r\n\r\n    // Listen for auth events from AuthContext\r\n    window.addEventListener('auth-token-updated', handleTokenUpdate as EventListener);\r\n    window.addEventListener('auth-token-cleared', handleTokenClear);\r\n\r\n    return () => {\r\n      window.removeEventListener('auth-token-updated', handleTokenUpdate as EventListener);\r\n      window.removeEventListener('auth-token-cleared', handleTokenClear);\r\n    };\r\n  }, [user]);\r\n\r\n  // Improved WebSocket initialization\r\n  const initializeWebSocket = useCallback(async (): Promise<(() => void) | undefined> => {\r\n    if (!user || !websocketConfig.enabled) {\r\n      console.log('[WebSocket] User not available or WebSocket disabled');\r\n      return undefined;\r\n    }\r\n\r\n    // Try multiple ways to get the auth token\r\n    let token = currentToken.current;\r\n    \r\n    if (!token) {\r\n      token = getAuthToken();\r\n    }\r\n    \r\n    if (!token && typeof window !== 'undefined') {\r\n      token = getGlobalAuthToken();\r\n    }\r\n    \r\n    if (!token) {\r\n      console.log('[WebSocket] No auth token available');\r\n      return undefined;\r\n    }\r\n\r\n    console.log('[WebSocket] Initializing with token:', !!token);\r\n    currentToken.current = token;\r\n    \r\n    try {\r\n      // Use WebSocket URL from config\r\n      const wsUrl = websocketConfig.url || apiConfig.baseUrl.replace('/api', '').replace('http', 'ws');\r\n      \r\n      // Create WebSocket service if it doesn't exist\r\n      if (!wsService.current) {\r\n        wsService.current = createWebSocketService({\r\n          url: wsUrl,\r\n          auth: { token },\r\n          autoConnect: true,\r\n          reconnect: true,\r\n          reconnectAttempts: 5,\r\n          reconnectDelay: 3000\r\n        });\r\n      }\r\n\r\n      // Subscribe to connection events\r\n      const unsubConnect = wsService.current.on(WebSocketEvent.CONNECT, () => {\r\n        setIsConnected(true);\r\n        setConnectionState(WebSocketState.CONNECTED);\r\n        console.log('[WebSocket] Connected');\r\n        \r\n        // Process any pending subscriptions\r\n        if (pendingSubscriptions.current.length > 0) {\r\n          console.log('[WebSocket] Processing', pendingSubscriptions.current.length, 'pending subscriptions');\r\n          const pending = [...pendingSubscriptions.current];\r\n          pendingSubscriptions.current = [];\r\n          \r\n          pending.forEach(({ event, handler }) => {\r\n            if (wsService.current) {\r\n              wsService.current.on(event as WebSocketEvent, handler);\r\n            }\r\n          });\r\n        }\r\n        \r\n        // Send initial online status\r\n        updateOnlineStatus(true);\r\n      });\r\n\r\n      const unsubDisconnect = wsService.current.on(WebSocketEvent.DISCONNECT, () => {\r\n        setIsConnected(false);\r\n        setConnectionState(WebSocketState.DISCONNECTED);\r\n        setOnlineUsers(new Set());\r\n        setTypingUsers(new Map());\r\n        console.log('[WebSocket] Disconnected');\r\n      });\r\n\r\n      const unsubError = wsService.current.on(WebSocketEvent.ERROR, (error) => {\r\n        setConnectionState(WebSocketState.ERROR);\r\n        console.error('[WebSocket] Error:', error);\r\n      });\r\n\r\n      // Subscribe to app events\r\n      const unsubTyping = wsService.current.on<TypingData>(\r\n        WebSocketEvent.MESSAGE_TYPING, \r\n        handleTypingUpdate\r\n      );\r\n\r\n      const unsubUserOnline = wsService.current.on<OnlineStatusData>(\r\n        WebSocketEvent.USER_ONLINE,\r\n        handleUserOnline\r\n      );\r\n\r\n      const unsubUserOffline = wsService.current.on<OnlineStatusData>(\r\n        WebSocketEvent.USER_OFFLINE,\r\n        handleUserOffline\r\n      );\r\n\r\n      const unsubNotification = wsService.current.on<RealtimeNotification>(\r\n        WebSocketEvent.NOTIFICATION_NEW,\r\n        handleNewNotification\r\n      );\r\n\r\n      // Subscribe to message events\r\n      const unsubMessageNew = wsService.current.on('message:new' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] New message received:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('message:new', { detail: data }));\r\n        }\r\n      });\r\n\r\n      const unsubMessageRead = wsService.current.on('message:read' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] Message read event:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('message:read', { detail: data }));\r\n        }\r\n      });\r\n\r\n      // Subscribe to order events\r\n      const unsubOrderCreated = wsService.current.on('order:created' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] Order created event received:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('order:created', { detail: data }));\r\n        }\r\n      });\r\n\r\n      const unsubOrderNew = wsService.current.on('order:new' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] Order new event received:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('order:new', { detail: data }));\r\n        }\r\n      });\r\n\r\n      // Subscribe to auction events\r\n      const unsubAuctionWon = wsService.current.on('auction:won' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] Auction won event received:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('auction:won', { detail: data }));\r\n        }\r\n      });\r\n\r\n      const unsubAuctionEnded = wsService.current.on('auction:ended' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] Auction ended event received:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('auction:ended', { detail: data }));\r\n        }\r\n      });\r\n\r\n      const unsubListingSold = wsService.current.on('listing:sold' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] Listing sold event received:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('listing:sold', { detail: data }));\r\n        }\r\n      });\r\n\r\n      // Subscribe to wallet balance updates\r\n      const unsubWalletUpdate = wsService.current.on('wallet:balance_update' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] Wallet balance update:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('wallet:balance_update', { detail: data }));\r\n        }\r\n      });\r\n\r\n      const unsubWalletTransaction = wsService.current.on('wallet:transaction' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] Wallet transaction:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('wallet:transaction', { detail: data }));\r\n        }\r\n      });\r\n\r\n      // Subscribe to notification events\r\n      const unsubNotificationNew = wsService.current.on('notification:new' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] New notification:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('notification:new', { detail: data }));\r\n        }\r\n      });\r\n\r\n      const unsubNotificationCleared = wsService.current.on('notification:cleared' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] Notification cleared:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('notification:cleared', { detail: data }));\r\n        }\r\n      });\r\n\r\n      const unsubNotificationAllCleared = wsService.current.on('notification:all_cleared' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] All notifications cleared:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('notification:all_cleared', { detail: data }));\r\n        }\r\n      });\r\n\r\n      const unsubNotificationRestored = wsService.current.on('notification:restored' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] Notification restored:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('notification:restored', { detail: data }));\r\n        }\r\n      });\r\n\r\n      const unsubNotificationDeleted = wsService.current.on('notification:deleted' as WebSocketEvent, (data: any) => {\r\n        console.log('[WebSocket Context] Notification deleted:', data);\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('notification:deleted', { detail: data }));\r\n        }\r\n      });\r\n\r\n      // Connect\r\n      wsService.current.connect();\r\n\r\n      // Store cleanup functions\r\n      return () => {\r\n        unsubConnect();\r\n        unsubDisconnect();\r\n        unsubError();\r\n        unsubTyping();\r\n        unsubUserOnline();\r\n        unsubUserOffline();\r\n        unsubNotification();\r\n        unsubMessageNew();\r\n        unsubMessageRead();\r\n        unsubOrderCreated();\r\n        unsubOrderNew();\r\n        unsubAuctionWon();\r\n        unsubAuctionEnded();\r\n        unsubListingSold();\r\n        unsubWalletUpdate();\r\n        unsubWalletTransaction();\r\n        unsubNotificationNew();\r\n        unsubNotificationCleared();\r\n        unsubNotificationAllCleared();\r\n        unsubNotificationRestored();\r\n        unsubNotificationDeleted();\r\n      };\r\n    } catch (error) {\r\n      console.error('[WebSocket] Initialization error:', error);\r\n      setConnectionState(WebSocketState.ERROR);\r\n      return undefined;\r\n    }\r\n  }, [user, getAuthToken]);\r\n\r\n  // Initialize WebSocket connection when user is available\r\n  useEffect(() => {\r\n    let cleanup: (() => void) | undefined;\r\n\r\n    const init = async () => {\r\n      if (!hasInitialized.current && user && websocketConfig.enabled) {\r\n        hasInitialized.current = true;\r\n        cleanup = await initializeWebSocket();\r\n      }\r\n    };\r\n\r\n    if (user && websocketConfig.enabled) {\r\n      init();\r\n    } else if (wsService.current?.isConnected()) {\r\n      // Disconnect if no user or WebSocket disabled\r\n      wsService.current.disconnect();\r\n      hasInitialized.current = false;\r\n    }\r\n\r\n    return () => {\r\n      cleanup?.();\r\n      hasInitialized.current = false;\r\n    };\r\n  }, [user, initializeWebSocket]);\r\n\r\n  // Cleanup on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      typingTimers.current.forEach(timer => clearTimeout(timer));\r\n      if (wsService.current?.isConnected()) {\r\n        wsService.current.disconnect();\r\n      }\r\n      destroyWebSocketService();\r\n    };\r\n  }, []);\r\n\r\n  // Handle typing updates\r\n  const handleTypingUpdate = useCallback((data: TypingData) => {\r\n    const key = `${data.conversationId}-${data.userId}`;\r\n    \r\n    if (data.isTyping) {\r\n      setTypingUsers(prev => new Map(prev).set(key, data));\r\n      \r\n      // Clear existing timer\r\n      const existingTimer = typingTimers.current.get(key);\r\n      if (existingTimer) {\r\n        clearTimeout(existingTimer);\r\n      }\r\n      \r\n      // Set new timer to remove typing indicator after 3 seconds\r\n      const timer = setTimeout(() => {\r\n        setTypingUsers(prev => {\r\n          const newMap = new Map(prev);\r\n          newMap.delete(key);\r\n          return newMap;\r\n        });\r\n        typingTimers.current.delete(key);\r\n      }, 3000);\r\n      \r\n      typingTimers.current.set(key, timer);\r\n    } else {\r\n      setTypingUsers(prev => {\r\n        const newMap = new Map(prev);\r\n        newMap.delete(key);\r\n        return newMap;\r\n      });\r\n      \r\n      const timer = typingTimers.current.get(key);\r\n      if (timer) {\r\n        clearTimeout(timer);\r\n        typingTimers.current.delete(key);\r\n      }\r\n    }\r\n  }, []);\r\n\r\n  // Handle user online\r\n  const handleUserOnline = useCallback((data: OnlineStatusData) => {\r\n    setOnlineUsers(prev => new Set(prev).add(data.userId));\r\n  }, []);\r\n\r\n  // Handle user offline\r\n  const handleUserOffline = useCallback((data: OnlineStatusData) => {\r\n    setOnlineUsers(prev => {\r\n      const newSet = new Set(prev);\r\n      newSet.delete(data.userId);\r\n      return newSet;\r\n    });\r\n  }, []);\r\n\r\n  // Handle new notification\r\n  const handleNewNotification = useCallback((notification: RealtimeNotification) => {\r\n    setNotifications(prev => [notification, ...prev].slice(0, 50)); // Keep last 50\r\n  }, []);\r\n\r\n  // Public methods\r\n  const connect = useCallback(() => {\r\n    if (!currentToken.current) {\r\n      currentToken.current = getAuthToken() || getGlobalAuthToken();\r\n    }\r\n    wsService.current?.connect();\r\n  }, [getAuthToken]);\r\n\r\n  const disconnect = useCallback(() => {\r\n    wsService.current?.disconnect();\r\n  }, []);\r\n\r\n  // FIXED: Subscribe method that queues subscriptions if service not ready\r\n  const subscribe = useCallback(<T = any>(\r\n    event: WebSocketEvent | string, \r\n    handler: WebSocketHandler<T>\r\n  ): (() => void) => {\r\n    if (!wsService.current) {\r\n      console.log('[WebSocket] Service not initialized - queueing subscription for:', event);\r\n      // Queue the subscription for later\r\n      pendingSubscriptions.current.push({ event, handler });\r\n      \r\n      // Return a cleanup function that removes from pending if not yet processed\r\n      return () => {\r\n        const index = pendingSubscriptions.current.findIndex(\r\n          sub => sub.event === event && sub.handler === handler\r\n        );\r\n        if (index !== -1) {\r\n          pendingSubscriptions.current.splice(index, 1);\r\n        }\r\n      };\r\n    }\r\n    \r\n    // Service is ready, subscribe immediately\r\n    return wsService.current.on<T>(event as WebSocketEvent, handler);\r\n  }, []);\r\n\r\n  const sendMessage = useCallback((event: WebSocketEvent | string, data: any) => {\r\n    if (!wsService.current?.isConnected()) {\r\n      console.warn('[WebSocket] Not connected, cannot send message');\r\n      return;\r\n    }\r\n    wsService.current.send(event, data);\r\n  }, []);\r\n\r\n  const sendTyping = useCallback((conversationId: string, isTyping: boolean) => {\r\n    if (!user) return;\r\n    \r\n    sendMessage(WebSocketEvent.MESSAGE_TYPING, {\r\n      userId: user.id,\r\n      username: user.username,\r\n      conversationId,\r\n      isTyping\r\n    });\r\n  }, [user, sendMessage]);\r\n\r\n  const updateOnlineStatus = useCallback((isOnline: boolean) => {\r\n    if (!user) return;\r\n    \r\n    sendMessage(\r\n      isOnline ? WebSocketEvent.USER_ONLINE : WebSocketEvent.USER_OFFLINE,\r\n      { userId: user.id, isOnline }\r\n    );\r\n  }, [user, sendMessage]);\r\n\r\n  const markNotificationRead = useCallback((notificationId: string) => {\r\n    setNotifications(prev => \r\n      prev.map(n => n.id === notificationId ? { ...n, read: true } : n)\r\n    );\r\n    sendMessage(WebSocketEvent.NOTIFICATION_READ, { notificationId });\r\n  }, [sendMessage]);\r\n\r\n  const clearNotifications = useCallback(() => {\r\n    setNotifications([]);\r\n  }, []);\r\n\r\n  const value: WebSocketContextType = {\r\n    isConnected,\r\n    connectionState,\r\n    connect,\r\n    disconnect,\r\n    subscribe,\r\n    sendMessage,\r\n    sendTyping,\r\n    typingUsers,\r\n    onlineUsers,\r\n    updateOnlineStatus,\r\n    notifications,\r\n    markNotificationRead,\r\n    clearNotifications\r\n  };\r\n\r\n  return (\r\n    <WebSocketContext.Provider value={value}>\r\n      {children}\r\n    </WebSocketContext.Provider>\r\n  );\r\n};"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2793, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/WalletContext.tsx"],"sourcesContent":["// src/context/WalletContext.tsx\r\n\"use client\";\r\n\r\nimport {\r\n  createContext,\r\n  useContext,\r\n  useState,\r\n  useEffect,\r\n  ReactNode,\r\n  useCallback,\r\n  useRef,\r\n} from \"react\";\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { sanitizeStrict, sanitizeUsername, sanitizeCurrency } from '@/utils/security/sanitization';\r\nimport { getRateLimiter, RATE_LIMITS } from '@/utils/security/rate-limiter';\r\nimport { financialSchemas } from '@/utils/validation/schemas';\r\nimport { z } from 'zod';\r\nimport { useWebSocket } from '@/context/WebSocketContext';\r\nimport { WebSocketEvent } from '@/types/websocket';\r\nimport { useAuth } from '@/context/AuthContext';\r\nimport { securityService } from '@/services/security.service';\r\n\r\n// Import shared types\r\nimport type { Order, DeliveryAddress, Listing, CustomRequestPurchase, DepositLog } from '@/types/order';\r\n\r\n// Re-export types for backward compatibility\r\nexport type { Order, DeliveryAddress, Listing, CustomRequestPurchase, DepositLog };\r\n\r\n// Debug mode helper\r\nconst DEBUG_MODE = process.env.NEXT_PUBLIC_DEBUG === 'true';\r\nconst debugLog = (...args: any[]) => {\r\n  if (DEBUG_MODE) {\r\n    console.log('[WalletContext]', ...args);\r\n  }\r\n};\r\n\r\ntype Withdrawal = {\r\n  amount: number;\r\n  date: string;\r\n  status?: 'pending' | 'completed' | 'failed';\r\n  method?: string;\r\n};\r\n\r\ntype AdminAction = {\r\n  id?: string;\r\n  _id?: string;\r\n  type: 'credit' | 'debit';\r\n  amount: number;\r\n  targetUser?: string;\r\n  username?: string;\r\n  adminUser?: string;\r\n  reason: string;\r\n  date: string;\r\n  role?: 'buyer' | 'seller';\r\n  metadata?: any;\r\n};\r\n\r\n// Validation schemas for wallet operations\r\nconst walletOperationSchemas = {\r\n  transactionAmount: z.number().positive().min(0.01).max(100000),\r\n  balanceAmount: z.number().min(0).max(100000),\r\n  username: z.string().min(3).max(30).regex(/^[a-zA-Z0-9_-]+$/),\r\n  reason: z.string().min(1).max(500),\r\n  withdrawalAmount: z.number().positive().min(10).max(10000),\r\n  tipAmount: z.number().positive().min(1).max(500),\r\n  depositMethod: z.enum(['credit_card', 'bank_transfer', 'crypto', 'admin_credit']),\r\n};\r\n\r\n// Enhanced deduplication manager with configurable expiry\r\nclass DeduplicationManager {\r\n  private processedEvents: Map<string, number> = new Map();\r\n  private cleanupInterval: NodeJS.Timeout | null = null;\r\n  private expiryMs: number;\r\n\r\n  constructor(expiryMs: number = 30000) {\r\n    this.expiryMs = expiryMs;\r\n    this.startCleanup();\r\n  }\r\n\r\n  private startCleanup() {\r\n    this.cleanupInterval = setInterval(() => {\r\n      const now = Date.now();\r\n      const expiredKeys: string[] = [];\r\n      \r\n      this.processedEvents.forEach((timestamp, key) => {\r\n        if (now - timestamp > this.expiryMs) {\r\n          expiredKeys.push(key);\r\n        }\r\n      });\r\n      \r\n      expiredKeys.forEach(key => this.processedEvents.delete(key));\r\n    }, 10000); // Cleanup every 10 seconds\r\n  }\r\n\r\n  isDuplicate(eventType: string, data: any): boolean {\r\n    // Create composite key based on event type\r\n    let key: string;\r\n    \r\n    if (eventType === 'balance_update') {\r\n      key = `${eventType}_${data.username}_${data.balance || data.newBalance}_${data.timestamp || Date.now()}`;\r\n    } else if (eventType === 'transaction') {\r\n      key = `${eventType}_${data.id || data.transactionId}_${data.from}_${data.to}_${data.amount}`;\r\n    } else if (eventType === 'order_created') {\r\n      key = `${eventType}_${data.id || data._id}_${data.buyer}_${data.seller}`;\r\n    } else {\r\n      key = `${eventType}_${JSON.stringify(data)}`;\r\n    }\r\n    \r\n    if (this.processedEvents.has(key)) {\r\n      return true;\r\n    }\r\n    \r\n    this.processedEvents.set(key, Date.now());\r\n    return false;\r\n  }\r\n\r\n  destroy() {\r\n    if (this.cleanupInterval) {\r\n      clearInterval(this.cleanupInterval);\r\n      this.cleanupInterval = null;\r\n    }\r\n    this.processedEvents.clear();\r\n  }\r\n}\r\n\r\n// Helper function to check if user is admin\r\nconst isAdminUser = (username: string): boolean => {\r\n  return username === 'oakley' || \r\n         username === 'gerome' || \r\n         username === 'platform' ||\r\n         username === 'admin';\r\n};\r\n\r\n// Transaction throttle manager\r\nclass ThrottleManager {\r\n  private lastCallTimes: Map<string, number> = new Map();\r\n  \r\n  shouldThrottle(key: string, minIntervalMs: number = 3000): boolean {\r\n    const now = Date.now();\r\n    const lastCall = this.lastCallTimes.get(key) || 0;\r\n    \r\n    if (now - lastCall < minIntervalMs) {\r\n      return true;\r\n    }\r\n    \r\n    this.lastCallTimes.set(key, now);\r\n    return false;\r\n  }\r\n  \r\n  clear() {\r\n    this.lastCallTimes.clear();\r\n  }\r\n}\r\n\r\n// Transaction lock manager for preventing race conditions\r\nclass TransactionLockManager {\r\n  private locks: Map<string, Promise<any>> = new Map();\r\n\r\n  async acquireLock<T>(key: string, operation: () => Promise<T>): Promise<T> {\r\n    const existingLock = this.locks.get(key);\r\n    if (existingLock) {\r\n      await existingLock;\r\n    }\r\n\r\n    let result: T;\r\n    const lockPromise = operation()\r\n      .then(res => {\r\n        result = res;\r\n        return res;\r\n      })\r\n      .finally(() => {\r\n        this.locks.delete(key);\r\n      });\r\n\r\n    this.locks.set(key, lockPromise);\r\n    await lockPromise;\r\n    return result!;\r\n  }\r\n\r\n  isLocked(key: string): boolean {\r\n    return this.locks.has(key);\r\n  }\r\n}\r\n\r\ntype WalletContextType = {\r\n  // Loading state\r\n  isLoading: boolean;\r\n  isInitialized: boolean;\r\n  initializationError: string | null;\r\n  \r\n  // Balances (cached from API)\r\n  buyerBalances: { [username: string]: number };\r\n  adminBalance: number;\r\n  sellerBalances: { [username: string]: number };\r\n  \r\n  // Balance operations\r\n  setBuyerBalance: (username: string, balance: number) => Promise<void>;\r\n  getBuyerBalance: (username: string) => number;\r\n  setAdminBalance: (balance: number) => Promise<void>;\r\n  setSellerBalance: (seller: string, balance: number) => Promise<void>;\r\n  getSellerBalance: (seller: string) => number;\r\n  \r\n  // Purchase operations\r\n  purchaseListing: (listing: Listing, buyerUsername: string) => Promise<boolean>;\r\n  purchaseCustomRequest: (customRequest: CustomRequestPurchase) => Promise<boolean>;\r\n  subscribeToSellerWithPayment: (buyer: string, seller: string, amount: number) => Promise<boolean>;\r\n  unsubscribeFromSeller: (buyer: string, seller: string) => Promise<boolean>;\r\n  \r\n  // Order management\r\n  orderHistory: Order[];\r\n  addOrder: (order: Order) => Promise<void>;\r\n  \r\n  // Withdrawals\r\n  sellerWithdrawals: { [username: string]: Withdrawal[] };\r\n  adminWithdrawals: Withdrawal[];\r\n  addSellerWithdrawal: (username: string, amount: number) => Promise<void>;\r\n  addAdminWithdrawal: (amount: number) => Promise<void>;\r\n  \r\n  // Legacy wallet interface\r\n  wallet: { [username: string]: number };\r\n  updateWallet: (username: string, amount: number, orderToFulfil?: Order) => void;\r\n  \r\n  // Tips and notifications\r\n  sendTip: (buyer: string, seller: string, amount: number, message?: string) => Promise<boolean>;\r\n  setAddSellerNotificationCallback?: (fn: (seller: string, message: string) => void) => void;\r\n  \r\n  // Admin actions\r\n  adminCreditUser: (username: string, role: 'buyer' | 'seller', amount: number, reason: string) => Promise<boolean>;\r\n  adminDebitUser: (username: string, role: 'buyer' | 'seller', amount: number, reason: string) => Promise<boolean>;\r\n  adminActions: AdminAction[];\r\n  \r\n  // Order updates\r\n  updateOrderAddress: (orderId: string, address: DeliveryAddress) => Promise<void>;\r\n  updateShippingStatus: (orderId: string, status: 'pending' | 'processing' | 'shipped') => Promise<void>;\r\n  \r\n  // Deposits\r\n  depositLogs: DepositLog[];\r\n  addDeposit: (username: string, amount: number, method: DepositLog['method'], notes?: string) => Promise<boolean>;\r\n  getDepositsForUser: (username: string) => DepositLog[];\r\n  getTotalDeposits: () => number;\r\n  getDepositsByTimeframe: (timeframe: 'today' | 'week' | 'month' | 'year' | 'all') => DepositLog[];\r\n  \r\n  // Auction methods\r\n  holdBidFunds: (listingId: string, bidder: string, amount: number, auctionTitle: string) => Promise<boolean>;\r\n  refundBidFunds: (bidder: string, listingId: string) => Promise<boolean>;\r\n  finalizeAuctionPurchase: (listing: Listing, winnerUsername: string, winningBid: number) => Promise<boolean>;\r\n  placeBid: (listingId: string, bidder: string, amount: number) => Promise<boolean>;\r\n  chargeIncrementalBid: (listingId: string, bidder: string, previousBid: number, newBid: number, listingTitle: string) => Promise<boolean>;\r\n  getAuctionBidders: (listingId: string) => Promise<string[]>;\r\n  cleanupAuctionTracking: (listingId: string, winner?: string) => Promise<void>;\r\n  \r\n  // Enhanced features\r\n  checkSuspiciousActivity: (username: string) => Promise<{ suspicious: boolean; reasons: string[] }>;\r\n  reconcileBalance: (username: string, role: 'buyer' | 'seller' | 'admin') => Promise<any>;\r\n  getTransactionHistory: (username?: string, limit?: number) => Promise<any[]>;\r\n  \r\n  // Admin-specific methods\r\n  refreshAdminData: () => Promise<void>;\r\n  getPlatformTransactions: (limit?: number, page?: number) => Promise<any[]>;\r\n  getAnalyticsData: (timeFilter?: string) => Promise<any>;\r\n  \r\n  // Data management\r\n  reloadData: () => Promise<void>;\r\n};\r\n\r\nexport const WalletContext = createContext<WalletContextType | undefined>(undefined);\r\n\r\nexport function WalletProvider({ children }: { children: ReactNode }) {\r\n  const { user, getAuthToken, apiClient } = useAuth();\r\n  const webSocketContext = useWebSocket();\r\n  \r\n  // Extract properties from WebSocket context safely\r\n  const sendMessage = webSocketContext?.sendMessage;\r\n  const subscribe = webSocketContext?.subscribe;\r\n  const isConnected = webSocketContext?.isConnected || false;\r\n  \r\n  // State management - these will be populated from API\r\n  const [buyerBalances, setBuyerBalancesState] = useState<{ [username: string]: number }>({});\r\n  const [adminBalance, setAdminBalanceState] = useState<number>(0);\r\n  const [sellerBalances, setSellerBalancesState] = useState<{ [username: string]: number }>({});\r\n  const [orderHistory, setOrderHistory] = useState<Order[]>([]);\r\n  const [sellerWithdrawals, setSellerWithdrawals] = useState<{ [username: string]: Withdrawal[] }>({});\r\n  const [adminWithdrawals, setAdminWithdrawals] = useState<Withdrawal[]>([]);\r\n  const [adminActions, setAdminActions] = useState<AdminAction[]>([]);\r\n  const [depositLogs, setDepositLogs] = useState<DepositLog[]>([]);\r\n  const [addSellerNotification, setAddSellerNotification] = useState<((seller: string, message: string) => void) | null>(null);\r\n  \r\n  // Loading and initialization state\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [isInitialized, setIsInitialized] = useState(false);\r\n  const [initializationError, setInitializationError] = useState<string | null>(null);\r\n  \r\n  // Refs\r\n  const initializingRef = useRef(false);\r\n  const rateLimiter = useRef(getRateLimiter());\r\n  const transactionLock = useRef(new TransactionLockManager());\r\n  const deduplicationManager = useRef(new DeduplicationManager(30000)); // 30 second expiry\r\n  const throttleManager = useRef(new ThrottleManager());\r\n  \r\n  // FIX: Add refs to track last fetched data for deduplication\r\n  const lastFiredBalanceRef = useRef<{ balance: number; timestamp: number } | null>(null);\r\n  const lastPlatformBalanceFetch = useRef<{ balance: number; timestamp: number } | null>(null);\r\n  const lastAdminActionsFetch = useRef<number>(0);\r\n\r\n  const setAddSellerNotificationCallback = (fn: (seller: string, message: string) => void) => {\r\n    setAddSellerNotification(() => fn);\r\n  };\r\n\r\n  // Cleanup on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      deduplicationManager.current.destroy();\r\n      throttleManager.current.clear();\r\n    };\r\n  }, []);\r\n\r\n  // FIX: Enhanced fireAdminBalanceUpdateEvent with deduplication\r\n  const fireAdminBalanceUpdateEvent = useCallback((balance: number) => {\r\n    if (typeof window !== 'undefined') {\r\n      // Deduplicate: Don't fire if same balance was fired within 1 second\r\n      const now = Date.now();\r\n      if (lastFiredBalanceRef.current) {\r\n        const { balance: lastBalance, timestamp: lastTime } = lastFiredBalanceRef.current;\r\n        if (lastBalance === balance && (now - lastTime) < 1000) {\r\n          debugLog('Skipping duplicate admin balance event:', balance);\r\n          return;\r\n        }\r\n      }\r\n      \r\n      debugLog('Firing admin balance update event:', balance);\r\n      lastFiredBalanceRef.current = { balance, timestamp: now };\r\n      \r\n      window.dispatchEvent(new CustomEvent('wallet:admin-balance-updated', {\r\n        detail: { balance, timestamp: now }\r\n      }));\r\n    }\r\n  }, []);\r\n\r\n  // Helper function to validate amounts\r\n  const validateTransactionAmount = (amount: number): number => {\r\n    const validation = walletOperationSchemas.transactionAmount.safeParse(amount);\r\n    if (!validation.success) {\r\n      throw new Error('Invalid transaction amount: ' + validation.error.errors[0]?.message);\r\n    }\r\n    return sanitizeCurrency(validation.data);\r\n  };\r\n\r\n  const validateUsername = (username: string): string => {\r\n    const validation = walletOperationSchemas.username.safeParse(username);\r\n    if (!validation.success) {\r\n      throw new Error('Invalid username: ' + validation.error.errors[0]?.message);\r\n    }\r\n    return sanitizeUsername(validation.data);\r\n  };\r\n\r\n  // Check rate limit\r\n  const checkRateLimit = (operation: string, identifier?: string): void => {\r\n    const rateLimitConfig = RATE_LIMITS[operation as keyof typeof RATE_LIMITS] || RATE_LIMITS.API_CALL;\r\n    const result = rateLimiter.current.check(operation, { ...rateLimitConfig, identifier });\r\n    \r\n    if (!result.allowed) {\r\n      throw new Error(`Rate limit exceeded. Please wait ${result.waitTime} seconds before trying again.`);\r\n    }\r\n  };\r\n\r\n  // CRITICAL FIX: Fetch actual orders from /orders endpoint\r\n  const fetchOrderHistory = useCallback(async (username: string) => {\r\n    try {\r\n      debugLog('Fetching orders for:', username);\r\n      \r\n      // Use the orders endpoint with buyer parameter\r\n      const response = await apiClient.get<any>(`/orders?buyer=${username}`);\r\n      \r\n      debugLog('Orders response:', response);\r\n      \r\n      if (response.success && response.data) {\r\n        // The orders should already be in the correct format\r\n        setOrderHistory(response.data);\r\n        debugLog('Order history updated:', response.data.length, 'orders');\r\n      }\r\n    } catch (error) {\r\n      console.error('[WalletContext] Failed to fetch order history:', error);\r\n    }\r\n  }, [apiClient]);\r\n\r\n  // Also fetch transactions for transaction history (keep this separate)\r\n  const fetchTransactionHistory = useCallback(async (username: string) => {\r\n    try {\r\n      debugLog('Fetching transactions for:', username);\r\n      \r\n      // For admin users, fetch platform transactions\r\n      const queryUsername = isAdminUser(username) ? 'platform' : username;\r\n      \r\n      const response = await apiClient.get<any>(`/wallet/transactions/${queryUsername}`);\r\n      \r\n      debugLog('Transactions response:', response);\r\n      \r\n      // Don't try to convert transactions to orders anymore\r\n      // Transactions and orders are separate things\r\n      \r\n    } catch (error) {\r\n      console.error('[WalletContext] Failed to fetch transaction history:', error);\r\n    }\r\n  }, [apiClient]);\r\n\r\n  // CRITICAL FIX: Fetch admin platform wallet balance with proper throttling\r\n  const fetchAdminPlatformBalance = useCallback(async (): Promise<number> => {\r\n    if (!user || (user.role !== 'admin' && !isAdminUser(user.username))) {\r\n      debugLog('Not admin user, skipping platform balance fetch');\r\n      return 0;\r\n    }\r\n\r\n    // CRITICAL FIX: Throttle platform balance fetches to prevent infinite loop\r\n    const now = Date.now();\r\n    if (lastPlatformBalanceFetch.current) {\r\n      const { balance: lastBalance, timestamp: lastTime } = lastPlatformBalanceFetch.current;\r\n      // If we fetched within the last 5 seconds, return cached value\r\n      if ((now - lastTime) < 5000) {\r\n        debugLog('Returning cached platform balance (throttled):', lastBalance);\r\n        return lastBalance;\r\n      }\r\n    }\r\n\r\n    // Check if we're already fetching to prevent concurrent calls\r\n    const throttleKey = 'admin_platform_balance_fetch';\r\n    if (throttleManager.current.shouldThrottle(throttleKey, 5000)) {\r\n      debugLog('Platform balance fetch throttled, returning current balance:', adminBalance);\r\n      return adminBalance;\r\n    }\r\n\r\n    try {\r\n      console.log('[Wallet] Admin requesting unified platform wallet balance...');\r\n      \r\n      // Always use the unified endpoint\r\n      const response = await apiClient.get<any>('/wallet/admin-platform-balance');\r\n      \r\n      debugLog('Unified platform balance response:', response);\r\n      \r\n      if (response.success && response.data) {\r\n        const balance = response.data.balance || 0;\r\n        console.log('[Wallet] Unified platform wallet balance:', balance);\r\n        \r\n        // Cache the fetched balance\r\n        lastPlatformBalanceFetch.current = { balance, timestamp: now };\r\n        \r\n        // Only update state if balance actually changed\r\n        if (balance !== adminBalance) {\r\n          // Set this as THE admin balance for all admin users\r\n          setAdminBalanceState(balance);\r\n          \r\n          // Fire event with deduplication\r\n          fireAdminBalanceUpdateEvent(balance);\r\n        } else {\r\n          debugLog('Balance unchanged, skipping state update');\r\n        }\r\n        \r\n        return balance;\r\n      }\r\n      \r\n      console.warn('[Wallet] Platform balance fetch failed:', response.error);\r\n      return adminBalance; // Return current balance on failure\r\n    } catch (error) {\r\n      console.error('[Wallet] Error fetching platform balance:', error);\r\n      return adminBalance; // Return current balance on error\r\n    }\r\n  }, [user, apiClient, fireAdminBalanceUpdateEvent, adminBalance]);\r\n\r\n  // CRITICAL FIX: Fetch admin actions from API with throttling\r\n  const fetchAdminActions = useCallback(async (): Promise<void> => {\r\n    if (!user || (user.role !== 'admin' && !isAdminUser(user.username))) {\r\n      debugLog('Not admin user, skipping admin actions fetch');\r\n      return;\r\n    }\r\n\r\n    // Throttle admin actions fetch to prevent rapid calls\r\n    const now = Date.now();\r\n    if (now - lastAdminActionsFetch.current < 30000) { // 30 second minimum between fetches\r\n      debugLog('Admin actions fetch throttled');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      debugLog('Fetching admin actions...');\r\n      lastAdminActionsFetch.current = now;\r\n      \r\n      const response = await apiClient.get<any>('/admin/actions?limit=100');\r\n      \r\n      debugLog('Admin actions response:', response);\r\n      \r\n      if (response.success && response.data) {\r\n        // Normalize the admin actions data\r\n        const normalizedActions = response.data.map((action: any) => ({\r\n          id: action._id || action.id,\r\n          _id: action._id || action.id,\r\n          type: action.type,\r\n          amount: action.amount,\r\n          reason: action.reason,\r\n          date: action.date,\r\n          metadata: action.metadata || {},\r\n          targetUser: action.metadata?.seller || action.metadata?.username,\r\n          username: action.metadata?.seller || action.metadata?.username,\r\n          adminUser: action.adminUser || 'platform',\r\n          role: action.metadata?.role\r\n        }));\r\n        \r\n        setAdminActions(normalizedActions);\r\n        debugLog('Admin actions loaded:', normalizedActions.length);\r\n      } else {\r\n        console.warn('[WalletContext] Admin actions fetch failed:', response.error);\r\n      }\r\n    } catch (error) {\r\n      console.error('[WalletContext] Error fetching admin actions:', error);\r\n    }\r\n  }, [user, apiClient]);\r\n\r\n  // FIXED: Define reloadData BEFORE it's used in other functions\r\n  const reloadData = useCallback(async () => {\r\n    if (isLoading) {\r\n      debugLog('Already loading, skipping reload');\r\n      return;\r\n    }\r\n    \r\n    setIsLoading(true);\r\n    try {\r\n      // Note: loadAllData will be defined later, so we need to be careful here\r\n      // For now, we'll just set a flag and handle the actual loading later\r\n      debugLog('Reload data requested');\r\n      \r\n      // For admin users, also refresh admin actions\r\n      if (user?.role === 'admin' || isAdminUser(user?.username || '')) {\r\n        await fetchAdminActions();\r\n      }\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [isLoading, user, fetchAdminActions]);\r\n\r\n  // WebSocket event handlers\r\n  const handleWalletBalanceUpdate = useCallback((data: any) => {\r\n    debugLog('Received wallet:balance_update:', data);\r\n    \r\n    // Check for duplicate\r\n    if (deduplicationManager.current.isDuplicate('balance_update', data)) {\r\n      debugLog('Skipping duplicate balance update');\r\n      return;\r\n    }\r\n    \r\n    // Validate incoming data with security service\r\n    try {\r\n      // Sanitize username\r\n      const sanitizedUsername = data.username ? sanitizeUsername(data.username) : null;\r\n      if (!sanitizedUsername) {\r\n        console.error('[WalletContext] Invalid username in balance update');\r\n        return;\r\n      }\r\n      \r\n      // FIX: Handle different data structures from WebSocket\r\n      let balanceValue: number;\r\n      \r\n      // Check if balance is provided directly\r\n      if (typeof data.balance === 'number') {\r\n        balanceValue = data.balance;\r\n      }\r\n      // Check if it's in newBalance field (from backend WebSocket emit)\r\n      else if (typeof data.newBalance === 'number') {\r\n        balanceValue = data.newBalance;\r\n      }\r\n      // Check if it's nested in a data object\r\n      else if (data.data && typeof data.data.balance === 'number') {\r\n        balanceValue = data.data.balance;\r\n      }\r\n      // Default to 0 if no valid balance found\r\n      else {\r\n        console.warn('[WalletContext] No valid balance in update data:', data);\r\n        balanceValue = 0;\r\n      }\r\n      \r\n      // Validate balance amount\r\n      const balanceValidation = walletOperationSchemas.balanceAmount.safeParse(balanceValue);\r\n      if (!balanceValidation.success) {\r\n        console.error('[WalletContext] Invalid balance amount:', balanceValidation.error);\r\n        return;\r\n      }\r\n      \r\n      const validatedBalance = balanceValidation.data;\r\n      \r\n      // Process the balance update based on role\r\n      if (data.role === 'admin' || sanitizedUsername === 'platform' || isAdminUser(sanitizedUsername)) {\r\n        // Admin balance update - only update if value changed\r\n        if (user && (user.role === 'admin' || isAdminUser(user.username))) {\r\n          if (adminBalance !== validatedBalance) {\r\n            debugLog('Updating admin balance to:', validatedBalance);\r\n            setAdminBalanceState(validatedBalance);\r\n            \r\n            // Fire event for admin balance changes with deduplication\r\n            fireAdminBalanceUpdateEvent(validatedBalance);\r\n          }\r\n        }\r\n      } else if (data.role === 'buyer') {\r\n        // Update buyer balance\r\n        setBuyerBalancesState(prev => ({\r\n          ...prev,\r\n          [sanitizedUsername]: validatedBalance\r\n        }));\r\n        \r\n        // Fire event if current user\r\n        if (user && user.username === sanitizedUsername) {\r\n          window.dispatchEvent(new CustomEvent('wallet:buyer-balance-updated', {\r\n            detail: { balance: validatedBalance, timestamp: Date.now() }\r\n          }));\r\n        }\r\n      } else if (data.role === 'seller') {\r\n        // Update seller balance\r\n        setSellerBalancesState(prev => ({\r\n          ...prev,\r\n          [sanitizedUsername]: validatedBalance\r\n        }));\r\n        \r\n        // Fire event if current user\r\n        if (user && user.username === sanitizedUsername) {\r\n          window.dispatchEvent(new CustomEvent('wallet:seller-balance-updated', {\r\n            detail: { balance: validatedBalance, timestamp: Date.now() }\r\n          }));\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('[WalletContext] Error processing balance update:', error);\r\n    }\r\n  }, [user, fireAdminBalanceUpdateEvent, adminBalance]);\r\n\r\n  const handlePlatformBalanceUpdate = useCallback((data: any) => {\r\n    debugLog('Received platform:balance_update:', data);\r\n    \r\n    // Check for duplicate\r\n    if (deduplicationManager.current.isDuplicate('platform_balance', data)) {\r\n      debugLog('Skipping duplicate platform balance update');\r\n      return;\r\n    }\r\n    \r\n    // Handle different data structures\r\n    let balanceValue: number;\r\n    \r\n    if (typeof data.balance === 'number') {\r\n      balanceValue = data.balance;\r\n    } else if (typeof data.newBalance === 'number') {\r\n      balanceValue = data.newBalance;\r\n    } else if (data.data && typeof data.data.balance === 'number') {\r\n      balanceValue = data.data.balance;\r\n    } else {\r\n      console.warn('[WalletContext] No valid balance in platform update:', data);\r\n      balanceValue = 0;\r\n    }\r\n    \r\n    // Validate balance\r\n    const balanceValidation = walletOperationSchemas.balanceAmount.safeParse(balanceValue);\r\n    if (!balanceValidation.success) {\r\n      console.error('[WalletContext] Invalid platform balance:', balanceValidation.error);\r\n      return;\r\n    }\r\n    \r\n    // If current user is admin, update admin balance only if changed\r\n    if (user && (user.role === 'admin' || isAdminUser(user.username))) {\r\n      const newBalance = balanceValidation.data;\r\n      if (adminBalance !== newBalance) {\r\n        debugLog('Updating platform balance to:', newBalance);\r\n        setAdminBalanceState(newBalance);\r\n        \r\n        // Fire event with deduplication\r\n        fireAdminBalanceUpdateEvent(newBalance);\r\n      }\r\n    }\r\n  }, [user, fireAdminBalanceUpdateEvent, adminBalance]);\r\n\r\n  // CRITICAL: Add handler for order:created events\r\n  const handleOrderCreated = useCallback((data: any) => {\r\n    debugLog('Received order:created event:', data);\r\n    \r\n    // Check for duplicate\r\n    if (deduplicationManager.current.isDuplicate('order_created', data)) {\r\n      debugLog('Skipping duplicate order created event');\r\n      return;\r\n    }\r\n    \r\n    const order = data.order || data;\r\n    \r\n    // Check if this order is for the current user\r\n    if (user && (order.buyer === user.username || order.seller === user.username)) {\r\n      // Reload orders to get the new one\r\n      console.log('[WalletContext] New order for current user, refreshing orders');\r\n      fetchOrderHistory(user.username);\r\n    }\r\n  }, [user, fetchOrderHistory]);\r\n\r\n  const handleWalletTransaction = useCallback(async (data: any) => {\r\n    debugLog('Received wallet:transaction:', data);\r\n    \r\n    // Check for duplicate\r\n    if (deduplicationManager.current.isDuplicate('transaction', data)) {\r\n      debugLog('Skipping duplicate transaction');\r\n      return;\r\n    }\r\n    \r\n    // Validate transaction data\r\n    try {\r\n      // Sanitize usernames if present\r\n      const sanitizedFrom = data.from ? sanitizeUsername(data.from) : null;\r\n      const sanitizedTo = data.to ? sanitizeUsername(data.to) : null;\r\n      \r\n      // Validate amount if present\r\n      if (data.amount !== undefined) {\r\n        const amountValidation = walletOperationSchemas.transactionAmount.safeParse(data.amount);\r\n        if (!amountValidation.success) {\r\n          console.error('[WalletContext] Invalid transaction amount:', amountValidation.error);\r\n          return;\r\n        }\r\n      }\r\n      \r\n      // If transaction involves current user, refresh their data\r\n      if (user && (sanitizedFrom === user.username || sanitizedTo === user.username)) {\r\n        if (!throttleManager.current.shouldThrottle('user_data_refresh', 5000)) {\r\n          // Refresh both transactions and orders\r\n          await fetchTransactionHistory(user.username);\r\n          await fetchOrderHistory(user.username); \r\n        } else {\r\n          debugLog('Throttled user data refresh');\r\n        }\r\n      }\r\n      \r\n      // If transaction involves platform and user is admin, refresh admin data\r\n      if ((sanitizedFrom === 'platform' || sanitizedTo === 'platform') && \r\n          user && (user.role === 'admin' || isAdminUser(user.username))) {\r\n        if (!throttleManager.current.shouldThrottle('admin_platform_balance', 3000)) {\r\n          await fetchAdminPlatformBalance();\r\n          // Also refresh admin actions to get tier credit updates\r\n          await fetchAdminActions();\r\n        } else {\r\n          debugLog('Throttled admin platform balance refresh');\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('[WalletContext] Error processing transaction:', error);\r\n    }\r\n  }, [user, fetchTransactionHistory, fetchOrderHistory, fetchAdminPlatformBalance, fetchAdminActions]);\r\n\r\n  // Consolidated WebSocket subscriptions\r\n  useEffect(() => {\r\n    if (!isConnected || !subscribe) return;\r\n\r\n    debugLog('Setting up WebSocket subscriptions for wallet updates');\r\n\r\n    // Subscribe to wallet:balance_update events\r\n    const unsubBalance = subscribe('wallet:balance_update' as WebSocketEvent, handleWalletBalanceUpdate);\r\n\r\n    // Subscribe to platform:balance_update events\r\n    const unsubPlatform = subscribe('platform:balance_update' as WebSocketEvent, handlePlatformBalanceUpdate);\r\n\r\n    // Subscribe to wallet:transaction events\r\n    const unsubTransaction = subscribe('wallet:transaction' as WebSocketEvent, handleWalletTransaction);\r\n    \r\n    // CRITICAL: Subscribe to order:created events\r\n    const unsubOrderCreated = subscribe('order:created' as WebSocketEvent, handleOrderCreated);\r\n\r\n    // Cleanup subscriptions\r\n    return () => {\r\n      unsubBalance();\r\n      unsubPlatform();\r\n      unsubTransaction();\r\n      unsubOrderCreated();\r\n    };\r\n  }, [isConnected, subscribe, handleWalletBalanceUpdate, handlePlatformBalanceUpdate, handleWalletTransaction, handleOrderCreated]);\r\n\r\n  // Listen to custom WebSocket balance updates via events (backward compatibility)\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n\r\n    const handleBalanceUpdate = (event: CustomEvent) => {\r\n      const data = event.detail;\r\n      debugLog('Received custom balance update event:', data);\r\n      handleWalletBalanceUpdate(data);\r\n    };\r\n\r\n    const handleTransaction = (event: CustomEvent) => {\r\n      debugLog('Received custom transaction event:', event.detail);\r\n      handleWalletTransaction(event.detail);\r\n    };\r\n    \r\n    const handleOrderEvent = (event: CustomEvent) => {\r\n      debugLog('Received custom order event:', event.detail);\r\n      handleOrderCreated(event.detail);\r\n    };\r\n\r\n    // Listen for custom events from other components\r\n    window.addEventListener('wallet:balance_update', handleBalanceUpdate as EventListener);\r\n    window.addEventListener('wallet:transaction', handleTransaction as EventListener);\r\n    window.addEventListener('order:created', handleOrderEvent as EventListener);\r\n\r\n    return () => {\r\n      window.removeEventListener('wallet:balance_update', handleBalanceUpdate as EventListener);\r\n      window.removeEventListener('wallet:transaction', handleTransaction as EventListener);\r\n      window.removeEventListener('order:created', handleOrderEvent as EventListener);\r\n    };\r\n  }, [handleWalletBalanceUpdate, handleWalletTransaction, handleOrderCreated]);\r\n\r\n  // Helper to emit wallet balance updates\r\n  const emitBalanceUpdate = useCallback((username: string, role: 'buyer' | 'seller' | 'admin', balance: number) => {\r\n    if (isConnected && sendMessage) {\r\n      sendMessage(WebSocketEvent.WALLET_BALANCE_UPDATE, {\r\n        username,\r\n        role,\r\n        balance,\r\n        timestamp: Date.now()\r\n      });\r\n    }\r\n  }, [isConnected, sendMessage]);\r\n\r\n  // Send tip function\r\n  const sendTip = useCallback(async (\r\n    fromUsername: string, \r\n    toUsername: string, \r\n    amount: number,\r\n    message?: string\r\n  ): Promise<boolean> => {\r\n    try {\r\n      checkRateLimit('TIP', fromUsername);\r\n      \r\n      // Input validation\r\n      if (!fromUsername || !toUsername || amount <= 0) {\r\n        console.error('[Wallet] Invalid tip parameters');\r\n        return false;\r\n      }\r\n      \r\n      // Validate and sanitize inputs\r\n      const validatedFrom = validateUsername(fromUsername);\r\n      const validatedTo = validateUsername(toUsername);\r\n      const validatedAmount = validateTransactionAmount(amount);\r\n      \r\n      // Additional tip-specific validation\r\n      const tipValidation = walletOperationSchemas.tipAmount.safeParse(validatedAmount);\r\n      if (!tipValidation.success) {\r\n        console.error('[Wallet] Invalid tip amount:', tipValidation.error);\r\n        return false;\r\n      }\r\n      \r\n      // Check balance locally first\r\n      const senderBalance = buyerBalances[validatedFrom] || 0;\r\n      if (senderBalance < validatedAmount) {\r\n        console.error('[Wallet] Insufficient balance for tip');\r\n        return false;\r\n      }\r\n      \r\n      // Send tip to backend\r\n      const response = await apiClient.post<any>('/tips/send', {\r\n        amount: validatedAmount,\r\n        recipientUsername: validatedTo,\r\n        message: message ? sanitizeStrict(message) : undefined\r\n      });\r\n      \r\n      if (!response.success) {\r\n        console.error('[Wallet] Tip failed:', response.error);\r\n        return false;\r\n      }\r\n      \r\n      // Update local state optimistically\r\n      setBuyerBalancesState(prev => ({\r\n        ...prev,\r\n        [validatedFrom]: prev[validatedFrom] - validatedAmount\r\n      }));\r\n      \r\n      setSellerBalancesState(prev => ({\r\n        ...prev,\r\n        [validatedTo]: (prev[validatedTo] || 0) + validatedAmount\r\n      }));\r\n      \r\n      // Emit balance updates\r\n      emitBalanceUpdate(validatedFrom, 'buyer', senderBalance - validatedAmount);\r\n      emitBalanceUpdate(validatedTo, 'seller', (sellerBalances[validatedTo] || 0) + validatedAmount);\r\n      \r\n      // Log the transaction locally\r\n      const tipLog: DepositLog = {\r\n        id: response.data?.transaction?.id || uuidv4(),\r\n        username: validatedFrom,\r\n        amount: validatedAmount,\r\n        method: 'credit_card',\r\n        date: new Date().toISOString(),\r\n        status: 'completed',\r\n        transactionId: response.data?.transaction?.id || uuidv4(),\r\n        notes: `Tip to ${validatedTo}`,\r\n      };\r\n      \r\n      setDepositLogs(prev => [...prev, tipLog]);\r\n      \r\n      debugLog(`[Wallet] Tip sent: $${validatedAmount} from ${validatedFrom} to ${validatedTo}`);\r\n      return true;\r\n      \r\n    } catch (error) {\r\n      console.error('[Wallet] Error sending tip:', error);\r\n      return false;\r\n    }\r\n  }, [buyerBalances, sellerBalances, apiClient, emitBalanceUpdate]);\r\n\r\n  // Fetch balance from API\r\n  const fetchBalance = useCallback(async (username: string): Promise<number> => {\r\n    try {\r\n      debugLog('Fetching balance for:', username);\r\n      \r\n      // For admin users, always fetch platform wallet\r\n      if (isAdminUser(username)) {\r\n        debugLog('Admin user detected, fetching unified platform wallet');\r\n        \r\n        const response = await apiClient.get<any>('/wallet/admin-platform-balance');\r\n        \r\n        if (response.success && response.data) {\r\n          const balance = response.data.balance || 0;\r\n          debugLog('Unified platform wallet balance:', balance);\r\n          return balance;\r\n        }\r\n        \r\n        console.warn('[WalletContext] Platform balance fetch failed:', response.error);\r\n        return 0;\r\n      }\r\n      \r\n      // For regular users, fetch their individual wallet\r\n      const response = await apiClient.get<any>(`/wallet/balance/${username}`);\r\n      \r\n      debugLog('Balance response:', response);\r\n      \r\n      if (response.success && response.data) {\r\n        return response.data.balance || 0;\r\n      }\r\n      \r\n      console.warn('[WalletContext] Balance fetch failed:', response.error);\r\n      return 0;\r\n    } catch (error) {\r\n      console.error(`[WalletContext] Failed to fetch balance for ${username}:`, error);\r\n      return 0;\r\n    }\r\n  }, [apiClient]);\r\n\r\n  // Get platform transactions\r\n  const getPlatformTransactions = useCallback(async (limit: number = 100, page: number = 1): Promise<any[]> => {\r\n    if (!user || (user.role !== 'admin' && !isAdminUser(user.username))) {\r\n      debugLog('Not admin user, skipping platform transactions fetch');\r\n      return [];\r\n    }\r\n\r\n    try {\r\n      debugLog('Fetching platform transactions...');\r\n      \r\n      const response = await apiClient.get<any>(`/wallet/platform-transactions?limit=${limit}&page=${page}`);\r\n      \r\n      debugLog('Platform transactions response:', response);\r\n      \r\n      if (response.success && response.data) {\r\n        return response.data;\r\n      }\r\n      \r\n      console.warn('[WalletContext] Platform transactions fetch failed:', response.error);\r\n      return [];\r\n    } catch (error) {\r\n      console.error('[WalletContext] Error fetching platform transactions:', error);\r\n      return [];\r\n    }\r\n  }, [user, apiClient]);\r\n\r\n  // Fetch complete admin analytics data\r\n  const fetchAdminAnalytics = useCallback(async (timeFilter: string = 'all'): Promise<any> => {\r\n    if (!user || (user.role !== 'admin' && !isAdminUser(user.username))) {\r\n      debugLog('Not admin user, skipping analytics fetch');\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      debugLog('Fetching admin analytics data with filter:', timeFilter);\r\n      \r\n      const response = await apiClient.get<any>(`/wallet/admin/analytics?timeFilter=${timeFilter}`);\r\n      \r\n      debugLog('Admin analytics response:', response);\r\n      \r\n      if (response.success && response.data) {\r\n        const data = response.data;\r\n        \r\n        // Update all the state variables with the fetched data\r\n        // IMPORTANT: Admin balance is the unified platform wallet balance\r\n        if (data.adminBalance !== adminBalance) {\r\n          setAdminBalanceState(data.adminBalance);\r\n          fireAdminBalanceUpdateEvent(data.adminBalance);\r\n        }\r\n        \r\n        setOrderHistory(data.orderHistory);\r\n        setDepositLogs(data.depositLogs);\r\n        setSellerWithdrawals(data.sellerWithdrawals);\r\n        setAdminWithdrawals(data.adminWithdrawals);\r\n        \r\n        // If adminActions are included in the response, use them\r\n        // Otherwise, fetch them separately\r\n        if (data.adminActions && data.adminActions.length > 0) {\r\n          setAdminActions(data.adminActions);\r\n        } else {\r\n          // Fetch admin actions separately if not included\r\n          await fetchAdminActions();\r\n        }\r\n        \r\n        // Update wallet balances\r\n        if (data.wallet) {\r\n          Object.entries(data.wallet).forEach(([username, balance]) => {\r\n            if (data.users[username]) {\r\n              const userRole = data.users[username].role;\r\n              // Skip admin users as they use unified balance\r\n              if (userRole === 'admin' || isAdminUser(username)) {\r\n                // Don't set individual balances for admin users\r\n                return;\r\n              } else if (userRole === 'buyer') {\r\n                setBuyerBalancesState(prev => ({ ...prev, [username]: balance as number }));\r\n              } else if (userRole === 'seller') {\r\n                setSellerBalancesState(prev => ({ ...prev, [username]: balance as number }));\r\n              }\r\n            }\r\n          });\r\n        }\r\n        \r\n        debugLog('Analytics data loaded:', {\r\n          adminBalance: data.adminBalance,\r\n          orders: data.orderHistory.length,\r\n          deposits: data.depositLogs.length,\r\n          adminActions: adminActions.length,\r\n          summary: data.summary\r\n        });\r\n        \r\n        return data;\r\n      }\r\n      \r\n      console.warn('[WalletContext] Analytics fetch failed:', response.error);\r\n      return null;\r\n    } catch (error) {\r\n      console.error('[WalletContext] Error fetching analytics:', error);\r\n      return null;\r\n    }\r\n  }, [user, apiClient, fireAdminBalanceUpdateEvent, fetchAdminActions, adminActions.length, adminBalance]);\r\n\r\n  // Get analytics data with time filter\r\n  const getAnalyticsData = useCallback(async (timeFilter: string = 'all') => {\r\n    if (!user || (user.role !== 'admin' && !isAdminUser(user.username))) {\r\n      debugLog('Not admin, cannot get analytics');\r\n      return null;\r\n    }\r\n    \r\n    return await fetchAdminAnalytics(timeFilter);\r\n  }, [user, fetchAdminAnalytics]);\r\n\r\n  // Load all data from API with admin analytics support\r\n  const loadAllData = useCallback(async () => {\r\n    if (!user) {\r\n      debugLog('No user, skipping data load');\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      debugLog('Loading wallet data from API for user:', user.username);\r\n      \r\n      // For admin users, always fetch unified platform wallet\r\n      if (user.role === 'admin' || isAdminUser(user.username)) {\r\n        debugLog('Admin detected - fetching unified platform wallet...');\r\n        \r\n        // Fetch unified platform balance\r\n        const platformBalance = await fetchAdminPlatformBalance();\r\n        \r\n        // Fetch admin actions for tier credit tracking\r\n        await fetchAdminActions();\r\n        \r\n        // Also fetch analytics data if needed\r\n        const analyticsData = await fetchAdminAnalytics('all');\r\n        \r\n        if (analyticsData) {\r\n          // Override the admin balance with unified platform balance\r\n          if (platformBalance !== adminBalance) {\r\n            setAdminBalanceState(platformBalance);\r\n            fireAdminBalanceUpdateEvent(platformBalance);\r\n          }\r\n          \r\n          debugLog('Admin analytics loaded with unified balance:', platformBalance);\r\n        }\r\n        \r\n        return true;\r\n      }\r\n      \r\n      // For non-admin users, fetch regular wallet data\r\n      const balance = await fetchBalance(user.username);\r\n      debugLog('Fetched balance:', balance, 'for role:', user.role);\r\n      \r\n      if (user.role === 'buyer') {\r\n        setBuyerBalancesState(prev => ({ ...prev, [user.username]: balance }));\r\n      } else if (user.role === 'seller') {\r\n        setSellerBalancesState(prev => ({ ...prev, [user.username]: balance }));\r\n      }\r\n      \r\n      // CRITICAL: Fetch actual orders, not transactions\r\n      await fetchOrderHistory(user.username);\r\n      \r\n      // Also fetch transaction history for reference\r\n      await fetchTransactionHistory(user.username);\r\n      \r\n      debugLog('Data loaded successfully');\r\n      return true;\r\n    } catch (error) {\r\n      console.error('[WalletContext] Error loading wallet data:', error);\r\n      setInitializationError('Failed to load wallet data');\r\n      return false;\r\n    }\r\n  }, [user, fetchBalance, fetchAdminPlatformBalance, fetchAdminAnalytics, fetchOrderHistory, fetchTransactionHistory, fireAdminBalanceUpdateEvent, fetchAdminActions, adminBalance]);\r\n\r\n  // CRITICAL FIX: Refresh admin data with proper throttling\r\n  const refreshAdminData = useCallback(async () => {\r\n    if (!user || (user.role !== 'admin' && !isAdminUser(user.username))) {\r\n      debugLog('Not admin, skipping admin data refresh');\r\n      return;\r\n    }\r\n    \r\n    // Add throttling to prevent rapid refreshes\r\n    if (throttleManager.current.shouldThrottle('refresh_admin_data', 10000)) {\r\n      debugLog('Admin data refresh throttled');\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      debugLog('Refreshing admin data...');\r\n      \r\n      // Fetch unified platform balance (now properly throttled)\r\n      const platformBalance = await fetchAdminPlatformBalance();\r\n      \r\n      // Fetch admin actions (only if needed)\r\n      if (!throttleManager.current.shouldThrottle('fetch_admin_actions', 30000)) {\r\n        await fetchAdminActions();\r\n      }\r\n      \r\n      // Only fetch analytics if significant time has passed\r\n      if (!throttleManager.current.shouldThrottle('fetch_analytics', 60000)) {\r\n        const analyticsData = await fetchAdminAnalytics('all');\r\n        \r\n        if (analyticsData && analyticsData.adminBalance !== platformBalance) {\r\n          // Ensure unified balance is used\r\n          setAdminBalanceState(platformBalance);\r\n          fireAdminBalanceUpdateEvent(platformBalance);\r\n        }\r\n        \r\n        debugLog('Admin data refreshed with unified balance:', platformBalance);\r\n      }\r\n    } catch (error) {\r\n      console.error('[WalletContext] Error refreshing admin data:', error);\r\n    }\r\n  }, [user, fetchAdminPlatformBalance, fetchAdminAnalytics, fireAdminBalanceUpdateEvent, fetchAdminActions]);\r\n\r\n  // Initialize wallet when user logs in\r\n  useEffect(() => {\r\n    const initializeWallet = async () => {\r\n      if (initializingRef.current || !user) {\r\n        return;\r\n      }\r\n      \r\n      initializingRef.current = true;\r\n      setIsLoading(true);\r\n      setInitializationError(null);\r\n\r\n      try {\r\n        debugLog('Initializing wallet for user:', user.username);\r\n        \r\n        const loadSuccess = await loadAllData();\r\n        \r\n        if (loadSuccess) {\r\n          setIsInitialized(true);\r\n          debugLog('Wallet initialization complete');\r\n        }\r\n      } catch (error) {\r\n        console.error('[WalletContext] Initialization error:', error);\r\n        setInitializationError(error instanceof Error ? error.message : 'Unknown error');\r\n      } finally {\r\n        setIsLoading(false);\r\n        initializingRef.current = false;\r\n      }\r\n    };\r\n\r\n    if (user) {\r\n      initializeWallet();\r\n    } else {\r\n      // Clear wallet data when user logs out\r\n      setBuyerBalancesState({});\r\n      setSellerBalancesState({});\r\n      setAdminBalanceState(0);\r\n      setOrderHistory([]);\r\n      setIsInitialized(false);\r\n      deduplicationManager.current.destroy();\r\n      deduplicationManager.current = new DeduplicationManager(30000);\r\n      throttleManager.current.clear();\r\n      lastPlatformBalanceFetch.current = null;\r\n      lastFiredBalanceRef.current = null;\r\n      lastAdminActionsFetch.current = 0;\r\n    }\r\n  }, [user, loadAllData]);\r\n\r\n  // Balance getters (from cached state)\r\n  const getBuyerBalance = useCallback((username: string): number => {\r\n    try {\r\n      const validatedUsername = validateUsername(username);\r\n      // Admin users don't have buyer balances\r\n      if (isAdminUser(validatedUsername)) {\r\n        return 0;\r\n      }\r\n      return buyerBalances[validatedUsername] || 0;\r\n    } catch {\r\n      return 0;\r\n    }\r\n  }, [buyerBalances]);\r\n\r\n  const getSellerBalance = useCallback((seller: string): number => {\r\n    try {\r\n      const validatedSeller = validateUsername(seller);\r\n      // Admin users don't have seller balances\r\n      if (isAdminUser(validatedSeller)) {\r\n        return 0;\r\n      }\r\n      return sellerBalances[validatedSeller] || 0;\r\n    } catch {\r\n      return 0;\r\n    }\r\n  }, [sellerBalances]);\r\n\r\n  // Balance setters (update cache and call API)\r\n  const setBuyerBalance = useCallback(async (username: string, balance: number) => {\r\n    // Don't set buyer balance for admin users\r\n    if (isAdminUser(username)) {\r\n      debugLog('Skipping buyer balance update for admin user');\r\n      return;\r\n    }\r\n    \r\n    const validatedUsername = validateUsername(username);\r\n    \r\n    // Update local cache immediately\r\n    setBuyerBalancesState((prev) => ({\r\n      ...prev,\r\n      [validatedUsername]: balance,\r\n    }));\r\n    \r\n    // Emit WebSocket update\r\n    emitBalanceUpdate(validatedUsername, 'buyer', balance);\r\n  }, [emitBalanceUpdate]);\r\n\r\n  const setSellerBalance = useCallback(async (seller: string, balance: number) => {\r\n    // Don't set seller balance for admin users\r\n    if (isAdminUser(seller)) {\r\n      debugLog('Skipping seller balance update for admin user');\r\n      return;\r\n    }\r\n    \r\n    const validatedSeller = validateUsername(seller);\r\n    \r\n    // Update local cache immediately\r\n    setSellerBalancesState((prev) => ({\r\n      ...prev,\r\n      [validatedSeller]: balance,\r\n    }));\r\n    \r\n    // Emit WebSocket update\r\n    emitBalanceUpdate(validatedSeller, 'seller', balance);\r\n  }, [emitBalanceUpdate]);\r\n\r\n  const setAdminBalance = useCallback(async (balance: number) => {\r\n    // Only update if changed\r\n    if (adminBalance !== balance) {\r\n      setAdminBalanceState(balance);\r\n      fireAdminBalanceUpdateEvent(balance);\r\n      \r\n      // Emit WebSocket update for platform wallet\r\n      emitBalanceUpdate('platform', 'admin', balance);\r\n    }\r\n  }, [emitBalanceUpdate, fireAdminBalanceUpdateEvent, adminBalance]);\r\n\r\n  // Create order via API\r\n  const addOrder = useCallback(async (order: Order) => {\r\n    try {\r\n      debugLog('Creating order via API:', order);\r\n      \r\n      const orderPayload = {\r\n        title: order.title,\r\n        description: order.description,\r\n        price: order.price,\r\n        markedUpPrice: order.markedUpPrice,\r\n        seller: order.seller,\r\n        buyer: order.buyer,\r\n        tags: order.tags || [],\r\n        wasAuction: order.wasAuction || false,\r\n        imageUrl: order.imageUrl,\r\n        listingId: order.listingId,\r\n        deliveryAddress: order.deliveryAddress || {\r\n          fullName: 'John Doe',\r\n          addressLine1: '123 Main St',\r\n          city: 'New York',\r\n          state: 'NY',\r\n          postalCode: '10001',\r\n          country: 'US',\r\n        },\r\n      };\r\n\r\n      debugLog('Order payload:', orderPayload);\r\n\r\n      const response = await apiClient.post<any>('/orders', orderPayload);\r\n\r\n      debugLog('Order creation response:', response);\r\n\r\n      if (response.success && response.data) {\r\n        // Include tier information in the order\r\n        const orderWithTier = {\r\n          ...response.data,\r\n          sellerTier: response.data.sellerTier,\r\n          tierCreditAmount: response.data.tierCreditAmount || 0\r\n        };\r\n        \r\n        setOrderHistory((prev) => [...prev, orderWithTier]);\r\n        \r\n        // Only fetch current user's balance after order creation\r\n        if (user?.username) {\r\n          const newBalance = await fetchBalance(user.username);\r\n          \r\n          if (user.role === 'buyer') {\r\n            setBuyerBalancesState(prev => ({ ...prev, [user.username]: newBalance }));\r\n          } else if (user.role === 'seller') {\r\n            setSellerBalancesState(prev => ({ ...prev, [user.username]: newBalance }));\r\n          } else if (user.role === 'admin' || isAdminUser(user.username)) {\r\n            // For admin users, refresh platform balance AND admin actions\r\n            await refreshAdminData();\r\n          }\r\n        }\r\n        \r\n        // If current user is admin, refresh admin actions to get tier credits\r\n        if (user?.role === 'admin' || isAdminUser(user?.username || '')) {\r\n          await fetchAdminActions();\r\n        }\r\n        \r\n        // Refresh order history for current user only\r\n        if (user?.username) {\r\n          if (!throttleManager.current.shouldThrottle('order_refresh', 3000)) {\r\n            await fetchOrderHistory(user.username);\r\n          }\r\n        }\r\n        \r\n        debugLog('Order created and balance updated');\r\n      } else {\r\n        const errorMessage = response.error?.message || response.error || 'Order creation failed';\r\n        console.error('[WalletContext] Order creation failed:', errorMessage);\r\n        throw new Error(errorMessage);\r\n      }\r\n    } catch (error) {\r\n      console.error('[WalletContext] Failed to create order:', error);\r\n      throw error;\r\n    }\r\n  }, [apiClient, fetchBalance, fetchOrderHistory, refreshAdminData, user, fetchAdminActions]);\r\n\r\n  // UPDATED: Purchase custom request implementation\r\n  const purchaseCustomRequest = useCallback(async (request: CustomRequestPurchase): Promise<boolean> => {\r\n    console.log('[WalletContext] Processing custom request purchase:', request);\r\n    \r\n    try {\r\n      debugLog('Processing custom request via API:', {\r\n        requestId: request.requestId,\r\n        buyer: request.buyer,\r\n        seller: request.seller,\r\n        amount: request.amount\r\n      });\r\n      \r\n      // Prepare the request data for the backend\r\n      const orderRequest = {\r\n        requestId: request.requestId,\r\n        title: request.description || 'Custom Request',\r\n        description: request.metadata?.description || request.description,\r\n        price: request.amount,\r\n        seller: request.seller,\r\n        buyer: request.buyer,\r\n        tags: request.metadata?.tags || [],\r\n        deliveryAddress: undefined // Will be added later by buyer\r\n      };\r\n      \r\n      debugLog('Calling custom request endpoint with:', orderRequest);\r\n      \r\n      // Call the new custom request endpoint\r\n      const response = await apiClient.post<any>('/orders/custom-request', orderRequest);\r\n      \r\n      debugLog('Custom request order response:', response);\r\n      \r\n      if (response.success && response.data) {\r\n        console.log('[WalletContext] Custom request order created successfully:', response.data.id);\r\n        \r\n        // Add to order history\r\n        const orderWithDetails = {\r\n          ...response.data,\r\n          isCustomRequest: true,\r\n          originalRequestId: request.requestId\r\n        };\r\n        setOrderHistory(prev => [...prev, orderWithDetails]);\r\n        \r\n        // Now update reloadData to use loadAllData\r\n        await loadAllData();\r\n        \r\n        // Dispatch event for other components to react\r\n        window.dispatchEvent(new CustomEvent('custom_request:paid', {\r\n          detail: {\r\n            requestId: request.requestId,\r\n            orderId: response.data.id,\r\n            buyer: request.buyer,\r\n            seller: request.seller,\r\n            amount: request.amount\r\n          }\r\n        }));\r\n        \r\n        // If notification callback is set, notify seller\r\n        if (addSellerNotification) {\r\n          addSellerNotification(\r\n            request.seller,\r\n            `💰 Custom request \"${request.description}\" has been paid! Check your orders to fulfill.`\r\n          );\r\n        }\r\n        \r\n        return true;\r\n      } else {\r\n        console.error('[WalletContext] Failed to create custom request order:', response.error);\r\n        \r\n        // Check if it's an insufficient balance error\r\n        if (response.error?.message?.includes('Insufficient balance')) {\r\n          throw new Error(response.error.message);\r\n        }\r\n        \r\n        return false;\r\n      }\r\n      \r\n    } catch (error) {\r\n      console.error('[WalletContext] Error processing custom request purchase:', error);\r\n      \r\n      // Re-throw errors with message for UI to handle\r\n      if (error instanceof Error) {\r\n        throw error;\r\n      }\r\n      \r\n      throw new Error('Failed to process custom request payment');\r\n    }\r\n  }, [apiClient, loadAllData, addSellerNotification]);\r\n\r\n  // Make a deposit via API\r\n  const addDeposit = useCallback(async (\r\n    username: string, \r\n    amount: number, \r\n    method: DepositLog['method'], \r\n    notes?: string\r\n  ): Promise<boolean> => {\r\n    try {\r\n      checkRateLimit('DEPOSIT', username);\r\n      \r\n      const validatedUsername = validateUsername(username);\r\n      const validatedAmount = validateTransactionAmount(amount);\r\n      \r\n      debugLog('Processing deposit via API:', {\r\n        username: validatedUsername,\r\n        amount: validatedAmount,\r\n        method,\r\n        authUser: user?.username\r\n      });\r\n      \r\n      const response = await apiClient.post<any>('/wallet/deposit', {\r\n        amount: validatedAmount,\r\n        method,\r\n        notes,\r\n      });\r\n      \r\n      debugLog('Deposit response:', response);\r\n      \r\n      if (response.success) {\r\n        // Wait a moment for the transaction to be processed\r\n        await new Promise(resolve => setTimeout(resolve, 500));\r\n        \r\n        // Refresh balance after deposit\r\n        const newBalance = await fetchBalance(validatedUsername);\r\n        debugLog('New balance after deposit:', newBalance);\r\n        \r\n        if (!isAdminUser(validatedUsername)) {\r\n          setBuyerBalancesState(prev => ({ ...prev, [validatedUsername]: newBalance }));\r\n        }\r\n        \r\n        // Add to local deposit logs\r\n        const depositLog: DepositLog = {\r\n          id: response.data?.id || uuidv4(),\r\n          username: validatedUsername,\r\n          amount: validatedAmount,\r\n          method,\r\n          date: response.data?.createdAt || new Date().toISOString(),\r\n          status: 'completed',\r\n          transactionId: response.data?.id || uuidv4(),\r\n          notes,\r\n        };\r\n        \r\n        setDepositLogs(prev => [...prev, depositLog]);\r\n        \r\n        // Emit WebSocket event for real-time update\r\n        if (!isAdminUser(validatedUsername)) {\r\n          emitBalanceUpdate(validatedUsername, 'buyer', newBalance);\r\n        }\r\n        \r\n        debugLog('Deposit successful');\r\n        return true;\r\n      } else {\r\n        console.error('[WalletContext] Deposit failed:', response.error);\r\n        if (response.error?.message) {\r\n          throw new Error(response.error.message);\r\n        }\r\n        return false;\r\n      }\r\n    } catch (error) {\r\n      console.error('[WalletContext] Error processing deposit:', error);\r\n      throw error;\r\n    }\r\n  }, [apiClient, fetchBalance, emitBalanceUpdate, user]);\r\n\r\n  // Purchase listing with proper error handling\r\n  const purchaseListing = useCallback(async (listing: Listing, buyerUsername: string): Promise<boolean> => {\r\n    try {\r\n      checkRateLimit('API_CALL', buyerUsername);\r\n      \r\n      const validatedBuyer = validateUsername(buyerUsername);\r\n      const validatedSeller = validateUsername(listing.seller);\r\n      \r\n      // Validate price with security service\r\n      const priceValidation = securityService.validateAmount(listing.price, {\r\n        min: 0.01,\r\n        max: 100000\r\n      });\r\n      \r\n      if (!priceValidation.valid) {\r\n        throw new Error(priceValidation.error || 'Invalid listing price');\r\n      }\r\n      \r\n      debugLog('Processing purchase:', {\r\n        buyer: validatedBuyer,\r\n        seller: validatedSeller,\r\n        listing: listing.title,\r\n        price: listing.price,\r\n        markedUpPrice: listing.markedUpPrice\r\n      });\r\n      \r\n      await addOrder({\r\n        id: listing.id || uuidv4(),\r\n        title: listing.title,\r\n        description: listing.description,\r\n        price: listing.price,\r\n        markedUpPrice: listing.markedUpPrice || listing.price,\r\n        seller: validatedSeller,\r\n        buyer: validatedBuyer,\r\n        imageUrl: listing.imageUrls?.[0],\r\n        date: new Date().toISOString(),\r\n        shippingStatus: 'pending',\r\n        tags: listing.tags || [],\r\n        listingId: listing.id,\r\n        deliveryAddress: {\r\n          fullName: 'John Doe',\r\n          addressLine1: '123 Main St',\r\n          city: 'New York',\r\n          state: 'NY',\r\n          postalCode: '10001',\r\n          country: 'US',\r\n        },\r\n      });\r\n      \r\n      // Notification\r\n      if (addSellerNotification) {\r\n        addSellerNotification(\r\n          validatedSeller,\r\n          `New sale: \"${listing.title}\" for ${listing.price.toFixed(2)}`\r\n        );\r\n      }\r\n      \r\n      debugLog('Purchase successful');\r\n      return true;\r\n    } catch (error) {\r\n      console.error('[Purchase] Error:', error);\r\n      throw error;\r\n    }\r\n  }, [addOrder, addSellerNotification]);\r\n\r\n  // Withdraw funds via API\r\n  const addSellerWithdrawal = useCallback(async (username: string, amount: number) => {\r\n    try {\r\n      checkRateLimit('WITHDRAWAL', username);\r\n      \r\n      const validatedUsername = validateUsername(username);\r\n      const validatedAmount = validateTransactionAmount(amount);\r\n      \r\n      debugLog('Processing withdrawal via API:', {\r\n        username: validatedUsername,\r\n        amount: validatedAmount\r\n      });\r\n      \r\n      const response = await apiClient.post<any>('/wallet/withdraw', {\r\n        username: validatedUsername,\r\n        amount: validatedAmount,\r\n        accountDetails: {\r\n          accountNumber: '****1234',\r\n          routingNumber: '123456789',\r\n          accountType: 'checking',\r\n        },\r\n      });\r\n      \r\n      debugLog('Withdrawal response:', response);\r\n      \r\n      if (response.success) {\r\n        const newWithdrawal: Withdrawal = { \r\n          amount: validatedAmount, \r\n          date: response.data?.createdAt || new Date().toISOString(), \r\n          status: response.data?.status || 'pending'\r\n        };\r\n        \r\n        setSellerWithdrawals((prev) => ({\r\n          ...prev,\r\n          [validatedUsername]: [...(prev[validatedUsername] || []), newWithdrawal],\r\n        }));\r\n        \r\n        // Refresh balance\r\n        const newBalance = await fetchBalance(validatedUsername);\r\n        if (!isAdminUser(validatedUsername)) {\r\n          setSellerBalancesState(prev => ({ ...prev, [validatedUsername]: newBalance }));\r\n        }\r\n        \r\n        debugLog('Withdrawal successful');\r\n      } else {\r\n        console.error('[WalletContext] Withdrawal failed:', response.error);\r\n        throw new Error(response.error?.message || 'Withdrawal failed');\r\n      }\r\n    } catch (error) {\r\n      console.error('[WalletContext] Withdrawal error:', error);\r\n      throw error;\r\n    }\r\n  }, [apiClient, fetchBalance]);\r\n\r\n  // Admin credit via API\r\n  const adminCreditUser = useCallback(async (\r\n    username: string,\r\n    role: 'buyer' | 'seller',\r\n    amount: number,\r\n    reason: string\r\n  ): Promise<boolean> => {\r\n    try {\r\n      checkRateLimit('REPORT_ACTION', 'admin');\r\n      \r\n      const validatedUsername = validateUsername(username);\r\n      const validatedAmount = validateTransactionAmount(amount);\r\n      const sanitizedReason = sanitizeStrict(reason);\r\n      \r\n      debugLog('Processing admin credit via API:', {\r\n        username: validatedUsername,\r\n        role,\r\n        amount: validatedAmount,\r\n        reason: sanitizedReason\r\n      });\r\n      \r\n      const response = await apiClient.post<any>('/wallet/admin-actions', {\r\n        action: 'credit',\r\n        username: validatedUsername,\r\n        amount: validatedAmount,\r\n        reason: sanitizedReason,\r\n        adminUsername: user?.username || 'platform',\r\n      });\r\n      \r\n      debugLog('Admin credit response:', response);\r\n      \r\n      if (response.success) {\r\n        // Refresh balance\r\n        const newBalance = await fetchBalance(validatedUsername);\r\n        \r\n        if (role === 'buyer' && !isAdminUser(validatedUsername)) {\r\n          setBuyerBalancesState(prev => ({ ...prev, [validatedUsername]: newBalance }));\r\n        } else if (role === 'seller' && !isAdminUser(validatedUsername)) {\r\n          setSellerBalancesState(prev => ({ ...prev, [validatedUsername]: newBalance }));\r\n        }\r\n        \r\n        // Refresh platform balance after admin action\r\n        if (user?.role === 'admin' || isAdminUser(user?.username || '')) {\r\n          await fetchAdminPlatformBalance();\r\n          // Refresh admin actions after credit\r\n          await fetchAdminActions();\r\n        }\r\n        \r\n        // Update admin actions locally\r\n        const action: AdminAction = {\r\n          id: response.data?.id || uuidv4(),\r\n          type: 'credit',\r\n          amount: validatedAmount,\r\n          targetUser: validatedUsername,\r\n          username: validatedUsername,\r\n          adminUser: user?.username || 'platform',\r\n          reason: sanitizedReason,\r\n          date: response.data?.createdAt || new Date().toISOString(),\r\n          role,\r\n        };\r\n        \r\n        setAdminActions(prev => [...prev, action]);\r\n        \r\n        debugLog('Admin credit successful');\r\n        return true;\r\n      }\r\n      \r\n      console.error('[WalletContext] Admin credit failed:', response.error);\r\n      return false;\r\n    } catch (error) {\r\n      console.error('Admin credit error:', error);\r\n      return false;\r\n    }\r\n  }, [user, apiClient, fetchBalance, fetchAdminPlatformBalance, fetchAdminActions]);\r\n\r\n  // Admin debit via API\r\n  const adminDebitUser = useCallback(async (\r\n    username: string,\r\n    role: 'buyer' | 'seller',\r\n    amount: number,\r\n    reason: string\r\n  ): Promise<boolean> => {\r\n    try {\r\n      checkRateLimit('REPORT_ACTION', 'admin');\r\n      \r\n      const validatedUsername = validateUsername(username);\r\n      const validatedAmount = validateTransactionAmount(amount);\r\n      const sanitizedReason = sanitizeStrict(reason);\r\n      \r\n      debugLog('Processing admin debit via API:', {\r\n        username: validatedUsername,\r\n        role,\r\n        amount: validatedAmount,\r\n        reason: sanitizedReason\r\n      });\r\n      \r\n      const response = await apiClient.post<any>('/wallet/admin-actions', {\r\n        action: 'debit',\r\n        username: validatedUsername,\r\n        amount: validatedAmount,\r\n        reason: sanitizedReason,\r\n        adminUsername: user?.username || 'platform',\r\n      });\r\n      \r\n      debugLog('Admin debit response:', response);\r\n      \r\n      if (response.success) {\r\n        // Refresh balance\r\n        const newBalance = await fetchBalance(validatedUsername);\r\n        \r\n        if (role === 'buyer' && !isAdminUser(validatedUsername)) {\r\n          setBuyerBalancesState(prev => ({ ...prev, [validatedUsername]: newBalance }));\r\n        } else if (role === 'seller' && !isAdminUser(validatedUsername)) {\r\n          setSellerBalancesState(prev => ({ ...prev, [validatedUsername]: newBalance }));\r\n        }\r\n        \r\n        // Refresh platform balance after admin action\r\n        if (user?.role === 'admin' || isAdminUser(user?.username || '')) {\r\n          await fetchAdminPlatformBalance();\r\n          // Refresh admin actions after debit\r\n          await fetchAdminActions();\r\n        }\r\n        \r\n        // Update admin actions locally\r\n        const action: AdminAction = {\r\n          id: response.data?.id || uuidv4(),\r\n          type: 'debit',\r\n          amount: validatedAmount,\r\n          targetUser: validatedUsername,\r\n          username: validatedUsername,\r\n          adminUser: user?.username || 'platform',\r\n          reason: sanitizedReason,\r\n          date: response.data?.createdAt || new Date().toISOString(),\r\n          role,\r\n        };\r\n        \r\n        setAdminActions(prev => [...prev, action]);\r\n        \r\n        debugLog('Admin debit successful');\r\n        return true;\r\n      }\r\n      \r\n      console.error('[WalletContext] Admin debit failed:', response.error);\r\n      return false;\r\n    } catch (error) {\r\n      console.error('Admin debit error:', error);\r\n      return false;\r\n    }\r\n  }, [user, apiClient, fetchBalance, fetchAdminPlatformBalance, fetchAdminActions]);\r\n\r\n  // Get transaction history from API\r\n  const getTransactionHistory = useCallback(async (username?: string, limit?: number) => {\r\n    try {\r\n      const targetUsername = username || user?.username;\r\n      if (!targetUsername) {\r\n        console.warn('[WalletContext] No username for transaction history');\r\n        return [];\r\n      }\r\n      \r\n      // For admin users, use platform\r\n      const queryUsername = isAdminUser(targetUsername) ? 'platform' : targetUsername;\r\n      \r\n      const endpoint = `/wallet/transactions/${queryUsername}${limit ? `?limit=${limit}` : ''}`;\r\n      debugLog('Fetching transaction history:', endpoint);\r\n      \r\n      const response = await apiClient.get<any>(endpoint);\r\n      \r\n      debugLog('Transaction history response:', response);\r\n      \r\n      if (response.success && response.data) {\r\n        return response.data;\r\n      }\r\n      \r\n      return [];\r\n    } catch (error) {\r\n      console.error('Error getting transaction history:', error);\r\n      return [];\r\n    }\r\n  }, [apiClient, user]);\r\n\r\n  // UPDATE reloadData to use loadAllData properly\r\n  const updateReloadData = useCallback(async () => {\r\n    if (isLoading) {\r\n      debugLog('Already loading, skipping reload');\r\n      return;\r\n    }\r\n    \r\n    setIsLoading(true);\r\n    try {\r\n      await loadAllData();\r\n      // For admin users, also refresh admin actions\r\n      if (user?.role === 'admin' || isAdminUser(user?.username || '')) {\r\n        await fetchAdminActions();\r\n      }\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [loadAllData, isLoading, user, fetchAdminActions]);\r\n\r\n  // Subscription payment via API\r\n  const subscribeToSellerWithPayment = useCallback(async (\r\n    buyer: string,\r\n    seller: string,\r\n    amount: number\r\n  ): Promise<boolean> => {\r\n    try {\r\n      debugLog('Processing subscription via API:', { buyer, seller, amount });\r\n      \r\n      const response = await apiClient.post<any>('/subscriptions/subscribe', {\r\n        seller, \r\n        price: amount\r\n      });\r\n      \r\n      debugLog('Subscription response:', response);\r\n      \r\n      if (response.success) {\r\n        // Refresh buyer balance\r\n        const newBalance = await fetchBalance(buyer);\r\n        if (!isAdminUser(buyer)) {\r\n          setBuyerBalancesState(prev => ({ ...prev, [buyer]: newBalance }));\r\n        }\r\n        return true;\r\n      }\r\n      \r\n      return false;\r\n    } catch (error) {\r\n      console.error('Subscription error:', error);\r\n      return false;\r\n    }\r\n  }, [apiClient, fetchBalance]);\r\n\r\n  // Unsubscribe from seller via API\r\n  const unsubscribeFromSeller = useCallback(async (\r\n    buyer: string,\r\n    seller: string\r\n  ): Promise<boolean> => {\r\n    try {\r\n      debugLog('Processing unsubscribe via API:', { buyer, seller });\r\n      \r\n      const response = await apiClient.post<any>('/subscriptions/unsubscribe', {\r\n        seller\r\n      });\r\n      \r\n      debugLog('Unsubscribe response:', response);\r\n      \r\n      if (response.success) {\r\n        debugLog('Successfully unsubscribed');\r\n        \r\n        // Optionally refresh buyer balance to reflect any changes\r\n        if (buyer === user?.username) {\r\n          const newBalance = await fetchBalance(buyer);\r\n          if (!isAdminUser(buyer)) {\r\n            setBuyerBalancesState(prev => ({ ...prev, [buyer]: newBalance }));\r\n          }\r\n        }\r\n        \r\n        return true;\r\n      }\r\n      \r\n      console.error('[WalletContext] Unsubscribe failed:', response.error);\r\n      return false;\r\n    } catch (error) {\r\n      console.error('[WalletContext] Unsubscribe error:', error);\r\n      return false;\r\n    }\r\n  }, [apiClient, fetchBalance, user]);\r\n\r\n  // Admin withdrawal\r\n  const addAdminWithdrawal = useCallback(async (amount: number) => {\r\n    try {\r\n      debugLog('Processing admin withdrawal from unified platform wallet');\r\n      \r\n      const response = await apiClient.post<any>('/wallet/admin-withdraw', {\r\n        amount,\r\n        accountDetails: {\r\n          accountNumber: '****9999',\r\n          accountType: 'business'\r\n        },\r\n        notes: `Platform withdrawal by ${user?.username}`\r\n      });\r\n      \r\n      if (response.success) {\r\n        const withdrawal: Withdrawal = {\r\n          amount,\r\n          date: new Date().toISOString(),\r\n          status: 'completed',\r\n          method: 'bank_transfer'\r\n        };\r\n        \r\n        setAdminWithdrawals(prev => [...prev, withdrawal]);\r\n        \r\n        // Refresh unified platform balance\r\n        await fetchAdminPlatformBalance();\r\n        \r\n        debugLog('Admin withdrawal successful');\r\n      } else {\r\n        console.error('[WalletContext] Admin withdrawal failed:', response.error);\r\n        throw new Error(response.error?.message || 'Withdrawal failed');\r\n      }\r\n    } catch (error) {\r\n      console.error('[WalletContext] Admin withdrawal error:', error);\r\n      throw error;\r\n    }\r\n  }, [apiClient, fetchAdminPlatformBalance, user]);\r\n\r\n  // Update order address\r\n  const updateOrderAddress = useCallback(async (orderId: string, address: DeliveryAddress) => {\r\n    try {\r\n      debugLog('Updating order address:', orderId);\r\n      \r\n      // Use POST method since ApiClient doesn't have PUT\r\n      const response = await apiClient.post<any>(`/orders/${orderId}/address`, {\r\n        deliveryAddress: address\r\n      });\r\n      \r\n      if (response.success) {\r\n        // Update local order history\r\n        setOrderHistory(prev => prev.map(order => \r\n          order.id === orderId ? { ...order, deliveryAddress: address } : order\r\n        ));\r\n        \r\n        debugLog('Order address updated successfully');\r\n      } else {\r\n        throw new Error(response.error?.message || 'Failed to update address');\r\n      }\r\n    } catch (error) {\r\n      console.error('[WalletContext] Error updating order address:', error);\r\n      throw error;\r\n    }\r\n  }, [apiClient]);\r\n\r\n  // Update shipping status\r\n  const updateShippingStatus = useCallback(async (orderId: string, status: 'pending' | 'processing' | 'shipped') => {\r\n    try {\r\n      debugLog('Updating shipping status:', orderId, status);\r\n      \r\n      // Use POST method since ApiClient doesn't have PUT\r\n      const response = await apiClient.post<any>(`/orders/${orderId}/shipping`, {\r\n        shippingStatus: status\r\n      });\r\n      \r\n      if (response.success) {\r\n        // Update local order history\r\n        setOrderHistory(prev => prev.map(order => \r\n          order.id === orderId ? { ...order, shippingStatus: status } : order\r\n        ));\r\n        \r\n        debugLog('Shipping status updated successfully');\r\n      } else {\r\n        throw new Error(response.error?.message || 'Failed to update shipping status');\r\n      }\r\n    } catch (error) {\r\n      console.error('[WalletContext] Error updating shipping status:', error);\r\n      throw error;\r\n    }\r\n  }, [apiClient]);\r\n\r\n  // Auction-related stubs\r\n  const holdBidFunds = useCallback(async (): Promise<boolean> => {\r\n    debugLog('Auction features not fully implemented in API yet');\r\n    return false;\r\n  }, []);\r\n\r\n  const refundBidFunds = useCallback(async (): Promise<boolean> => {\r\n    debugLog('Auction features not fully implemented in API yet');\r\n    return false;\r\n  }, []);\r\n\r\n  const placeBid = useCallback(async (): Promise<boolean> => {\r\n    debugLog('Auction features not fully implemented in API yet');\r\n    return false;\r\n  }, []);\r\n\r\n  const finalizeAuctionPurchase = useCallback(async (): Promise<boolean> => {\r\n    debugLog('Auction features not fully implemented in API yet');\r\n    return false;\r\n  }, []);\r\n\r\n  // Enhanced features stubs\r\n  const checkSuspiciousActivity = useCallback(async (username: string) => {\r\n    return { suspicious: false, reasons: [] };\r\n  }, []);\r\n\r\n  const reconcileBalance = useCallback(async (username: string, role: 'buyer' | 'seller' | 'admin') => {\r\n    return null;\r\n  }, []);\r\n\r\n  const contextValue: WalletContextType = {\r\n    // Loading state\r\n    isLoading,\r\n    isInitialized,\r\n    initializationError,\r\n    \r\n    // Core functionality\r\n    buyerBalances,\r\n    adminBalance,\r\n    sellerBalances,\r\n    setBuyerBalance,\r\n    getBuyerBalance,\r\n    setAdminBalance,\r\n    setSellerBalance,\r\n    getSellerBalance,\r\n    purchaseListing,\r\n    purchaseCustomRequest,\r\n    subscribeToSellerWithPayment,\r\n    unsubscribeFromSeller,\r\n    orderHistory,\r\n    addOrder,\r\n    sellerWithdrawals,\r\n    adminWithdrawals,\r\n    addSellerWithdrawal,\r\n    addAdminWithdrawal,\r\n    wallet: { ...buyerBalances, ...sellerBalances, admin: adminBalance },\r\n    updateWallet: () => { console.warn('updateWallet is deprecated - use API methods instead'); },\r\n    sendTip,\r\n    setAddSellerNotificationCallback,\r\n    adminCreditUser,\r\n    adminDebitUser,\r\n    adminActions,\r\n    updateOrderAddress,\r\n    updateShippingStatus,\r\n    depositLogs,\r\n    addDeposit,\r\n    getDepositsForUser: (username: string) => depositLogs.filter(log => log.username === username),\r\n    getTotalDeposits: () => depositLogs.reduce((sum, log) => sum + log.amount, 0),\r\n    getDepositsByTimeframe: () => depositLogs,\r\n    \r\n    // Auction methods (stubs for now)\r\n    holdBidFunds,\r\n    refundBidFunds,\r\n    finalizeAuctionPurchase,\r\n    placeBid,\r\n    chargeIncrementalBid: async () => false,\r\n    getAuctionBidders: async () => [],\r\n    cleanupAuctionTracking: async () => {},\r\n    \r\n    // Enhanced features\r\n    checkSuspiciousActivity,\r\n    reconcileBalance,\r\n    getTransactionHistory,\r\n    \r\n    // Admin-specific methods\r\n    refreshAdminData,\r\n    getPlatformTransactions,\r\n    getAnalyticsData,\r\n    \r\n    // Data management - Use the updated function\r\n    reloadData: updateReloadData,\r\n  };\r\n\r\n  return (\r\n    <WalletContext.Provider value={contextValue}>\r\n      {children}\r\n    </WalletContext.Provider>\r\n  );\r\n}\r\n\r\nexport const useWallet = () => {\r\n  const context = useContext(WalletContext);\r\n  if (!context) {\r\n    throw new Error(\"useWallet must be used within a WalletProvider\");\r\n  }\r\n  return context;\r\n};"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4921, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/AuctionContext.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, {\r\n  createContext,\r\n  useContext,\r\n  useState,\r\n  useCallback,\r\n  useEffect,\r\n  useRef,\r\n  ReactNode,\r\n  useMemo,\r\n} from 'react';\r\nimport { useAuth } from './AuthContext';\r\nimport { useWebSocket } from './WebSocketContext';\r\nimport { WebSocketEvent } from '@/types/websocket';\r\nimport { apiCall } from '@/services/api.config';\r\nimport { z } from 'zod';\r\nimport { getRateLimiter } from '@/utils/security/rate-limiter';\r\nimport { isAdmin } from '@/utils/security/permissions';\r\n\r\n// -----------------------------\r\n// Types\r\n// -----------------------------\r\nexport interface Bid {\r\n  id: string;\r\n  bidder: string;\r\n  amount: number;\r\n  timestamp: string;\r\n  isWinning?: boolean;\r\n}\r\n\r\nexport interface AuctionData {\r\n  id: string;\r\n  listingId: string;\r\n  seller: string;\r\n  startingPrice: number;\r\n  reservePrice?: number;\r\n  currentBid: number;\r\n  highestBidder?: string;\r\n  previousBidder?: string;\r\n  endTime: string;\r\n  bids: Bid[];\r\n  status: 'active' | 'ended' | 'cancelled' | 'reserve_not_met';\r\n  winnerId?: string;\r\n  finalPrice?: number;\r\n  reserveMet?: boolean;\r\n}\r\n\r\ninterface AuctionContextType {\r\n  // Auction state\r\n  auctions: Record<string, AuctionData>;\r\n  activeAuctions: AuctionData[];\r\n  userBids: Record<string, Bid[]>;\r\n\r\n  // Auction actions\r\n  placeBid: (listingId: string, bidder: string, amount: number) => Promise<boolean>;\r\n  cancelAuction: (listingId: string) => Promise<boolean>;\r\n  endAuction: (listingId: string) => Promise<boolean>;\r\n  processEndedAuction: (listing: any) => Promise<boolean>;\r\n  getAuctionByListingId: (listingId: string) => AuctionData | null;\r\n  getUserBidsForAuction: (listingId: string, username: string) => Bid[];\r\n  isUserHighestBidder: (listingId: string, username: string) => boolean;\r\n  checkReserveMet: (listingId: string) => boolean;\r\n\r\n  // Loading states\r\n  isPlacingBid: boolean;\r\n  isCancellingAuction: boolean;\r\n  isLoadingAuctions: boolean;\r\n\r\n  // Error handling\r\n  bidError: string | null;\r\n  clearBidError: () => void;\r\n\r\n  // Real-time updates\r\n  subscribeToAuction: (listingId: string) => void;\r\n  unsubscribeFromAuction: (listingId: string) => void;\r\n}\r\n\r\nconst AuctionContext = createContext<AuctionContextType | null>(null);\r\n\r\n// -----------------------------\r\n// Validation Schemas (Zod)\r\n// -----------------------------\r\nconst BidEventSchema = z.object({\r\n  listingId: z.string().min(1).optional(),\r\n  id: z.string().optional(),\r\n  bidder: z.string().min(1).optional(),\r\n  username: z.string().min(1).optional(),\r\n  amount: z.number().finite().nonnegative().optional(),\r\n  bid: z\r\n    .object({\r\n      amount: z.number().finite().nonnegative(),\r\n    })\r\n    .optional(),\r\n  timestamp: z.string().optional(),\r\n});\r\n\r\nconst RefundEventSchema = z.object({\r\n  username: z.string().min(1),\r\n  amount: z.number().finite().nonnegative(),\r\n  listingId: z.string().min(1).optional(),\r\n  balance: z.number().finite().nonnegative().optional(),\r\n  reason: z.string().optional(),\r\n});\r\n\r\nconst BalanceUpdateEventSchema = z.object({\r\n  username: z.string().min(1),\r\n  newBalance: z.number().finite(),\r\n  role: z.string().optional(),\r\n});\r\n\r\nconst AuctionEndedEventSchema = z.object({\r\n  listingId: z.string().optional(),\r\n  id: z.string().optional(),\r\n  status: z.enum(['ended', 'cancelled', 'reserve_not_met']).optional(),\r\n  winnerId: z.string().optional(),\r\n  winner: z.string().optional(),\r\n  finalPrice: z.number().optional(),\r\n  finalBid: z.number().optional(),\r\n});\r\n\r\n// -----------------------------\r\n// Utilities\r\n// -----------------------------\r\nfunction makeBidId() {\r\n  if (typeof crypto !== 'undefined' && 'randomUUID' in crypto) {\r\n    return crypto.randomUUID();\r\n  }\r\n  return `bid_${Date.now()}_${Math.floor(Math.random() * 1e6)}`;\r\n}\r\n\r\nfunction coerceNumber(n: unknown, fallback = 0): number {\r\n  const v = typeof n === 'number' ? n : Number(n);\r\n  return Number.isFinite(v) ? v : fallback;\r\n}\r\n\r\n// Local, safe defaults for bid spam protection\r\nconst BID_LIMIT = {\r\n  maxAttempts: 5,\r\n  windowMs: 10_000,\r\n  blockDuration: 10_000,\r\n};\r\n\r\nexport function AuctionProvider({ children }: { children: ReactNode }) {\r\n  const { user } = useAuth();\r\n\r\n  const wsContext = useWebSocket();\r\n  const subscribe = wsContext?.subscribe || (() => () => {});\r\n  const isConnected = wsContext?.isConnected || false;\r\n\r\n  const [auctions, setAuctions] = useState<Record<string, AuctionData>>({});\r\n  const [userBids, setUserBids] = useState<Record<string, Bid[]>>({});\r\n  const [isPlacingBid, setIsPlacingBid] = useState(false);\r\n  const [isCancellingAuction, setIsCancellingAuction] = useState(false);\r\n  const [isLoadingAuctions, setIsLoadingAuctions] = useState(false);\r\n  const [bidError, setBidError] = useState<string | null>(null);\r\n\r\n  // Keep a ref to latest auctions to avoid effect dependency churn\r\n  const auctionsRef = useRef(auctions);\r\n  useEffect(() => {\r\n    auctionsRef.current = auctions;\r\n  }, [auctions]);\r\n\r\n  const activeAuctions = useMemo(\r\n    () => Object.values(auctions).filter((a) => a.status === 'active'),\r\n    [auctions]\r\n  );\r\n\r\n  const clearBidError = useCallback(() => {\r\n    setBidError(null);\r\n  }, []);\r\n\r\n  const refreshCurrentUserBalance = useCallback(async () => {\r\n    if (!user) return;\r\n\r\n    try {\r\n      const response = await apiCall<any>(`/wallet/balance/${user.username}`, {\r\n        method: 'GET',\r\n      });\r\n\r\n      if (response.success && response.data) {\r\n        const newBalance = response.data.balance || 0;\r\n\r\n        if (typeof window !== 'undefined') {\r\n          console.log(`[AuctionContext] Current user balance updated: $${newBalance}`);\r\n\r\n          window.dispatchEvent(\r\n            new CustomEvent('wallet:balance_update', {\r\n              detail: {\r\n                username: user.username,\r\n                role: user.role,\r\n                balance: newBalance,\r\n                newBalance: newBalance,\r\n                timestamp: Date.now(),\r\n              },\r\n            })\r\n          );\r\n\r\n          const roleEvent =\r\n            user.role === 'buyer' ? 'wallet:buyer-balance-updated' : 'wallet:seller-balance-updated';\r\n          window.dispatchEvent(\r\n            new CustomEvent(roleEvent, {\r\n              detail: {\r\n                username: user.username,\r\n                balance: newBalance,\r\n                timestamp: Date.now(),\r\n              },\r\n            })\r\n          );\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(`[AuctionContext] Error refreshing current user balance:`, error);\r\n    }\r\n  }, [user]);\r\n\r\n  const updateAuctionWithBid = useCallback((listingId: string, rawData: unknown) => {\r\n    const parsed = BidEventSchema.safeParse(rawData);\r\n    if (!parsed.success) {\r\n      console.warn('[AuctionContext] Ignoring malformed bid event', parsed.error?.flatten());\r\n      return undefined as unknown as string | undefined;\r\n    }\r\n    const data = parsed.data;\r\n\r\n    const amount =\r\n      typeof data.amount === 'number'\r\n        ? data.amount\r\n        : coerceNumber(data.bid?.amount, 0);\r\n\r\n    const bidder = (data.bidder || data.username || '').trim();\r\n    if (!listingId || !bidder || !Number.isFinite(amount)) {\r\n      console.warn('[AuctionContext] Incomplete bid payload; skipping update');\r\n      return undefined as unknown as string | undefined;\r\n    }\r\n\r\n    const bid: Bid = {\r\n      id: makeBidId(),\r\n      bidder,\r\n      amount,\r\n      timestamp: data.timestamp || new Date().toISOString(),\r\n      isWinning: true,\r\n    };\r\n\r\n    console.log('[AuctionContext] Processing bid update:', { listingId, bid });\r\n\r\n    let previousHighestBidder: string | undefined;\r\n\r\n    setAuctions((prev) => {\r\n      const existingAuction = prev[listingId];\r\n      previousHighestBidder = existingAuction?.highestBidder;\r\n\r\n      const reserveMet = existingAuction?.reservePrice\r\n        ? bid.amount >= existingAuction.reservePrice\r\n        : true;\r\n\r\n      return {\r\n        ...prev,\r\n        [listingId]: {\r\n          ...existingAuction,\r\n          listingId,\r\n          id: listingId,\r\n          seller: existingAuction?.seller || '',\r\n          startingPrice: existingAuction?.startingPrice || 0,\r\n          reservePrice: existingAuction?.reservePrice,\r\n          currentBid: bid.amount,\r\n          highestBidder: bid.bidder,\r\n          previousBidder: previousHighestBidder,\r\n          endTime: existingAuction?.endTime || '',\r\n          status: existingAuction?.status || 'active',\r\n          reserveMet,\r\n          bids: [...(existingAuction?.bids || []), bid].sort((a, b) => b.amount - a.amount),\r\n        },\r\n      };\r\n    });\r\n\r\n    setUserBids((prev) => ({\r\n      ...prev,\r\n      [bid.bidder]: [...(prev[bid.bidder] || []), bid],\r\n    }));\r\n\r\n    return previousHighestBidder;\r\n  }, []);\r\n\r\n  const updateAuctionStatus = useCallback(\r\n    (\r\n      listingId: string,\r\n      status: 'ended' | 'cancelled' | 'reserve_not_met',\r\n      winnerId?: string,\r\n      finalPrice?: number\r\n    ) => {\r\n      setAuctions((prev) => {\r\n        const existingAuction = prev[listingId];\r\n\r\n        return {\r\n          ...prev,\r\n          [listingId]: {\r\n            ...existingAuction,\r\n            listingId,\r\n            id: listingId,\r\n            seller: existingAuction?.seller || '',\r\n            startingPrice: existingAuction?.startingPrice || 0,\r\n            reservePrice: existingAuction?.reservePrice,\r\n            currentBid: existingAuction?.currentBid || 0,\r\n            endTime: existingAuction?.endTime || '',\r\n            bids: existingAuction?.bids || [],\r\n            status,\r\n            ...(winnerId && { winnerId }),\r\n            ...(typeof finalPrice === 'number' && Number.isFinite(finalPrice) && { finalPrice }),\r\n            reserveMet: status === 'reserve_not_met' ? false : existingAuction?.reserveMet,\r\n          },\r\n        };\r\n      });\r\n    },\r\n    []\r\n  );\r\n\r\n  const checkReserveMet = useCallback(\r\n    (listingId: string): boolean => {\r\n      const auction = auctions[listingId];\r\n      if (!auction || !auction.reservePrice) return true;\r\n      return auction.currentBid >= auction.reservePrice;\r\n    },\r\n    [auctions]\r\n  );\r\n\r\n  // Initial load (kept minimal; extend if needed)\r\n  useEffect(() => {\r\n    const loadAuctions = async () => {\r\n      if (!user) return;\r\n\r\n      setIsLoadingAuctions(true);\r\n      try {\r\n        console.log('[AuctionContext] Loading auctions...');\r\n        // (Intentionally left without fetching to avoid regressions)\r\n      } catch (error) {\r\n        console.error('[AuctionContext] Error loading auctions:', error);\r\n      } finally {\r\n        setIsLoadingAuctions(false);\r\n      }\r\n    };\r\n\r\n    loadAuctions();\r\n  }, [user]);\r\n\r\n  // WebSocket subscriptions (stabilized: no dependency on auctions state)\r\n  useEffect(() => {\r\n    if (!isConnected || !subscribe) return;\r\n\r\n    const unsubscribers: Array<() => void> = [];\r\n\r\n    // New bid\r\n    unsubscribers.push(\r\n      subscribe(WebSocketEvent.AUCTION_BID, async (raw: unknown) => {\r\n        const parsed = BidEventSchema.safeParse(raw);\r\n        if (!parsed.success) {\r\n          console.warn('[AuctionContext] Ignoring malformed AUCTION_BID', parsed.error?.flatten());\r\n          return;\r\n        }\r\n        const data = parsed.data;\r\n        const listingId = (data.listingId || data.id || '').toString();\r\n        if (!listingId) return;\r\n\r\n        updateAuctionWithBid(listingId, data);\r\n\r\n        if (user && (data.bidder === user.username || data.username === user.username)) {\r\n          await refreshCurrentUserBalance();\r\n        }\r\n      })\r\n    );\r\n\r\n    // Wallet refund\r\n    unsubscribers.push(\r\n      subscribe('wallet:refund' as WebSocketEvent, async (raw: unknown) => {\r\n        const parsed = RefundEventSchema.safeParse(raw);\r\n        if (!parsed.success) {\r\n          console.warn('[AuctionContext] Ignoring malformed wallet:refund', parsed.error?.flatten());\r\n          return;\r\n        }\r\n        const data = parsed.data;\r\n\r\n        if (user && data.username === user.username) {\r\n          console.log('[AuctionContext] Current user was refunded, refreshing balance');\r\n          await refreshCurrentUserBalance();\r\n\r\n          if (typeof window !== 'undefined') {\r\n            window.dispatchEvent(\r\n              new CustomEvent('wallet:user-refunded', {\r\n                detail: {\r\n                  username: user.username,\r\n                  amount: data.amount,\r\n                  listingId: data.listingId,\r\n                  balance: data.balance,\r\n                  reason: data.reason,\r\n                  timestamp: Date.now(),\r\n                },\r\n              })\r\n            );\r\n          }\r\n        }\r\n      })\r\n    );\r\n\r\n    // Balance update passthrough (dedupe + fan-out)\r\n    unsubscribers.push(\r\n      subscribe('wallet:balance_update' as WebSocketEvent, async (raw: unknown) => {\r\n        const parsed = BalanceUpdateEventSchema.safeParse(raw);\r\n        if (!parsed.success) {\r\n          console.warn('[AuctionContext] Ignoring malformed wallet:balance_update', parsed.error?.flatten());\r\n          return;\r\n        }\r\n        const data = parsed.data;\r\n\r\n        if (user && data.username === user.username && typeof data.newBalance === 'number') {\r\n          if (typeof window !== 'undefined') {\r\n            window.dispatchEvent(\r\n              new CustomEvent('wallet:balance_update', {\r\n                detail: {\r\n                  username: user.username,\r\n                  role: user.role,\r\n                  balance: data.newBalance,\r\n                  newBalance: data.newBalance,\r\n                  timestamp: Date.now(),\r\n                },\r\n              })\r\n            );\r\n\r\n            const roleEvent =\r\n              user.role === 'buyer'\r\n                ? 'wallet:buyer-balance-updated'\r\n                : 'wallet:seller-balance-updated';\r\n            window.dispatchEvent(\r\n              new CustomEvent(roleEvent, {\r\n                detail: {\r\n                  username: user.username,\r\n                  balance: data.newBalance,\r\n                  timestamp: Date.now(),\r\n                },\r\n              })\r\n            );\r\n\r\n            window.dispatchEvent(\r\n              new CustomEvent('auction:check-bid-status', {\r\n                detail: {\r\n                  username: user.username,\r\n                  balance: data.newBalance,\r\n                  timestamp: Date.now(),\r\n                },\r\n              })\r\n            );\r\n          }\r\n        }\r\n      })\r\n    );\r\n\r\n    // Outbid notice (no-op other than logging for now)\r\n    unsubscribers.push(\r\n      subscribe('auction:outbid' as WebSocketEvent, async (data: any) => {\r\n        console.log('[AuctionContext] User was outbid:', data);\r\n        if (user && data?.username === user.username) {\r\n          console.log('[AuctionContext] Current user was outbid on', data?.listingTitle);\r\n        }\r\n      })\r\n    );\r\n\r\n    // Auction ended\r\n    unsubscribers.push(\r\n      subscribe(WebSocketEvent.AUCTION_ENDED, async (raw: unknown) => {\r\n        const parsed = AuctionEndedEventSchema.safeParse(raw);\r\n        if (!parsed.success) {\r\n          console.warn('[AuctionContext] Ignoring malformed AUCTION_ENDED', parsed.error?.flatten());\r\n          return;\r\n        }\r\n        const data = parsed.data;\r\n\r\n        const listingId = (data.listingId || data.id || '').toString();\r\n        if (!listingId) return;\r\n\r\n        const status = data.status || 'ended';\r\n\r\n        if (status === 'reserve_not_met') {\r\n          updateAuctionStatus(listingId, 'reserve_not_met');\r\n\r\n          const auction = auctionsRef.current[listingId];\r\n          if (user && auction?.highestBidder === user.username) {\r\n            console.log('[AuctionContext] Reserve not met, user will be refunded');\r\n          }\r\n        } else {\r\n          const winner = data.winnerId || data.winner;\r\n          const final =\r\n            typeof data.finalPrice === 'number'\r\n              ? data.finalPrice\r\n              : typeof data.finalBid === 'number'\r\n              ? data.finalBid\r\n              : undefined;\r\n\r\n          updateAuctionStatus(listingId, 'ended', winner, final);\r\n\r\n          if (user && winner === user.username) {\r\n            await refreshCurrentUserBalance();\r\n          }\r\n        }\r\n      })\r\n    );\r\n\r\n    // Reserve not met\r\n    unsubscribers.push(\r\n      subscribe('auction:reserve_not_met' as WebSocketEvent, async (raw: unknown) => {\r\n        const parsed = AuctionEndedEventSchema.safeParse(raw);\r\n        if (!parsed.success) {\r\n          console.warn('[AuctionContext] Ignoring malformed auction:reserve_not_met', parsed.error?.flatten());\r\n          return;\r\n        }\r\n        const data = parsed.data;\r\n\r\n        const listingId = (data.listingId || data.id || '').toString();\r\n        if (!listingId) return;\r\n\r\n        updateAuctionStatus(listingId, 'reserve_not_met');\r\n\r\n        const auction = auctionsRef.current[listingId];\r\n        if (user && auction?.highestBidder === user.username) {\r\n          console.log('[AuctionContext] User was highest bidder, awaiting refund for reserve not met');\r\n        }\r\n      })\r\n    );\r\n\r\n    // Cancelled\r\n    unsubscribers.push(\r\n      subscribe(WebSocketEvent.AUCTION_CANCELLED, async (raw: unknown) => {\r\n        const parsed = AuctionEndedEventSchema.safeParse(raw);\r\n        if (!parsed.success) {\r\n          console.warn('[AuctionContext] Ignoring malformed AUCTION_CANCELLED', parsed.error?.flatten());\r\n          return;\r\n        }\r\n        const data = parsed.data;\r\n\r\n        const listingId = (data.listingId || data.id || '').toString();\r\n        if (!listingId) return;\r\n\r\n        const auction = auctionsRef.current[listingId];\r\n        updateAuctionStatus(listingId, 'cancelled');\r\n\r\n        if (user && auction?.highestBidder === user.username) {\r\n          await refreshCurrentUserBalance();\r\n        }\r\n      })\r\n    );\r\n\r\n    return () => {\r\n      unsubscribers.forEach((unsub) => {\r\n        try {\r\n          unsub();\r\n        } catch {\r\n          // swallow teardown errors\r\n        }\r\n      });\r\n    };\r\n  }, [isConnected, subscribe, updateAuctionWithBid, updateAuctionStatus, refreshCurrentUserBalance, user]);\r\n\r\n  const placeBid = useCallback(\r\n    async (listingId: string, bidder: string, amount: number): Promise<boolean> => {\r\n      if (!user) {\r\n        setBidError('You must be logged in to bid');\r\n        return false;\r\n      }\r\n\r\n      // Gentle client-side rate limit against spam clicks\r\n      try {\r\n        const limiter = getRateLimiter(); // no args\r\n        const key = `auction:bid:${user.username}`;\r\n        limiter.check(key, {\r\n          maxAttempts: BID_LIMIT.maxAttempts,\r\n          windowMs: BID_LIMIT.windowMs,\r\n          blockDuration: BID_LIMIT.blockDuration,\r\n        });\r\n      } catch {\r\n        setBidError('Too many bid attempts. Please wait a moment.');\r\n        return false;\r\n      }\r\n\r\n      // Coerce & validate amount\r\n      const amt = coerceNumber(amount, NaN);\r\n      if (!Number.isFinite(amt) || amt < 0) {\r\n        setBidError('Invalid bid amount');\r\n        return false;\r\n      }\r\n\r\n      // Ensure bidder matches logged-in user (UI safety)\r\n      if (bidder && user.username && bidder !== user.username) {\r\n        console.warn('[AuctionContext] Bidder mismatch; normalizing to current user');\r\n      }\r\n\r\n      setIsPlacingBid(true);\r\n      setBidError(null);\r\n\r\n      try {\r\n        const response = await apiCall<any>(`/listings/${listingId}/bid`, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ amount: amt }),\r\n        });\r\n\r\n        if (response.success) {\r\n          console.log('[AuctionContext] Bid placed successfully:', response.data?.message || 'Success');\r\n\r\n          updateAuctionWithBid(listingId, {\r\n            bidder: user.username,\r\n            amount: amt,\r\n            timestamp: new Date().toISOString(),\r\n          });\r\n\r\n          const auction = auctionsRef.current[listingId];\r\n          if (auction?.reservePrice && amt < auction.reservePrice) {\r\n            console.log('[AuctionContext] Bid placed but reserve price not yet met');\r\n          }\r\n\r\n          await refreshCurrentUserBalance();\r\n\r\n          return true;\r\n        } else {\r\n          const errorMsg =\r\n            typeof response.error === 'string'\r\n              ? response.error\r\n              : response.error?.message || 'Failed to place bid';\r\n          setBidError(errorMsg);\r\n          console.error('[AuctionContext] Bid failed:', errorMsg);\r\n          return false;\r\n        }\r\n      } catch (error: any) {\r\n        const errorMsg = error?.message || 'Network error while placing bid';\r\n        setBidError(errorMsg);\r\n        console.error('[AuctionContext] Bid error:', error);\r\n        return false;\r\n      } finally {\r\n        setIsPlacingBid(false);\r\n      }\r\n    },\r\n    [user, updateAuctionWithBid, refreshCurrentUserBalance]\r\n  );\r\n\r\n  const cancelAuction = useCallback(\r\n    async (listingId: string): Promise<boolean> => {\r\n      if (!user) return false;\r\n\r\n      setIsCancellingAuction(true);\r\n\r\n      try {\r\n        const response = await apiCall<any>(`/listings/${listingId}/cancel-auction`, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n        });\r\n\r\n        if (response.success) {\r\n          return true;\r\n        } else {\r\n          console.error('[AuctionContext] Cancel auction failed:', response.error);\r\n          return false;\r\n        }\r\n      } catch (error: any) {\r\n        console.error('[AuctionContext] Cancel auction error:', error);\r\n        return false;\r\n      } finally {\r\n        setIsCancellingAuction(false);\r\n      }\r\n    },\r\n    [user]\r\n  );\r\n\r\n  const endAuction = useCallback(\r\n    async (listingId: string): Promise<boolean> => {\r\n      if (!user || !isAdmin(user)) {\r\n        return false;\r\n      }\r\n\r\n      try {\r\n        const response = await apiCall<any>(`/listings/${listingId}/end-auction`, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n        });\r\n\r\n        if (response.success) {\r\n          return true;\r\n        } else {\r\n          console.error('[AuctionContext] End auction failed:', response.error);\r\n          return false;\r\n        }\r\n      } catch (error: any) {\r\n        console.error('[AuctionContext] End auction error:', error);\r\n        return false;\r\n      }\r\n    },\r\n    [user]\r\n  );\r\n\r\n  // Process ended auction - handle already processed auctions gracefully\r\n  const processEndedAuction = useCallback(\r\n    async (listing: any): Promise<boolean> => {\r\n      if (!listing?.auction) return false;\r\n\r\n      try {\r\n        // Call backend to process auction completion\r\n        const response = await apiCall<any>(`/listings/${listing.id}/end-auction`, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n        });\r\n\r\n        if (response.success) {\r\n          // Check if it was already processed (backend returns success with alreadyProcessed flag)\r\n          const alreadyProcessed =\r\n            response.data?.alreadyProcessed ||\r\n            response.data?.data?.alreadyProcessed ||\r\n            false;\r\n\r\n          if (alreadyProcessed) {\r\n            console.log('[AuctionContext] Auction was already processed:', response.data?.status);\r\n\r\n            // Update status based on the already-processed status\r\n            const status =\r\n              response.data?.status || response.data?.data?.status || 'ended';\r\n            if (status === 'reserve_not_met') {\r\n              updateAuctionStatus(listing.id, 'reserve_not_met');\r\n            } else if (listing.auction.highestBidder && listing.auction.highestBid) {\r\n              updateAuctionStatus(\r\n                listing.id,\r\n                'ended',\r\n                listing.auction.highestBidder,\r\n                listing.auction.highestBid\r\n              );\r\n            } else {\r\n              updateAuctionStatus(listing.id, 'ended');\r\n            }\r\n\r\n            return true; // handled\r\n          }\r\n\r\n          // Process the response data\r\n          const responseData = response.data || {};\r\n\r\n          // Check if order was created successfully\r\n          const order = responseData.order || responseData.data?.order;\r\n          if (order) {\r\n            console.log('[AuctionContext] Order created successfully:', order);\r\n\r\n            // Fire event for order creation\r\n            if (typeof window !== 'undefined') {\r\n              window.dispatchEvent(\r\n                new CustomEvent('order:created', {\r\n                  detail: { order },\r\n                })\r\n              );\r\n            }\r\n          }\r\n\r\n          // Update status based on response\r\n          const status = responseData.status || responseData.data?.status || 'ended';\r\n          if (status === 'reserve_not_met') {\r\n            updateAuctionStatus(listing.id, 'reserve_not_met');\r\n          } else if (listing.auction.highestBidder && listing.auction.highestBid) {\r\n            updateAuctionStatus(\r\n              listing.id,\r\n              'ended',\r\n              listing.auction.highestBidder,\r\n              listing.auction.highestBid\r\n            );\r\n          } else {\r\n            updateAuctionStatus(listing.id, 'ended');\r\n          }\r\n\r\n          return true;\r\n        }\r\n\r\n        // Error path: treat known messages as already-processed\r\n        const msg =\r\n          (typeof response.error === 'string'\r\n            ? response.error\r\n            : response.error?.message || ''\r\n          ).toLowerCase();\r\n\r\n        if (\r\n          msg.includes('auction is not active') ||\r\n          msg.includes('already processed') ||\r\n          msg.includes('auction already processed')\r\n        ) {\r\n          console.log('[AuctionContext] Auction already processed, treating as success');\r\n          updateAuctionStatus(listing.id, 'ended');\r\n          return true;\r\n        }\r\n\r\n        console.error('[AuctionContext] Failed to process ended auction:', response.error);\r\n        return false;\r\n      } catch (error: any) {\r\n        const msg = (error?.message || '').toLowerCase();\r\n        if (\r\n          msg.includes('auction is not active') ||\r\n          msg.includes('already processed') ||\r\n          msg.includes('auction already processed')\r\n        ) {\r\n          console.log('[AuctionContext] Auction already processed (from catch), treating as success');\r\n          updateAuctionStatus(listing.id, 'ended');\r\n          return true;\r\n        }\r\n\r\n        console.error('[AuctionContext] Error processing ended auction:', error);\r\n        return false;\r\n      }\r\n    },\r\n    [updateAuctionStatus]\r\n  );\r\n\r\n  const getAuctionByListingId = useCallback(\r\n    (listingId: string): AuctionData | null => auctions[listingId] || null,\r\n    [auctions]\r\n  );\r\n\r\n  const getUserBidsForAuction = useCallback(\r\n    (listingId: string, username: string): Bid[] => {\r\n      const auction = auctions[listingId];\r\n      if (!auction) return [];\r\n      return auction.bids.filter((bid) => bid.bidder === username);\r\n    },\r\n    [auctions]\r\n  );\r\n\r\n  const isUserHighestBidder = useCallback(\r\n    (listingId: string, username: string): boolean => {\r\n      const auction = auctions[listingId];\r\n      return auction?.highestBidder === username;\r\n    },\r\n    [auctions]\r\n  );\r\n\r\n  const subscribeToAuction = useCallback(\r\n    (listingId: string) => {\r\n      if (!isConnected) return;\r\n      console.log('[AuctionContext] Subscribing to auction:', listingId);\r\n      // Hook for future: if your WS supports rooms, join here.\r\n    },\r\n    [isConnected]\r\n  );\r\n\r\n  const unsubscribeFromAuction = useCallback(\r\n    (listingId: string) => {\r\n      if (!isConnected) return;\r\n      console.log('[AuctionContext] Unsubscribing from auction:', listingId);\r\n      // Hook for future: if your WS supports rooms, leave here.\r\n    },\r\n    [isConnected]\r\n  );\r\n\r\n  const value: AuctionContextType = {\r\n    auctions,\r\n    activeAuctions,\r\n    userBids,\r\n    placeBid,\r\n    cancelAuction,\r\n    endAuction,\r\n    processEndedAuction,\r\n    getAuctionByListingId,\r\n    getUserBidsForAuction,\r\n    isUserHighestBidder,\r\n    checkReserveMet,\r\n    isPlacingBid,\r\n    isCancellingAuction,\r\n    isLoadingAuctions,\r\n    bidError,\r\n    clearBidError,\r\n    subscribeToAuction,\r\n    unsubscribeFromAuction,\r\n  };\r\n\r\n  return <AuctionContext.Provider value={value}>{children}</AuctionContext.Provider>;\r\n}\r\n\r\nexport function useAuction() {\r\n  const context = useContext(AuctionContext);\r\n  if (!context) {\r\n    throw new Error('useAuction must be used within AuctionProvider');\r\n  }\r\n  return context;\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 5705, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/ListingContext.tsx"],"sourcesContent":["// src/context/ListingContext.tsx\r\n'use client';\r\n\r\nimport {\r\n  createContext,\r\n  useContext,\r\n  useState,\r\n  useEffect,\r\n  ReactNode,\r\n  useCallback,\r\n  useRef,\r\n} from 'react';\r\nimport { useWallet } from './WalletContext';\r\nimport { useAuth } from './AuthContext';\r\nimport { useAuction } from './AuctionContext';\r\nimport { useWebSocket } from './WebSocketContext';\r\nimport { WebSocketEvent } from '@/types/websocket';\r\nimport type { Order } from '@/types/order';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { listingsService, usersService, storageService } from '@/services';\r\nimport { ListingDraft } from '@/types/myListings';\r\nimport { securityService, sanitize } from '@/services/security.service';\r\nimport { listingSchemas } from '@/utils/validation/schemas';\r\n\r\nexport type Role = 'buyer' | 'seller' | 'admin';\r\n\r\nexport type VerificationStatus = 'unverified' | 'pending' | 'verified' | 'rejected';\r\n\r\nexport type VerificationDocs = {\r\n  codePhoto?: string;\r\n  idFront?: string;\r\n  idBack?: string;\r\n  passport?: string;\r\n  code?: string;\r\n};\r\n\r\nexport type Bid = {\r\n  id: string;\r\n  bidder: string;\r\n  amount: number;\r\n  date: string;\r\n};\r\n\r\nexport type AuctionStatus = 'active' | 'ended' | 'cancelled' | 'reserve_not_met';\r\n\r\nexport type AuctionSettings = {\r\n  isAuction: boolean;\r\n  startingPrice: number;\r\n  reservePrice?: number;\r\n  endTime: string;\r\n  bids: Bid[];\r\n  highestBid?: number;\r\n  highestBidder?: string;\r\n  status: AuctionStatus;\r\n  minimumIncrement?: number;\r\n};\r\n\r\nexport type Listing = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  price: number;\r\n  markedUpPrice: number;\r\n  imageUrls: string[];\r\n  date: string;\r\n  seller: string;\r\n\r\n  isVerified?: boolean;\r\n  isPremium?: boolean;\r\n  isLocked?: boolean;  // ADDED: Support for server-side premium content locking\r\n  tags?: string[];\r\n  hoursWorn?: number;\r\n  views?: number;\r\n  \r\n  auction?: AuctionSettings;\r\n};\r\n\r\nexport type NewListingInput = Omit<Listing, 'id' | 'date' | 'markedUpPrice'>;\r\nexport type AddListingInput = Omit<Listing, 'id' | 'date' | 'markedUpPrice'>;\r\n\r\nexport type AuctionInput = {\r\n  startingPrice: number;\r\n  reservePrice?: number;\r\n  endTime: string;\r\n};\r\n\r\nexport type Notification = {\r\n  id: string;\r\n  message: string;\r\n  timestamp: string;\r\n  cleared: boolean;\r\n};\r\n\r\nexport type NotificationItem = string | Notification;\r\n\r\ntype NotificationStore = Record<string, NotificationItem[]>;\r\n\r\n// Add subscription details interface\r\ninterface SubscriptionData {\r\n  seller: string;\r\n  price: number;\r\n  subscribedAt: string;\r\n}\r\n\r\n// FIX 2: Add deduplication manager for sold listings\r\nclass SoldListingDeduplicationManager {\r\n  private processedListings: Map<string, number> = new Map();\r\n  private cleanupInterval: NodeJS.Timeout | null = null;\r\n  private expiryMs: number;\r\n\r\n  constructor(expiryMs: number = 60000) { // 60 second expiry for sold listings\r\n    this.expiryMs = expiryMs;\r\n    this.startCleanup();\r\n  }\r\n\r\n  private startCleanup() {\r\n    this.cleanupInterval = setInterval(() => {\r\n      const now = Date.now();\r\n      const expiredKeys: string[] = [];\r\n      \r\n      this.processedListings.forEach((timestamp, listingId) => {\r\n        if (now - timestamp > this.expiryMs) {\r\n          expiredKeys.push(listingId);\r\n        }\r\n      });\r\n      \r\n      expiredKeys.forEach(key => this.processedListings.delete(key));\r\n    }, 30000); // Cleanup every 30 seconds\r\n  }\r\n\r\n  isDuplicate(listingId: string): boolean {\r\n    if (this.processedListings.has(listingId)) {\r\n      return true;\r\n    }\r\n    \r\n    this.processedListings.set(listingId, Date.now());\r\n    return false;\r\n  }\r\n\r\n  destroy() {\r\n    if (this.cleanupInterval) {\r\n      clearInterval(this.cleanupInterval);\r\n      this.cleanupInterval = null;\r\n    }\r\n    this.processedListings.clear();\r\n  }\r\n}\r\n\r\ntype ListingContextType = {\r\n  isAuthReady: boolean;\r\n  listings: Listing[];\r\n  addListing: (listing: AddListingInput) => Promise<void>;\r\n  addAuctionListing: (listing: AddListingInput, auctionSettings: AuctionInput) => Promise<void>;\r\n  removeListing: (id: string) => Promise<void>;\r\n  updateListing: (id: string, updatedListing: Partial<Omit<Listing, 'id' | 'date' | 'markedUpPrice'>>) => Promise<void>;\r\n  purchaseListingAndRemove: (listing: Listing, buyerUsername: string) => Promise<boolean>;\r\n  \r\n  // Auction functions\r\n  placeBid: (listingId: string, bidder: string, amount: number) => Promise<boolean>;\r\n  getAuctionListings: () => Listing[];\r\n  getActiveAuctions: () => Listing[];\r\n  getEndedAuctions: () => Listing[];\r\n  checkEndedAuctions: () => Promise<void>;\r\n  cancelAuction: (listingId: string) => Promise<boolean>;\r\n  \r\n  // Draft functions\r\n  saveDraft: (draft: ListingDraft) => Promise<boolean>;\r\n  getDrafts: () => Promise<ListingDraft[]>;\r\n  deleteDraft: (draftId: string) => Promise<boolean>;\r\n  \r\n  // Image functions\r\n  uploadImage: (file: File) => Promise<string | null>;\r\n  deleteImage: (imageUrl: string) => Promise<boolean>;\r\n  \r\n  subscriptions: { [buyer: string]: string[] };\r\n  subscribeToSeller: (buyer: string, seller: string, price: number) => Promise<boolean>;\r\n  unsubscribeFromSeller: (buyer: string, seller: string) => Promise<void>;\r\n  isSubscribed: (buyer: string, seller: string) => boolean;\r\n  \r\n  // Updated notification system\r\n  sellerNotifications: Notification[];\r\n  addSellerNotification: (seller: string, message: string) => void;\r\n  clearSellerNotification: (notificationId: string | number) => void;\r\n  restoreSellerNotification: (notificationId: string) => void;\r\n  permanentlyDeleteSellerNotification: (notificationId: string) => void;\r\n\r\n  requestVerification: (docs: VerificationDocs) => Promise<void>;\r\n  setVerificationStatus: (username: string, status: VerificationStatus, rejectionReason?: string) => Promise<void>;\r\n  \r\n  users: { [username: string]: any };\r\n  \r\n  orderHistory: Order[];\r\n  latestOrder: Order | null;\r\n  \r\n  // Loading and error states\r\n  isLoading: boolean;\r\n  error: string | null;\r\n  refreshListings: () => Promise<void>;\r\n};\r\n\r\nconst ListingContext = createContext<ListingContextType | undefined>(undefined);\r\n\r\nexport const ListingProvider: React.FC<{ children: ReactNode }> = ({ children }) => {\r\n  const { user, updateUser } = useAuth();\r\n  const webSocketContext = useWebSocket();\r\n  \r\n  // Extract properties from WebSocket context safely\r\n  const subscribe = webSocketContext?.subscribe;\r\n  const isConnected = webSocketContext?.isConnected || false;\r\n  \r\n  const [users, setUsers] = useState<{ [username: string]: any }>({});\r\n  const [listings, setListings] = useState<Listing[]>([]);\r\n  const [subscriptions, setSubscriptions] = useState<{ [buyer: string]: string[] }>({});\r\n  const [notificationStore, setNotificationStore] = useState<NotificationStore>({});\r\n  const [isAuthReady, setIsAuthReady] = useState(false);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [latestOrder, setLatestOrder] = useState<Order | null>(null);\r\n\r\n  // FIX 2: Add ref for deduplication manager\r\n  const soldListingDeduplicator = useRef(new SoldListingDeduplicationManager());\r\n  \r\n  // Add deduplication mechanism for listing updates\r\n  const listingUpdateDeduplicator = useRef(new Map<string, number>());\r\n  const DEBOUNCE_TIME = 500; // 500ms debounce\r\n  \r\n  // Add request deduplication for API calls\r\n  const apiRequestCache = useRef(new Map<string, { timestamp: number; promise: Promise<any> }>());\r\n  const API_CACHE_TIME = 1000; // Cache API responses for 1 second\r\n\r\n  // Helper function to normalize notification items to the new format\r\n  const normalizeNotification = (item: NotificationItem): Notification => {\r\n    if (typeof item === 'string') {\r\n      return {\r\n        id: uuidv4(),\r\n        message: sanitize.strict(item), // Sanitize message\r\n        timestamp: new Date().toISOString(),\r\n        cleared: false\r\n      };\r\n    }\r\n    return {\r\n      ...item,\r\n      message: sanitize.strict(item.message) // Sanitize message\r\n    };\r\n  };\r\n\r\n  // Helper function to save notification store\r\n  const saveNotificationStore = async (store: NotificationStore) => {\r\n    await storageService.setItem('seller_notifications_store', store);\r\n  };\r\n\r\n  // Memoized notification function to avoid infinite render loop\r\n  const addSellerNotification = useCallback((seller: string, message: string) => {\r\n    if (!seller) {\r\n      console.warn(\"Attempted to add notification without seller ID\");\r\n      return;\r\n    }\r\n    \r\n    // Sanitize the notification message\r\n    const sanitizedMessage = sanitize.strict(message);\r\n    \r\n    const newNotification: Notification = {\r\n      id: uuidv4(),\r\n      message: sanitizedMessage,\r\n      timestamp: new Date().toISOString(),\r\n      cleared: false\r\n    };\r\n    \r\n    setNotificationStore(prev => {\r\n      const sellerNotifications = prev[seller] || [];\r\n      const updated = {\r\n        ...prev,\r\n        [seller]: [...sellerNotifications, newNotification]\r\n      };\r\n      saveNotificationStore(updated);\r\n      return updated;\r\n    });\r\n  }, []);\r\n\r\n  const { \r\n    subscribeToSellerWithPayment, \r\n    setAddSellerNotificationCallback, \r\n    purchaseListing, \r\n    orderHistory,\r\n    unsubscribeFromSeller: walletUnsubscribeFromSeller\r\n  } = useWallet();\r\n\r\n  // Get auction functions from AuctionContext\r\n  const {\r\n    placeBid: auctionPlaceBid,\r\n    cancelAuction: auctionCancelAuction,\r\n    processEndedAuction\r\n  } = useAuction();\r\n\r\n  // On mount, set the notification callback in WalletContext\r\n  useEffect(() => {\r\n    if (setAddSellerNotificationCallback) {\r\n      setAddSellerNotificationCallback(addSellerNotification);\r\n    }\r\n  }, [setAddSellerNotificationCallback, addSellerNotification]);\r\n\r\n  // FIX: Optimized WebSocket subscription with debouncing\r\n  useEffect(() => {\r\n    if (!isConnected || !subscribe) return;\r\n\r\n    console.log('[ListingContext] Setting up WebSocket subscription for listing:sold events');\r\n\r\n    const unsubscribe = subscribe('listing:sold' as WebSocketEvent, (data: { listingId?: string; id?: string }) => {\r\n      console.log('[ListingContext] Received listing:sold event:', data);\r\n      \r\n      // Handle both possible field names for the listing ID\r\n      const id = data.listingId ?? data.id;\r\n      if (!id) {\r\n        console.error('[ListingContext] No listing ID in sold event:', data);\r\n        return;\r\n      }\r\n      \r\n      // Debounce duplicate events\r\n      const now = Date.now();\r\n      const lastUpdate = listingUpdateDeduplicator.current.get(id);\r\n      if (lastUpdate && now - lastUpdate < DEBOUNCE_TIME) {\r\n        console.log('[ListingContext] Skipping duplicate sold event (debounced):', id);\r\n        return;\r\n      }\r\n      listingUpdateDeduplicator.current.set(id, now);\r\n      \r\n      // Check if we've already processed this sold listing\r\n      if (soldListingDeduplicator.current.isDuplicate(id)) {\r\n        console.log('[ListingContext] Skipping duplicate sold listing:', id);\r\n        return;\r\n      }\r\n      \r\n      // Use setState with callback to prevent multiple state updates\r\n      setListings(prev => {\r\n        // Check if listing exists before filtering\r\n        const exists = prev.some(listing => listing.id === id);\r\n        if (!exists) {\r\n          console.log('[ListingContext] Listing not found in current state:', id);\r\n          return prev;\r\n        }\r\n        \r\n        const filtered = prev.filter(listing => listing.id !== id);\r\n        \r\n        console.log('[ListingContext] Removed sold listing:', id);\r\n        \r\n        // Fire custom event for any components that need to know\r\n        if (typeof window !== 'undefined') {\r\n          // Debounce the custom event as well\r\n          setTimeout(() => {\r\n            window.dispatchEvent(new CustomEvent('listing:removed', {\r\n              detail: { listingId: id, reason: 'sold' }\r\n            }));\r\n          }, 100);\r\n        }\r\n        \r\n        return filtered;\r\n      });\r\n    });\r\n\r\n    return () => {\r\n      unsubscribe();\r\n      // Clean up deduplicator on unmount\r\n      listingUpdateDeduplicator.current.clear();\r\n    };\r\n  }, [isConnected, subscribe]);\r\n\r\n  // Subscribe to order:created events\r\n  useEffect(() => {\r\n    if (!isConnected || !subscribe) return;\r\n\r\n    console.log('[ListingContext] Setting up WebSocket subscription for order:created events');\r\n\r\n    const unsubscribe = subscribe('order:created' as WebSocketEvent, (data: any) => {\r\n      console.log('[ListingContext] Received order:created event:', data);\r\n      \r\n      // Store the latest order so it's immediately available\r\n      if (data.order || data) {\r\n        const order = data.order || data;\r\n        setLatestOrder(order);\r\n        \r\n        // Fire custom event for any components that need to know\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('order:created', {\r\n            detail: { order }\r\n          }));\r\n        }\r\n      }\r\n    });\r\n\r\n    return () => {\r\n      unsubscribe();\r\n    };\r\n  }, [isConnected, subscribe]);\r\n\r\n  // Cleanup deduplication manager on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      soldListingDeduplicator.current.destroy();\r\n    };\r\n  }, []);\r\n\r\n  // Listen for notification changes in localStorage (for header live updates)\r\n  useEffect(() => {\r\n    function handleStorageChange(e: StorageEvent) {\r\n      if (e.key === 'seller_notifications_store') {\r\n        try {\r\n          setNotificationStore(JSON.parse(e.newValue || '{}'));\r\n        } catch {\r\n          setNotificationStore({});\r\n        }\r\n      }\r\n    }\r\n    window.addEventListener('storage', handleStorageChange);\r\n    return () => window.removeEventListener('storage', handleStorageChange);\r\n  }, []);\r\n\r\n  // Migration function to convert old notifications to new format\r\n  const migrateNotifications = (notifications: NotificationItem[]): Notification[] => {\r\n    return notifications.map(normalizeNotification);\r\n  };\r\n\r\n  // Cached fetch function for individual listings\r\n  const fetchListingWithCache = useCallback(async (listingId: string) => {\r\n    const now = Date.now();\r\n    const cached = apiRequestCache.current.get(listingId);\r\n    \r\n    // Return cached promise if it's still fresh\r\n    if (cached && now - cached.timestamp < API_CACHE_TIME) {\r\n      console.log('[ListingContext] Using cached listing request for:', listingId);\r\n      return cached.promise;\r\n    }\r\n    \r\n    // Create new request\r\n    const promise = listingsService.getListing(listingId);\r\n    apiRequestCache.current.set(listingId, { timestamp: now, promise });\r\n    \r\n    // Clean up old cache entries\r\n    setTimeout(() => {\r\n      const cleanupTime = Date.now();\r\n      for (const [key, value] of apiRequestCache.current.entries()) {\r\n        if (cleanupTime - value.timestamp > API_CACHE_TIME * 2) {\r\n          apiRequestCache.current.delete(key);\r\n        }\r\n      }\r\n    }, API_CACHE_TIME * 2);\r\n    \r\n    return promise;\r\n  }, []);\r\n\r\n  // Add a cache for the getListings API call\r\n  const listingsCache = useRef<{ timestamp: number; promise: Promise<any> } | null>(null);\r\n  const LISTINGS_CACHE_TIME = 1000; // Cache for 1 second\r\n\r\n  // Load initial data using services with caching\r\n  const loadData = useCallback(async () => {\r\n    if (typeof window === 'undefined') return;\r\n\r\n    // Check if we're already loading to prevent duplicate calls\r\n    if (isLoading) {\r\n      console.log('[ListingContext] Already loading, skipping duplicate call');\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      // Load users - FIXED: Handle new UsersResponse format with proper type checking\r\n      const usersResult = await usersService.getUsers();\r\n      if (usersResult.success && usersResult.data) {\r\n        // Convert UsersResponse back to Record<string, User> format for backward compatibility\r\n        const usersMap: { [username: string]: any } = {};\r\n        \r\n        if (Array.isArray(usersResult.data)) {\r\n          // Handle case where data is directly an array\r\n          usersResult.data.forEach((user: any) => {\r\n            usersMap[user.username] = user;\r\n          });\r\n        } else if (usersResult.data && typeof usersResult.data === 'object' && 'users' in usersResult.data) {\r\n          // Handle case where data is UsersResponse object - check if users property exists and is array\r\n          const usersResponse = usersResult.data as any;\r\n          if (Array.isArray(usersResponse.users)) {\r\n            usersResponse.users.forEach((user: any) => {\r\n              usersMap[user.username] = user;\r\n            });\r\n          }\r\n        }\r\n        setUsers(usersMap);\r\n      }\r\n\r\n      // Load listings using the service with caching\r\n      const now = Date.now();\r\n      let listingsResult;\r\n      \r\n      if (listingsCache.current && now - listingsCache.current.timestamp < LISTINGS_CACHE_TIME) {\r\n        console.log('[ListingContext] Using cached listings for initial load');\r\n        listingsResult = await listingsCache.current.promise;\r\n      } else {\r\n        const promise = listingsService.getListings();\r\n        listingsCache.current = { timestamp: now, promise };\r\n        listingsResult = await promise;\r\n      }\r\n      \r\n      if (listingsResult.success && listingsResult.data) {\r\n        setListings(listingsResult.data);\r\n      } else {\r\n        throw new Error(listingsResult.error?.message || 'Failed to load listings');\r\n      }\r\n\r\n      // Load subscriptions\r\n      const storedSubs = await storageService.getItem<{ [buyer: string]: string[] }>('subscriptions', {});\r\n      setSubscriptions(storedSubs);\r\n\r\n      // Load notifications\r\n      const storedNotifications = await storageService.getItem<NotificationStore>('seller_notifications_store', {});\r\n      const migrated: NotificationStore = {};\r\n      Object.keys(storedNotifications).forEach(username => {\r\n        if (Array.isArray(storedNotifications[username])) {\r\n          migrated[username] = migrateNotifications(storedNotifications[username]);\r\n        }\r\n      });\r\n      setNotificationStore(migrated);\r\n      await saveNotificationStore(migrated);\r\n\r\n      setIsAuthReady(true);\r\n    } catch (error) {\r\n      console.error('Error loading ListingContext data:', error);\r\n      setError(error instanceof Error ? error.message : 'Failed to load data');\r\n      setIsAuthReady(true);\r\n      listingsCache.current = null; // Clear cache on error\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [isLoading]); // Add isLoading as dependency to prevent duplicate calls\r\n\r\n  // Load data on mount with proper cleanup\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    let timeoutId: NodeJS.Timeout;\r\n    \r\n    // Debounce the initial load slightly to prevent multiple rapid calls\r\n    timeoutId = setTimeout(() => {\r\n      if (mounted && !isAuthReady && !isLoading) {\r\n        loadData();\r\n      }\r\n    }, 100);\r\n    \r\n    return () => {\r\n      mounted = false;\r\n      clearTimeout(timeoutId);\r\n    };\r\n  }, []); // Empty dependency array - only run once on mount\r\n\r\n  const persistUsers = async (updated: { [username: string]: any }) => {\r\n    setUsers(updated);\r\n    await storageService.setItem('all_users_v2', updated);\r\n  };\r\n\r\n  // Refresh listings with caching\r\n  const refreshListings = useCallback(async () => {\r\n    const now = Date.now();\r\n    \r\n    // Return cached promise if it's still fresh\r\n    if (listingsCache.current && now - listingsCache.current.timestamp < LISTINGS_CACHE_TIME) {\r\n      console.log('[ListingContext] Using cached listings request');\r\n      try {\r\n        const result = await listingsCache.current.promise;\r\n        if (result.success && result.data) {\r\n          setListings(result.data);\r\n        }\r\n        return;\r\n      } catch (error) {\r\n        // If cached request failed, continue with new request\r\n      }\r\n    }\r\n    \r\n    setIsLoading(true);\r\n    setError(null);\r\n    \r\n    try {\r\n      // Create and cache the new promise\r\n      const promise = listingsService.getListings();\r\n      listingsCache.current = { timestamp: now, promise };\r\n      \r\n      const listingsResult = await promise;\r\n      if (listingsResult.success && listingsResult.data) {\r\n        setListings(listingsResult.data);\r\n      } else {\r\n        throw new Error(listingsResult.error?.message || 'Failed to refresh listings');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error refreshing listings:', error);\r\n      setError(error instanceof Error ? error.message : 'Failed to refresh listings');\r\n      listingsCache.current = null; // Clear cache on error\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, []);\r\n\r\n  // Check for ended auctions on load and at regular intervals\r\n  useEffect(() => {\r\n    checkEndedAuctions();\r\n    \r\n    const interval = setInterval(() => {\r\n      checkEndedAuctions();\r\n    }, 60000);\r\n    \r\n    return () => clearInterval(interval);\r\n  }, [listings]);\r\n\r\n  // Use listings service for adding listings\r\n  const addListing = async (listing: NewListingInput): Promise<void> => {\r\n    console.log('🔍 addListing called with user:', user);\r\n    \r\n    if (!user || user.role !== 'seller') {\r\n      console.error('❌ addListing failed: user is not a seller', { user: user?.username, role: user?.role });\r\n      alert('You must be logged in as a seller to create listings.');\r\n      return;\r\n    }\r\n\r\n    // Validate and sanitize listing data\r\n    const validationResult = securityService.validateAndSanitize(\r\n      {\r\n        title: listing.title,\r\n        description: listing.description,\r\n        price: listing.price,\r\n        tags: listing.tags,\r\n        wearDuration: listing.hoursWorn, // ✅ validate via schema key\r\n      },\r\n      listingSchemas.createListingSchema.pick({\r\n        title: true,\r\n        description: true,\r\n        price: true,\r\n        tags: true,\r\n        wearDuration: true, // ✅ schema expects wearDuration\r\n      }),\r\n      {\r\n        title: sanitize.strict,\r\n        description: sanitize.strict,\r\n        tags: (tags: string[]) => tags?.map(tag => sanitize.strict(tag))\r\n      }\r\n    );\r\n\r\n    if (!validationResult.success) {\r\n      console.error('Validation failed:', validationResult.errors);\r\n      alert('Please check your listing details:\\n' + Object.values(validationResult.errors || {}).join('\\n'));\r\n      return;\r\n    }\r\n\r\n    const myListings = listings.filter(l => l.seller === user.username);\r\n    const isVerified = user.isVerified || user.verificationStatus === 'verified';\r\n    const maxListings = isVerified ? 25 : 2;\r\n\r\n    console.log('📊 Listing check:', {\r\n      currentListings: myListings.length,\r\n      maxListings,\r\n      isVerified,\r\n      username: user.username\r\n    });\r\n\r\n    if (myListings.length >= maxListings) {\r\n      alert(\r\n        isVerified\r\n          ? 'You have reached the maximum of 25 listings for verified sellers.'\r\n          : 'Unverified sellers can only have 2 active listings. Please verify your account to add more.'\r\n      );\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const sanitizedListing = {\r\n        ...listing,\r\n        title: validationResult.data!.title,\r\n        description: validationResult.data!.description,\r\n        price: validationResult.data!.price,\r\n        tags: validationResult.data!.tags,\r\n        hoursWorn: validationResult.data!.wearDuration, // ✅ map back to hoursWorn\r\n        seller: user.username,\r\n        isVerified: isVerified,\r\n      };\r\n\r\n      const result = await listingsService.createListing(sanitizedListing);\r\n\r\n      if (result.success && result.data) {\r\n        setListings(prev => [...prev, result.data!]);\r\n        console.log('✅ Created new listing:', result.data);\r\n        window.dispatchEvent(new CustomEvent('listingCreated', { detail: { listing: result.data } }));\r\n      } else {\r\n        console.error('Failed to create listing:', result.error);\r\n        alert(result.error?.message || 'Failed to create listing. Please try again.');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error creating listing:', error);\r\n      alert('An error occurred while creating the listing.');\r\n    }\r\n  };\r\n\r\n  // Add an auction listing\r\n  const addAuctionListing = async (listing: AddListingInput, auctionSettings: AuctionInput): Promise<void> => {\r\n    if (!user || user.role !== 'seller') {\r\n      alert('You must be logged in as a seller to create auction listings.');\r\n      return;\r\n    }\r\n\r\n    // Validate and sanitize listing data\r\n    const listingValidation = securityService.validateAndSanitize(\r\n      {\r\n        title: listing.title,\r\n        description: listing.description,\r\n        price: listing.price,\r\n        tags: listing.tags,\r\n        wearDuration: listing.hoursWorn, // ✅ validate with schema key\r\n      },\r\n      listingSchemas.createListingSchema.pick({\r\n        title: true,\r\n        description: true,\r\n        price: true,\r\n        tags: true,\r\n        wearDuration: true, // ✅\r\n      }),\r\n      {\r\n        title: sanitize.strict,\r\n        description: sanitize.strict,\r\n        tags: (tags: string[]) => tags?.map(tag => sanitize.strict(tag))\r\n      }\r\n    );\r\n\r\n    if (!listingValidation.success) {\r\n      console.error('Listing validation failed:', listingValidation.errors);\r\n      alert('Please check your listing details:\\n' + Object.values(listingValidation.errors || {}).join('\\n'));\r\n      return;\r\n    }\r\n\r\n    // Validate auction settings\r\n    const amountValidation = securityService.validateAmount(auctionSettings.startingPrice, {\r\n      min: 0.01,\r\n      max: 10000\r\n    });\r\n\r\n    if (!amountValidation.valid) {\r\n      alert(amountValidation.error || 'Invalid starting price');\r\n      return;\r\n    }\r\n\r\n    if (auctionSettings.reservePrice) {\r\n      const reserveValidation = securityService.validateAmount(auctionSettings.reservePrice, {\r\n        min: auctionSettings.startingPrice,\r\n        max: 10000\r\n      });\r\n\r\n      if (!reserveValidation.valid) {\r\n        alert('Reserve price must be at least the starting price');\r\n        return;\r\n      }\r\n    }\r\n\r\n    const myListings = listings.filter(l => l.seller === user.username);\r\n    const isVerified = user.isVerified || user.verificationStatus === 'verified';\r\n    const maxListings = isVerified ? 25 : 2;\r\n\r\n    if (myListings.length >= maxListings) {\r\n      alert(\r\n        isVerified\r\n          ? 'You have reached the maximum of 25 listings for verified sellers.'\r\n          : 'Unverified sellers can only have 2 active listings. Please verify your account to add more.'\r\n      );\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const sanitizedListing = {\r\n        ...listing,\r\n        title: listingValidation.data!.title,\r\n        description: listingValidation.data!.description,\r\n        price: listingValidation.data!.price,\r\n        tags: listingValidation.data!.tags,\r\n        hoursWorn: listingValidation.data!.wearDuration, // ✅ map back\r\n        seller: user.username,\r\n        isVerified: isVerified,\r\n        auction: auctionSettings,\r\n      };\r\n\r\n      const result = await listingsService.createListing(sanitizedListing);\r\n\r\n      if (result.success && result.data) {\r\n        setListings(prev => [...prev, result.data!]);\r\n        \r\n        addSellerNotification(\r\n          user.username,\r\n          `🔨 You've created a new auction: \"${sanitizedListing.title}\" starting at $${auctionSettings.startingPrice.toFixed(2)}`\r\n        );\r\n        window.dispatchEvent(new CustomEvent('listingCreated', { detail: { listing: result.data } }));\r\n      } else {\r\n        alert(result.error?.message || 'Failed to create auction listing. Please try again.');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error creating auction listing:', error);\r\n      alert('An error occurred while creating the auction listing.');\r\n    }\r\n  };\r\n\r\n  const removeListing = async (id: string): Promise<void> => {\r\n    try {\r\n      const result = await listingsService.deleteListing(id);\r\n      if (result.success) {\r\n        setListings(prev => prev.filter(listing => listing.id !== id));\r\n        \r\n        // FIX 2: Fire event when listing is removed\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('listing:removed', {\r\n            detail: { listingId: id, reason: 'deleted' }\r\n          }));\r\n        }\r\n        \r\n        window.dispatchEvent(new CustomEvent('listingDeleted', { detail: { listingId: id } }));\r\n      } else {\r\n        throw new Error(result.error?.message || 'Failed to delete listing');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error removing listing:', error);\r\n      alert(error instanceof Error ? error.message : 'Failed to remove listing');\r\n    }\r\n  };\r\n\r\n  const purchaseListingAndRemove = async (listing: Listing, buyerUsername: string): Promise<boolean> => {\r\n    try {\r\n      // Sanitize buyer username\r\n      const sanitizedBuyer = sanitize.username(buyerUsername);\r\n      \r\n      // Convert ListingContext's Listing to the format that WalletContext expects\r\n      const listingForWallet = {\r\n        id: listing.id,\r\n        title: listing.title,\r\n        description: listing.description,\r\n        price: listing.price,\r\n        markedUpPrice: listing.markedUpPrice,\r\n        seller: listing.seller,\r\n        sellerUsername: listing.seller,\r\n        imageUrls: listing.imageUrls,\r\n        type: 'instant' as const,\r\n        status: 'active' as const,\r\n        category: 'panties' as const,\r\n        shippingIncluded: true,\r\n        internationalShipping: false,\r\n        createdAt: listing.date,\r\n        updatedAt: listing.date,\r\n        views: listing.views || 0,  // FIX: Include views in the conversion\r\n        favorites: 0,\r\n        tags: listing.tags,\r\n        size: undefined,\r\n        color: undefined,\r\n        material: undefined,\r\n        wearTime: listing.hoursWorn?.toString(),\r\n        customizations: [],\r\n        featured: false,\r\n        verified: listing.isVerified,\r\n        nsfw: false\r\n      };\r\n      \r\n      // First, process the purchase through wallet\r\n      const success = await purchaseListing(listingForWallet as any, sanitizedBuyer);\r\n      \r\n      if (success) {\r\n        // If purchase was successful, remove the listing\r\n        // FIX 2: Add to deduplication manager before removing\r\n        soldListingDeduplicator.current.isDuplicate(listing.id);\r\n        \r\n        await removeListing(listing.id);\r\n        \r\n        console.log('✅ Listing purchased and removed:', listing.id);\r\n      }\r\n      \r\n      return success;\r\n    } catch (error) {\r\n      console.error('Error in purchaseListingAndRemove:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const updateListing = async (id: string, updatedListing: Partial<Omit<Listing, 'id' | 'date' | 'markedUpPrice'>>): Promise<void> => {\r\n    try {\r\n      // Sanitize updated fields if they exist\r\n      const sanitizedUpdate: any = { ...updatedListing };\r\n      \r\n      if (updatedListing.title) {\r\n        sanitizedUpdate.title = sanitize.strict(updatedListing.title);\r\n      }\r\n      if (updatedListing.description) {\r\n        sanitizedUpdate.description = sanitize.strict(updatedListing.description);\r\n      }\r\n      if (updatedListing.tags) {\r\n        sanitizedUpdate.tags = updatedListing.tags.map(tag => sanitize.strict(tag));\r\n      }\r\n      \r\n      const result = await listingsService.updateListing(id, sanitizedUpdate);\r\n      if (result.success && result.data) {\r\n        setListings(prev => prev.map(listing => \r\n          listing.id === id ? result.data! : listing\r\n        ));\r\n      } else {\r\n        throw new Error(result.error?.message || 'Failed to update listing');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error updating listing:', error);\r\n      alert(error instanceof Error ? error.message : 'Failed to update listing');\r\n    }\r\n  };\r\n\r\n  // CRITICAL FIX: Update placeBid to not call hooks inside\r\n  const placeBid = useCallback(async (listingId: string, bidder: string, amount: number): Promise<boolean> => {\r\n    try {\r\n      const listing = listings.find(l => l.id === listingId);\r\n      if (!listing) {\r\n        console.error('[ListingContext] Listing not found:', listingId);\r\n        return false;\r\n      }\r\n\r\n      // Check if this is an incremental bid (user raising their own bid)\r\n      const isCurrentHighestBidder = listing.auction?.highestBidder === bidder;\r\n      const currentHighestBid = listing.auction?.highestBid || 0;\r\n      \r\n      if (isCurrentHighestBidder && currentHighestBid > 0) {\r\n        // For incremental bids, only charge the difference (no fee)\r\n        const bidDifference = amount - currentHighestBid;\r\n        \r\n        // NOTE: Balance validation should be done in the component that calls placeBid\r\n        // We don't validate balance here to avoid using hooks inside this function\r\n        \r\n        console.log(`[ListingContext] Processing incremental bid: difference=${bidDifference}`);\r\n      }\r\n\r\n      // Delegate to AuctionContext\r\n      const success = await auctionPlaceBid(listingId, bidder, amount);\r\n      \r\n      if (success) {\r\n        // Refresh listings to get updated bid info\r\n        await refreshListings();\r\n        \r\n        // Add seller notification\r\n        addSellerNotification(\r\n          listing.seller,\r\n          `💰 New bid! ${bidder} bid $${amount.toFixed(2)} on \"${listing.title}\"`\r\n        );\r\n      }\r\n      \r\n      return success;\r\n    } catch (error) {\r\n      console.error('[ListingContext] Bid error:', error);\r\n      return false;\r\n    }\r\n  }, [listings, auctionPlaceBid, refreshListings, addSellerNotification]);\r\n\r\n  const getAuctionListings = (): Listing[] => {\r\n    return listings.filter(listing => listing.auction?.isAuction);\r\n  };\r\n\r\n  const getActiveAuctions = (): Listing[] => {\r\n    return listings.filter(listing => \r\n      listing.auction?.isAuction && \r\n      listing.auction.status === 'active'\r\n    );\r\n  };\r\n\r\n  const getEndedAuctions = (): Listing[] => {\r\n    return listings.filter(listing => \r\n      listing.auction?.isAuction && \r\n      listing.auction.status === 'ended'\r\n    );\r\n  };\r\n\r\n  // FIX: Updated checkEndedAuctions to only run for sellers and admins\r\n  const checkEndedAuctions = async (): Promise<void> => {\r\n    // Only check ended auctions if user is a seller or admin\r\n    if (!user || (user.role !== 'seller' && user.role !== 'admin')) {\r\n      return; // Skip auction checks for buyers\r\n    }\r\n    \r\n    const activeAuctions = getActiveAuctions();\r\n    const now = new Date();\r\n    \r\n    for (const listing of activeAuctions) {\r\n      // Only process auctions where the current user is the seller\r\n      if (listing.auction && \r\n          new Date(listing.auction.endTime) <= now && \r\n          (user.username === listing.seller || user.role === 'admin')) {\r\n        \r\n        const processed = await processEndedAuction(listing);\r\n        \r\n        if (processed) {\r\n          // Update listing status locally\r\n          setListings(prev => prev.map(l => \r\n            l.id === listing.id \r\n              ? { ...l, auction: { ...l.auction!, status: 'ended' as AuctionStatus } }\r\n              : l\r\n          ));\r\n          \r\n          // Remove the listing if it was sold\r\n          if (listing.auction.highestBidder) {\r\n            // FIX 2: Add to deduplication manager before removing\r\n            soldListingDeduplicator.current.isDuplicate(listing.id);\r\n            \r\n            setListings(prev => prev.filter(l => l.id !== listing.id));\r\n            \r\n            // FIX 2: Fire event for sold auction\r\n            if (typeof window !== 'undefined') {\r\n              window.dispatchEvent(new CustomEvent('listing:removed', {\r\n                detail: { listingId: listing.id, reason: 'auction-sold' }\r\n              }));\r\n            }\r\n          }\r\n          \r\n          // Notify seller with updated message for 20% fee\r\n          if (listing.auction.highestBidder && listing.auction.highestBid) {\r\n            const sellerEarnings = listing.auction.highestBid * 0.8; // 80% to seller\r\n            addSellerNotification(\r\n              listing.seller,\r\n              `🏆 Auction ended: \"${listing.title}\" sold to ${listing.auction.highestBidder} for $${listing.auction.highestBid.toFixed(2)}. You'll receive $${sellerEarnings.toFixed(2)} (after 20% platform fee)`\r\n            );\r\n          } else {\r\n            addSellerNotification(\r\n              listing.seller,\r\n              `🔨 Auction ended: No valid bids for \"${listing.title}\"`\r\n            );\r\n          }\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  // NEW: Use AuctionContext for cancelling auctions\r\n  const cancelAuction = async (listingId: string): Promise<boolean> => {\r\n    if (!user) return false;\r\n    \r\n    const listing = listings.find(l => l.id === listingId);\r\n    if (!listing) return false;\r\n    \r\n    if (user.role !== 'admin' && user.username !== listing.seller) return false;\r\n    \r\n    const success = await auctionCancelAuction(listingId);\r\n    \r\n    if (success) {\r\n      // Update listing locally\r\n      setListings(prev => prev.map(l => \r\n        l.id === listingId \r\n          ? { ...l, auction: { ...l.auction!, status: 'cancelled' as AuctionStatus } }\r\n          : l\r\n      ));\r\n      \r\n      addSellerNotification(\r\n        listing.seller,\r\n        `🛑 You cancelled your auction: \"${listing.title}\". All bidders have been refunded.`\r\n      );\r\n    }\r\n    \r\n    return success;\r\n  };\r\n\r\n  // Draft management functions (unchanged)\r\n  const saveDraft = async (draft: ListingDraft): Promise<boolean> => {\r\n    if (!user || user.role !== 'seller') {\r\n      console.error('Only sellers can save drafts');\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      // Sanitize draft fields - Access from formState\r\n      const sanitizedDraft = {\r\n        ...draft,\r\n        formState: {\r\n          ...draft.formState,\r\n          title: draft.formState.title ? sanitize.strict(draft.formState.title) : '',\r\n          description: draft.formState.description ? sanitize.strict(draft.formState.description) : '',\r\n          tags: draft.formState.tags ? sanitize.strict(draft.formState.tags) : ''\r\n        },\r\n        seller: user.username,\r\n      };\r\n\r\n      const result = await listingsService.saveDraft(sanitizedDraft);\r\n      return result.success;\r\n    } catch (error) {\r\n      console.error('Error saving draft:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const getDrafts = async (): Promise<ListingDraft[]> => {\r\n    if (!user || user.role !== 'seller') {\r\n      return [];\r\n    }\r\n\r\n    try {\r\n      const result = await listingsService.getDrafts(user.username);\r\n      return result.success && result.data ? result.data : [];\r\n    } catch (error) {\r\n      console.error('Error getting drafts:', error);\r\n      return [];\r\n    }\r\n  };\r\n\r\n  const deleteDraft = async (draftId: string): Promise<boolean> => {\r\n    try {\r\n      const result = await listingsService.deleteDraft(draftId);\r\n      return result.success;\r\n    } catch (error) {\r\n      console.error('Error deleting draft:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Image management functions (unchanged)\r\n  const uploadImage = async (file: File): Promise<string | null> => {\r\n    // Validate file before upload\r\n    const fileValidation = securityService.validateFileUpload(file, {\r\n      maxSize: 5 * 1024 * 1024, // 5MB\r\n      allowedTypes: ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'],\r\n      allowedExtensions: ['jpg', 'jpeg', 'png', 'webp']\r\n    });\r\n\r\n    if (!fileValidation.valid) {\r\n      alert(fileValidation.error || 'Invalid file');\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      const result = await listingsService.uploadImage(file);\r\n      return result.success && result.data ? result.data : null;\r\n    } catch (error) {\r\n      console.error('Error uploading image:', error);\r\n      return null;\r\n    }\r\n  };\r\n\r\n  const deleteImage = async (imageUrl: string): Promise<boolean> => {\r\n    try {\r\n      // Validate URL before deletion\r\n      const sanitizedUrl = sanitize.url(imageUrl);\r\n      if (!sanitizedUrl) {\r\n        console.error('Invalid image URL');\r\n        return false;\r\n      }\r\n\r\n      const result = await listingsService.deleteImage(sanitizedUrl);\r\n      return result.success;\r\n    } catch (error) {\r\n      console.error('Error deleting image:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Subscription functions (unchanged)\r\n  const subscribeToSeller = async (buyer: string, seller: string, price: number): Promise<boolean> => {\r\n    // Validate subscription price\r\n    const priceValidation = securityService.validateAmount(price, {\r\n      min: 0.01,\r\n      max: 1000\r\n    });\r\n\r\n    if (!priceValidation.valid) {\r\n      console.error('Invalid subscription price:', priceValidation.error);\r\n      return false;\r\n    }\r\n\r\n    // Sanitize usernames\r\n    const sanitizedBuyer = sanitize.username(buyer);\r\n    const sanitizedSeller = sanitize.username(seller);\r\n\r\n    const success = await subscribeToSellerWithPayment(sanitizedBuyer, sanitizedSeller, price);\r\n    if (success) {\r\n      setSubscriptions((prev) => {\r\n        const updated = {\r\n          ...prev,\r\n          [sanitizedBuyer]: [...(prev[sanitizedBuyer] || []), sanitizedSeller],\r\n        };\r\n        storageService.setItem('subscriptions', updated);\r\n        return updated;\r\n      });\r\n      \r\n      // NEW: Store subscription details with the actual price paid\r\n      const subscriptionDetails = await storageService.getItem<Record<string, SubscriptionData[]>>('subscription_details', {});\r\n      const buyerSubs = subscriptionDetails[sanitizedBuyer] || [];\r\n      \r\n      // Remove any existing subscription to this seller\r\n      const filteredSubs = buyerSubs.filter(sub => sub.seller !== sanitizedSeller);\r\n      \r\n      // Add new subscription with price\r\n      filteredSubs.push({\r\n        seller: sanitizedSeller,\r\n        price: price,\r\n        subscribedAt: new Date().toISOString()\r\n      });\r\n      \r\n      subscriptionDetails[sanitizedBuyer] = filteredSubs;\r\n      await storageService.setItem('subscription_details', subscriptionDetails);\r\n      \r\n      addSellerNotification(\r\n        sanitizedSeller,\r\n        `🎉 ${sanitizedBuyer} subscribed to you!`\r\n      );\r\n    }\r\n    return success;\r\n  };\r\n\r\n  // Unsubscribe from seller with API support (unchanged)\r\n  const unsubscribeFromSeller = async (buyer: string, seller: string): Promise<void> => {\r\n    try {\r\n      // Sanitize usernames\r\n      const sanitizedBuyer = sanitize.username(buyer);\r\n      const sanitizedSeller = sanitize.username(seller);\r\n      \r\n      console.log('[ListingContext] Unsubscribing from seller:', { buyer: sanitizedBuyer, seller: sanitizedSeller });\r\n      \r\n      // First, call the wallet context's unsubscribe method to handle the backend API call\r\n      let success = false;\r\n      \r\n      // Check if the unsubscribeFromSeller method exists in wallet context\r\n      if (walletUnsubscribeFromSeller && typeof walletUnsubscribeFromSeller === 'function') {\r\n        success = await walletUnsubscribeFromSeller(sanitizedBuyer, sanitizedSeller);\r\n        console.log('[ListingContext] Wallet unsubscribe result:', success);\r\n      } else {\r\n        console.warn('[ListingContext] Wallet unsubscribeFromSeller method not available, updating local state only');\r\n        success = true; // Allow local state update even if wallet method isn't available\r\n      }\r\n      \r\n      if (success) {\r\n        // Update local subscriptions state\r\n        setSubscriptions((prev) => {\r\n          const updated = {\r\n            ...prev,\r\n            [sanitizedBuyer]: (prev[sanitizedBuyer] || []).filter((s) => s !== sanitizedSeller),\r\n          };\r\n          storageService.setItem('subscriptions', updated);\r\n          return updated;\r\n        });\r\n        \r\n        // Also remove from subscription details\r\n        const subscriptionDetails = await storageService.getItem<Record<string, SubscriptionData[]>>('subscription_details', {});\r\n        const buyerSubs = subscriptionDetails[sanitizedBuyer] || [];\r\n        const filteredSubs = buyerSubs.filter(sub => sub.seller !== sanitizedSeller);\r\n        subscriptionDetails[sanitizedBuyer] = filteredSubs;\r\n        await storageService.setItem('subscription_details', subscriptionDetails);\r\n        \r\n        // Add notification to seller\r\n        addSellerNotification(\r\n          sanitizedSeller,\r\n          `${sanitizedBuyer} unsubscribed from your content`\r\n        );\r\n        \r\n        console.log('[ListingContext] Successfully unsubscribed and updated local state');\r\n      } else {\r\n        console.error('[ListingContext] Failed to unsubscribe from seller');\r\n        throw new Error('Failed to unsubscribe. Please try again.');\r\n      }\r\n    } catch (error) {\r\n      console.error('[ListingContext] Error in unsubscribeFromSeller:', error);\r\n      throw error;\r\n    }\r\n  };\r\n\r\n  const isSubscribed = (buyer: string, seller: string): boolean => {\r\n    // Sanitize usernames\r\n    const sanitizedBuyer = sanitize.username(buyer);\r\n    const sanitizedSeller = sanitize.username(seller);\r\n    \r\n    return subscriptions[sanitizedBuyer]?.includes(sanitizedSeller) ?? false;\r\n  };\r\n\r\n  // Notification functions (unchanged)\r\n  const getCurrentSellerNotifications = (): Notification[] => {\r\n    if (!user || user.role !== 'seller') {\r\n      return [];\r\n    }\r\n    const userNotifications = notificationStore[user.username] || [];\r\n    return userNotifications.map(normalizeNotification);\r\n  };\r\n\r\n  const clearSellerNotification = (notificationId: string | number) => {\r\n    if (!user || user.role !== 'seller') {\r\n      return;\r\n    }\r\n\r\n    const username = user.username;\r\n    const userNotifications = notificationStore[username] || [];\r\n\r\n    setNotificationStore(prev => {\r\n      const updatedNotifications = userNotifications.map((item, index) => {\r\n        const notification = normalizeNotification(item);\r\n        \r\n        const shouldClear = typeof notificationId === 'string' \r\n          ? notification.id === notificationId\r\n          : index === notificationId;\r\n          \r\n        if (shouldClear) {\r\n          return {\r\n            ...notification,\r\n            cleared: true\r\n          };\r\n        }\r\n        return notification;\r\n      });\r\n\r\n      const updated = {\r\n        ...prev,\r\n        [username]: updatedNotifications\r\n      };\r\n      saveNotificationStore(updated);\r\n      return updated;\r\n    });\r\n  };\r\n\r\n  const restoreSellerNotification = (notificationId: string) => {\r\n    if (!user || user.role !== 'seller') {\r\n      return;\r\n    }\r\n\r\n    const username = user.username;\r\n    const userNotifications = notificationStore[username] || [];\r\n\r\n    setNotificationStore(prev => {\r\n      const updatedNotifications = userNotifications.map(item => {\r\n        const notification = normalizeNotification(item);\r\n        if (notification.id === notificationId) {\r\n          return {\r\n            ...notification,\r\n            cleared: false\r\n          };\r\n        }\r\n        return notification;\r\n      });\r\n\r\n      const updated = {\r\n        ...prev,\r\n        [username]: updatedNotifications\r\n      };\r\n      saveNotificationStore(updated);\r\n      return updated;\r\n    });\r\n  };\r\n\r\n  const permanentlyDeleteSellerNotification = (notificationId: string) => {\r\n    if (!user || user.role !== 'seller') {\r\n      return;\r\n    }\r\n\r\n    const username = user.username;\r\n    const userNotifications = notificationStore[username] || [];\r\n\r\n    setNotificationStore(prev => {\r\n      const updatedNotifications = userNotifications.filter(item => {\r\n        const notification = normalizeNotification(item);\r\n        return notification.id !== notificationId;\r\n      });\r\n\r\n      const updated = {\r\n        ...prev,\r\n        [username]: updatedNotifications\r\n      };\r\n      saveNotificationStore(updated);\r\n      return updated;\r\n    });\r\n  };\r\n\r\n  // Verification functions (unchanged)\r\n  const requestVerification = async (docs: VerificationDocs): Promise<void> => {\r\n    if (!user) return;\r\n    \r\n    console.log('🔍 requestVerification called with user:', user.username);\r\n    \r\n    const code = docs.code || `VERIF-${user.username}-${Math.floor(100000 + Math.random() * 900000)}`;\r\n    \r\n    try {\r\n      const result = await usersService.requestVerification(user.username, { ...docs, code });\r\n      \r\n      if (result.success) {\r\n        await updateUser({\r\n          verificationStatus: 'pending',\r\n          verificationRequestedAt: new Date().toISOString(),\r\n          verificationDocs: { ...docs, code },\r\n        });\r\n        \r\n        // Also update the legacy users store for admin functionality\r\n        const updatedUser = {\r\n          ...user,\r\n          verificationStatus: 'pending' as VerificationStatus,\r\n          verificationDocs: { ...docs, code },\r\n          verificationRequestedAt: new Date().toISOString(),\r\n        };\r\n        \r\n        await persistUsers({\r\n          ...users,\r\n          [user.username]: updatedUser,\r\n        });\r\n        \r\n        console.log('✅ Verification request submitted for:', user.username);\r\n      } else {\r\n        console.error('Failed to submit verification request:', result.error);\r\n        alert('Failed to submit verification request. Please try again.');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error submitting verification request:', error);\r\n      alert('An error occurred while submitting verification request.');\r\n    }\r\n  };\r\n\r\n  const setVerificationStatus = async (\r\n    username: string,\r\n    status: VerificationStatus,\r\n    rejectionReason?: string\r\n  ): Promise<void> => {\r\n    // Sanitize inputs\r\n    const sanitizedUsername = sanitize.username(username);\r\n    const sanitizedReason = rejectionReason ? sanitize.strict(rejectionReason) : undefined;\r\n\r\n    const existingUser = users[sanitizedUsername];\r\n    if (!existingUser) return;\r\n    \r\n    try {\r\n      const result = await usersService.updateVerificationStatus(sanitizedUsername, {\r\n        status,\r\n        rejectionReason: sanitizedReason,\r\n        adminUsername: user?.username || 'admin',\r\n      });\r\n      \r\n      if (result.success) {\r\n        const updatedUser = {\r\n          ...existingUser,\r\n          verificationStatus: status,\r\n          verified: status === 'verified',\r\n          verificationReviewedAt: new Date().toISOString(),\r\n          verificationRejectionReason: sanitizedReason,\r\n        };\r\n        \r\n        // Also update AuthContext if this is the current user\r\n        if (user?.username === sanitizedUsername) {\r\n          await updateUser({\r\n            verificationStatus: status,\r\n            isVerified: status === 'verified',\r\n            verificationRejectionReason: sanitizedReason,\r\n          });\r\n        }\r\n        \r\n        await persistUsers({\r\n          ...users,\r\n          [sanitizedUsername]: updatedUser,\r\n        });\r\n\r\n        setListings(prev => {\r\n          return prev.map(listing => {\r\n            if (listing.seller === sanitizedUsername) {\r\n              return { ...listing, isVerified: status === 'verified' };\r\n            }\r\n            return listing;\r\n          });\r\n        });\r\n      } else {\r\n        console.error('Failed to update verification status:', result.error);\r\n        alert('Failed to update verification status. Please try again.');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error updating verification status:', error);\r\n      alert('An error occurred while updating verification status.');\r\n    }\r\n  };\r\n\r\n  const sellerNotifications = getCurrentSellerNotifications();\r\n  \r\n  return (\r\n    <ListingContext.Provider\r\n      value={{\r\n        isAuthReady,\r\n        listings,\r\n        addListing,\r\n        addAuctionListing,\r\n        removeListing,\r\n        updateListing,\r\n        purchaseListingAndRemove,\r\n        placeBid,\r\n        getAuctionListings,\r\n        getActiveAuctions,\r\n        getEndedAuctions,\r\n        checkEndedAuctions,\r\n        cancelAuction,\r\n        saveDraft,\r\n        getDrafts,\r\n        deleteDraft,\r\n        uploadImage,\r\n        deleteImage,\r\n        subscriptions,\r\n        subscribeToSeller,\r\n        unsubscribeFromSeller,\r\n        isSubscribed,\r\n        sellerNotifications,\r\n        addSellerNotification,\r\n        clearSellerNotification,\r\n        restoreSellerNotification,\r\n        permanentlyDeleteSellerNotification,\r\n        requestVerification,\r\n        setVerificationStatus,\r\n        users,\r\n        orderHistory,\r\n        latestOrder,\r\n        isLoading,\r\n        error,\r\n        refreshListings,\r\n      }}\r\n    >\r\n      {children}\r\n    </ListingContext.Provider>\r\n  );\r\n};\r\n\r\nexport const useListings = () => {\r\n  const context = useContext(ListingContext);\r\n  if (!context) throw new Error('useListings must be used within a ListingProvider');\r\n  return context;\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 7040, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/MessageContext.tsx"],"sourcesContent":["// src/context/MessageContext.tsx\r\nimport React, { createContext, useContext, useState, useEffect, ReactNode, useCallback, useRef } from 'react';\r\nimport { sanitizeStrict } from '@/utils/security/sanitization';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { messagesService, storageService } from '@/services';\r\nimport { messageSchemas } from '@/utils/validation/schemas';\r\nimport { z } from 'zod';\r\n\r\n// Import WebSocket context\r\nimport { useWebSocket } from '@/context/WebSocketContext';\r\nimport { WebSocketEvent } from '@/types/websocket';\r\n\r\n// Enhanced Message type with id and isRead\r\ntype Message = {\r\n  id?: string;\r\n  sender: string;\r\n  receiver: string;\r\n  content: string;\r\n  date: string;\r\n  isRead?: boolean;\r\n  read?: boolean;\r\n  type?: 'normal' | 'customRequest' | 'image' | 'tip';\r\n  meta?: {\r\n    id?: string;\r\n    title?: string;\r\n    price?: number;\r\n    tags?: string[];\r\n    message?: string;\r\n    imageUrl?: string;\r\n    tipAmount?: number;\r\n  };\r\n  threadId?: string;\r\n  _optimisticId?: string; // Track optimistic messages\r\n};\r\n\r\n// Enhanced ReportLog type with processing status\r\ntype ReportLog = {\r\n  id?: string;\r\n  reporter: string;\r\n  reportee: string;\r\n  messages: Message[];\r\n  date: string;\r\n  processed?: boolean;\r\n  banApplied?: boolean;\r\n  banId?: string;\r\n  severity?: 'low' | 'medium' | 'high' | 'critical';\r\n  category?: 'harassment' | 'spam' | 'inappropriate_content' | 'scam' | 'other';\r\n  adminNotes?: string;\r\n  processedBy?: string;\r\n  processedAt?: string;\r\n};\r\n\r\ntype MessageOptions = {\r\n  type?: 'normal' | 'customRequest' | 'image' | 'tip';\r\n  meta?: {\r\n    id?: string;\r\n    title?: string;\r\n    price?: number;\r\n    tags?: string[];\r\n    message?: string;\r\n    imageUrl?: string;\r\n    tipAmount?: number;\r\n  };\r\n  _optimisticId?: string; // Track optimistic ID\r\n};\r\n\r\n// Thread type for organized message threads\r\ntype MessageThread = {\r\n  [otherParty: string]: Message[];\r\n};\r\n\r\n// Thread info type for additional thread metadata\r\ntype ThreadInfo = {\r\n  unreadCount: number;\r\n  lastMessage: Message | null;\r\n  otherParty: string;\r\n};\r\n\r\n// Message notification type\r\ntype MessageNotification = {\r\n  buyer: string;\r\n  messageCount: number;\r\n  lastMessage: string;\r\n  timestamp: string;\r\n};\r\n\r\n// Enhanced MessageContextType with additional methods\r\ntype MessageContextType = {\r\n  messages: { [conversationKey: string]: Message[] };\r\n  isLoading: boolean;\r\n  sendMessage: (\r\n    sender: string,\r\n    receiver: string,\r\n    content: string,\r\n    options?: MessageOptions\r\n  ) => Promise<void>;\r\n  sendCustomRequest: (\r\n    buyer: string,\r\n    seller: string,\r\n    content: string,\r\n    title: string,\r\n    price: number,\r\n    tags: string[],\r\n    listingId: string\r\n  ) => void;\r\n  getMessagesForUsers: (userA: string, userB: string) => Message[];\r\n  getThreadsForUser: (username: string, role?: 'buyer' | 'seller') => MessageThread;\r\n  getThreadInfo: (username: string, otherParty: string) => ThreadInfo;\r\n  getAllThreadsInfo: (username: string, role?: 'buyer' | 'seller') => { [otherParty: string]: ThreadInfo };\r\n  markMessagesAsRead: (userA: string, userB: string) => Promise<void>;\r\n  blockUser: (blocker: string, blockee: string) => Promise<void>;\r\n  unblockUser: (blocker: string, blockee: string) => Promise<void>;\r\n  reportUser: (reporter: string, reportee: string) => Promise<void>;\r\n  isBlocked: (blocker: string, blockee: string) => boolean;\r\n  hasReported: (reporter: string, reportee: string) => boolean;\r\n  getReportCount: () => number;\r\n  blockedUsers: { [user: string]: string[] };\r\n  reportedUsers: { [user: string]: string[] };\r\n  reportLogs: ReportLog[];\r\n  messageNotifications: { [seller: string]: MessageNotification[] };\r\n  clearMessageNotifications: (seller: string, buyer: string) => void;\r\n  refreshMessages: () => void;\r\n};\r\n\r\nconst MessageContext = createContext<MessageContextType | undefined>(undefined);\r\n\r\n// Helper to create a consistent conversation key\r\nconst getConversationKey = (userA: string, userB: string): string => {\r\n  return [userA, userB].sort().join('-');\r\n};\r\n\r\n// Validation schemas\r\nconst customRequestMetaSchema = z.object({\r\n  title: messageSchemas.customRequest.shape.title,\r\n  price: messageSchemas.customRequest.shape.price,\r\n  message: messageSchemas.customRequest.shape.description,\r\n});\r\n\r\nexport const MessageProvider: React.FC<{ children: ReactNode }> = ({ children }) => {\r\n  const [messages, setMessages] = useState<{ [conversationKey: string]: Message[] }>({});\r\n  const [blockedUsers, setBlockedUsers] = useState<{ [user: string]: string[] }>({});\r\n  const [reportedUsers, setReportedUsers] = useState<{ [user: string]: string[] }>({});\r\n  const [reportLogs, setReportLogs] = useState<ReportLog[]>([]);\r\n  const [messageNotifications, setMessageNotifications] = useState<{ [seller: string]: MessageNotification[] }>({});\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [updateTrigger, setUpdateTrigger] = useState(0);\r\n\r\n  // Use WebSocket context - with safe fallback\r\n  const wsContext = useWebSocket ? useWebSocket() : null;\r\n  const { subscribe, isConnected } = wsContext || { subscribe: null, isConnected: false };\r\n  \r\n  // Track processed message IDs to prevent duplicates\r\n  const processedMessageIds = useRef<Set<string>>(new Set());\r\n  const optimisticMessageMap = useRef<Map<string, string>>(new Map()); // optimisticId -> realId\r\n  const subscriptionsRef = useRef<(() => void)[]>([]);\r\n\r\n  // Initialize service on mount\r\n  useEffect(() => {\r\n    messagesService.initialize();\r\n  }, []);\r\n\r\n  // Load initial data using services\r\n  useEffect(() => {\r\n    const loadData = async () => {\r\n      if (typeof window === 'undefined') {\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n\r\n      try {\r\n        setIsLoading(true);\r\n\r\n        // Load messages\r\n        const storedMessages = await storageService.getItem<{ [key: string]: Message[] }>('panty_messages', {});\r\n\r\n        // Ensure we have a valid object\r\n        if (storedMessages && typeof storedMessages === 'object') {\r\n          // Migrate old format if needed\r\n          const needsMigration = Object.values(storedMessages).some(\r\n            value => !Array.isArray(value) || (value.length > 0 && !value[0].sender)\r\n          );\r\n\r\n          if (needsMigration) {\r\n            console.log('Migrating message format...');\r\n            const migrated: { [key: string]: Message[] } = {};\r\n\r\n            Object.entries(storedMessages).forEach(([key, msgs]) => {\r\n              if (Array.isArray(msgs)) {\r\n                msgs.forEach((msg: any) => {\r\n                  if (msg.sender && msg.receiver) {\r\n                    const conversationKey = getConversationKey(msg.sender, msg.receiver);\r\n                    if (!migrated[conversationKey]) {\r\n                      migrated[conversationKey] = [];\r\n                    }\r\n                    migrated[conversationKey].push({\r\n                      ...msg,\r\n                      content: sanitizeStrict(msg.content || '')\r\n                    });\r\n                  }\r\n                });\r\n              }\r\n            });\r\n\r\n            setMessages(migrated);\r\n            await storageService.setItem('panty_messages', migrated);\r\n          } else {\r\n            // Sanitize existing messages\r\n            const sanitized: { [key: string]: Message[] } = {};\r\n            Object.entries(storedMessages).forEach(([key, msgs]) => {\r\n              sanitized[key] = msgs.map(msg => ({\r\n                ...msg,\r\n                content: sanitizeStrict(msg.content || '')\r\n              }));\r\n            });\r\n            setMessages(sanitized);\r\n          }\r\n        }\r\n\r\n        // Load blocked users\r\n        const blocked = await storageService.getItem<{ [user: string]: string[] }>('panty_blocked', {});\r\n        setBlockedUsers(blocked || {});\r\n\r\n        // Load reported users\r\n        const reported = await storageService.getItem<{ [user: string]: string[] }>('panty_reported', {});\r\n        setReportedUsers(reported || {});\r\n\r\n        // Load report logs\r\n        const reports = await storageService.getItem<ReportLog[]>('panty_report_logs', []);\r\n        setReportLogs(reports || []);\r\n\r\n        // Load message notifications\r\n        const notifications = await storageService.getItem<{ [seller: string]: MessageNotification[] }>('panty_message_notifications', {});\r\n        setMessageNotifications(notifications || {});\r\n\r\n      } catch (error) {\r\n        console.error('Error loading message data:', error);\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n\r\n    loadData();\r\n  }, []);\r\n\r\n  // FIXED: WebSocket listener for new messages - handle optimistic updates properly\r\n  useEffect(() => {\r\n    // Clean up previous subscriptions\r\n    subscriptionsRef.current.forEach(unsub => unsub());\r\n    subscriptionsRef.current = [];\r\n\r\n    if (!subscribe) {\r\n      console.log('[MessageContext] WebSocket subscribe not available');\r\n      return;\r\n    }\r\n\r\n    console.log('[MessageContext] Setting up WebSocket listeners, connected:', isConnected);\r\n\r\n    // Subscribe to new message events\r\n    const unsubscribeNewMessage = subscribe('message:new' as WebSocketEvent, (data: any) => {\r\n      console.log('[MessageContext] New message received via WebSocket:', data);\r\n      \r\n      if (data && data.sender && data.receiver) {\r\n        const conversationKey = getConversationKey(data.sender, data.receiver);\r\n        \r\n        // Check if we've already processed this message ID\r\n        if (data.id && processedMessageIds.current.has(data.id)) {\r\n          console.log('[MessageContext] Message already processed, skipping:', data.id);\r\n          return;\r\n        }\r\n        \r\n        if (data.id) {\r\n          processedMessageIds.current.add(data.id);\r\n          // Clean up old IDs to prevent memory leak\r\n          if (processedMessageIds.current.size > 1000) {\r\n            const idsArray = Array.from(processedMessageIds.current);\r\n            processedMessageIds.current = new Set(idsArray.slice(-500));\r\n          }\r\n        }\r\n        \r\n        const newMessage: Message = {\r\n          id: data.id || uuidv4(),\r\n          sender: data.sender,\r\n          receiver: data.receiver,\r\n          content: data.content || '',\r\n          date: data.date || data.createdAt || new Date().toISOString(),\r\n          isRead: data.isRead || false,\r\n          read: data.read || false,\r\n          type: data.type || 'normal',\r\n          meta: data.meta,\r\n          threadId: data.threadId || conversationKey,\r\n          _optimisticId: data._optimisticId\r\n        };\r\n        \r\n        console.log('[MessageContext] Processing message for conversation:', conversationKey);\r\n        \r\n        // Update messages state\r\n        setMessages(prev => {\r\n          const existingMessages = prev[conversationKey] || [];\r\n          \r\n          // Check if this is a confirmation of an optimistic message\r\n          if (data._optimisticId) {\r\n            // Store the mapping\r\n            optimisticMessageMap.current.set(data._optimisticId, newMessage.id!);\r\n            \r\n            // Remove the optimistic message and add the confirmed one\r\n            const withoutOptimistic = existingMessages.filter(m => \r\n              m._optimisticId !== data._optimisticId\r\n            );\r\n            \r\n            // Check if the confirmed message already exists\r\n            const isDuplicate = withoutOptimistic.some(m => \r\n              m.id && m.id === newMessage.id\r\n            );\r\n            \r\n            if (isDuplicate) {\r\n              console.log('[MessageContext] Confirmed message already exists, skipping');\r\n              return prev;\r\n            }\r\n            \r\n            const updatedMessages = {\r\n              ...prev,\r\n              [conversationKey]: [...withoutOptimistic, newMessage],\r\n            };\r\n            \r\n            console.log('[MessageContext] Replaced optimistic message with confirmed message');\r\n            \r\n            // Save to storage\r\n            storageService.setItem('panty_messages', updatedMessages).catch(err => \r\n              console.error('[MessageContext] Failed to save messages:', err)\r\n            );\r\n            \r\n            return updatedMessages;\r\n          }\r\n          \r\n          // Check if message already exists (by ID or by content+timestamp for duplicates)\r\n          const isDuplicate = existingMessages.some(m => {\r\n            if (m.id && m.id === newMessage.id) return true;\r\n            \r\n            // Check for duplicate by content and approximate time (within 2 seconds)\r\n            if (m.sender === newMessage.sender && \r\n                m.receiver === newMessage.receiver &&\r\n                m.content === newMessage.content) {\r\n              const timeDiff = Math.abs(new Date(m.date).getTime() - new Date(newMessage.date).getTime());\r\n              return timeDiff < 2000;\r\n            }\r\n            \r\n            return false;\r\n          });\r\n          \r\n          if (isDuplicate) {\r\n            console.log('[MessageContext] Duplicate message detected, skipping');\r\n            return prev;\r\n          }\r\n          \r\n          const updatedMessages = {\r\n            ...prev,\r\n            [conversationKey]: [...existingMessages, newMessage],\r\n          };\r\n          \r\n          console.log('[MessageContext] Added new message to conversation');\r\n          \r\n          // Save to storage\r\n          storageService.setItem('panty_messages', updatedMessages).catch(err => \r\n            console.error('[MessageContext] Failed to save messages:', err)\r\n          );\r\n          \r\n          return updatedMessages;\r\n        });\r\n        \r\n        // Force a re-render to ensure UI updates\r\n        setUpdateTrigger(prev => {\r\n          console.log('[MessageContext] Triggering update:', prev + 1);\r\n          return prev + 1;\r\n        });\r\n        \r\n        // Update notifications if it's not a custom request\r\n        if (data.type !== 'customRequest') {\r\n          setMessageNotifications(prev => {\r\n            const sellerNotifs = prev[data.receiver] || [];\r\n            const existingIndex = sellerNotifs.findIndex((n: MessageNotification) => n.buyer === data.sender);\r\n\r\n            if (existingIndex >= 0) {\r\n              const updated = [...sellerNotifs];\r\n              updated[existingIndex] = {\r\n                buyer: data.sender,\r\n                messageCount: updated[existingIndex].messageCount + 1,\r\n                lastMessage: data.content.substring(0, 50) + (data.content.length > 50 ? '...' : ''),\r\n                timestamp: new Date().toISOString()\r\n              };\r\n              return {\r\n                ...prev,\r\n                [data.receiver]: updated\r\n              };\r\n            } else {\r\n              return {\r\n                ...prev,\r\n                [data.receiver]: [...sellerNotifs, {\r\n                  buyer: data.sender,\r\n                  messageCount: 1,\r\n                  lastMessage: data.content.substring(0, 50) + (data.content.length > 50 ? '...' : ''),\r\n                  timestamp: new Date().toISOString()\r\n                }]\r\n              };\r\n            }\r\n          });\r\n        }\r\n        \r\n        // Emit a custom event for components to listen to\r\n        if (typeof window !== 'undefined') {\r\n          console.log('[MessageContext] Dispatching DOM event for new message');\r\n          window.dispatchEvent(new CustomEvent('message:new', { detail: newMessage }));\r\n        }\r\n      }\r\n    });\r\n\r\n    // Also listen for message:read events\r\n    const unsubscribeRead = subscribe('message:read' as WebSocketEvent, (data: any) => {\r\n      console.log('[MessageContext] Messages marked as read via WebSocket:', data);\r\n      \r\n      if (data && data.threadId && data.messageIds) {\r\n        setMessages(prev => {\r\n          const updatedMessages = { ...prev };\r\n          if (updatedMessages[data.threadId]) {\r\n            updatedMessages[data.threadId] = updatedMessages[data.threadId].map(msg => {\r\n              // Check both real ID and optimistic ID mapping\r\n              const realId = msg._optimisticId ? \r\n                optimisticMessageMap.current.get(msg._optimisticId) || msg.id : \r\n                msg.id;\r\n                \r\n              if (realId && data.messageIds.includes(realId)) {\r\n                return { ...msg, isRead: true, read: true };\r\n              }\r\n              return msg;\r\n            });\r\n          }\r\n          \r\n          // Save to storage\r\n          storageService.setItem('panty_messages', updatedMessages).catch(err => \r\n            console.error('[MessageContext] Failed to save messages after read update:', err)\r\n          );\r\n          \r\n          return updatedMessages;\r\n        });\r\n        \r\n        // Emit DOM event for read status update\r\n        if (typeof window !== 'undefined') {\r\n          window.dispatchEvent(new CustomEvent('message:read', { detail: data }));\r\n        }\r\n        \r\n        // Force a re-render\r\n        setUpdateTrigger(prev => prev + 1);\r\n      }\r\n    });\r\n\r\n    subscriptionsRef.current = [unsubscribeNewMessage, unsubscribeRead];\r\n\r\n    return () => {\r\n      console.log('[MessageContext] Cleaning up WebSocket listeners');\r\n      subscriptionsRef.current.forEach(unsub => unsub());\r\n      subscriptionsRef.current = [];\r\n    };\r\n  }, [subscribe, isConnected]);\r\n\r\n  // Save data whenever it changes\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined' && !isLoading) {\r\n      storageService.setItem('panty_messages', messages);\r\n    }\r\n  }, [messages, isLoading]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined' && !isLoading) {\r\n      storageService.setItem('panty_blocked', blockedUsers);\r\n    }\r\n  }, [blockedUsers, isLoading]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined' && !isLoading) {\r\n      storageService.setItem('panty_reported', reportedUsers);\r\n    }\r\n  }, [reportedUsers, isLoading]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined' && !isLoading) {\r\n      storageService.setItem('panty_report_logs', reportLogs);\r\n    }\r\n  }, [reportLogs, isLoading]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined' && !isLoading) {\r\n      storageService.setItem('panty_message_notifications', messageNotifications);\r\n    }\r\n  }, [messageNotifications, isLoading]);\r\n\r\n  // FIXED: Send message with optimistic ID tracking\r\n  const sendMessage = useCallback(async (\r\n    sender: string,\r\n    receiver: string,\r\n    content: string,\r\n    options?: MessageOptions\r\n  ) => {\r\n    // Validate inputs\r\n    if (!sender || !receiver) {\r\n      console.error('Invalid sender or receiver');\r\n      return;\r\n    }\r\n\r\n    if (!content.trim() && !options?.meta?.imageUrl) {\r\n      console.error('Cannot send empty message without image');\r\n      return;\r\n    }\r\n\r\n    // For image messages, allow empty content or provide default\r\n    let sanitizedContent = content;\r\n    if (options?.type === 'image' && !content.trim() && options?.meta?.imageUrl) {\r\n      sanitizedContent = 'Image shared';\r\n    }\r\n\r\n    // Validate message content only if we have content to validate\r\n    if (sanitizedContent.trim()) {\r\n      const contentValidation = messageSchemas.messageContent.safeParse(sanitizedContent);\r\n      if (!contentValidation.success) {\r\n        console.error('Invalid message content:', contentValidation.error);\r\n        return;\r\n      }\r\n      sanitizedContent = contentValidation.data;\r\n    }\r\n\r\n    // Validate and sanitize meta fields if present\r\n    let sanitizedMeta = options?.meta;\r\n    if (sanitizedMeta) {\r\n      sanitizedMeta = {\r\n        ...sanitizedMeta,\r\n        title: sanitizedMeta.title ? sanitizeStrict(sanitizedMeta.title) : undefined,\r\n        message: sanitizedMeta.message ? sanitizeStrict(sanitizedMeta.message) : undefined,\r\n        tags: sanitizedMeta.tags?.map(tag => sanitizeStrict(tag).slice(0, 30)),\r\n      };\r\n    }\r\n\r\n    try {\r\n      // Include optimistic ID if provided\r\n      const messageData = {\r\n        sender,\r\n        receiver,\r\n        content: sanitizedContent,\r\n        type: options?.type,\r\n        meta: sanitizedMeta,\r\n        _optimisticId: options?._optimisticId\r\n      };\r\n      \r\n      const result = await messagesService.sendMessage(messageData);\r\n\r\n      if (result.success && result.data) {\r\n        // DON'T add the message to local state here - let WebSocket handle it\r\n        // This prevents duplicates\r\n        console.log('Message sent successfully, waiting for WebSocket confirmation');\r\n        \r\n        // Only update notifications locally since WebSocket won't handle this\r\n        if (options?.type !== 'customRequest') {\r\n          setMessageNotifications(prev => {\r\n            const sellerNotifs = prev[receiver] || [];\r\n            const existingIndex = sellerNotifs.findIndex(n => n.buyer === sender);\r\n\r\n            if (existingIndex >= 0) {\r\n              const updated = [...sellerNotifs];\r\n              updated[existingIndex] = {\r\n                buyer: sender,\r\n                messageCount: updated[existingIndex].messageCount + 1,\r\n                lastMessage: sanitizedContent.substring(0, 50) + (sanitizedContent.length > 50 ? '...' : ''),\r\n                timestamp: new Date().toISOString()\r\n              };\r\n              return {\r\n                ...prev,\r\n                [receiver]: updated\r\n              };\r\n            } else {\r\n              return {\r\n                ...prev,\r\n                [receiver]: [...sellerNotifs, {\r\n                  buyer: sender,\r\n                  messageCount: 1,\r\n                  lastMessage: sanitizedContent.substring(0, 50) + (sanitizedContent.length > 50 ? '...' : ''),\r\n                  timestamp: new Date().toISOString()\r\n                }]\r\n              };\r\n            }\r\n          });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error sending message:', error);\r\n    }\r\n  }, []);\r\n\r\n  const sendCustomRequest = useCallback((\r\n    buyer: string,\r\n    seller: string,\r\n    content: string,\r\n    title: string,\r\n    price: number,\r\n    tags: string[],\r\n    listingId: string\r\n  ) => {\r\n    // Validate custom request data\r\n    const validation = customRequestMetaSchema.safeParse({\r\n      title,\r\n      price,\r\n      message: content,\r\n    });\r\n\r\n    if (!validation.success) {\r\n      console.error('Invalid custom request:', validation.error);\r\n      return;\r\n    }\r\n\r\n    sendMessage(buyer, seller, validation.data.message, {\r\n      type: 'customRequest',\r\n      meta: {\r\n        id: uuidv4(),\r\n        title: validation.data.title,\r\n        price: validation.data.price,\r\n        tags: tags.map(tag => sanitizeStrict(tag).slice(0, 30)),\r\n        message: validation.data.message,\r\n      },\r\n    });\r\n  }, [sendMessage]);\r\n\r\n  const getMessagesForUsers = useCallback((userA: string, userB: string): Message[] => {\r\n    const conversationKey = getConversationKey(userA, userB);\r\n    return messages[conversationKey] || [];\r\n  }, [messages, updateTrigger]); // Add updateTrigger to dependencies\r\n\r\n  const getThreadsForUser = useCallback((username: string, role?: 'buyer' | 'seller'): MessageThread => {\r\n    const threads: MessageThread = {};\r\n\r\n    Object.entries(messages).forEach(([key, msgs]) => {\r\n      msgs.forEach(msg => {\r\n        if (msg.sender === username || msg.receiver === username) {\r\n          const otherParty = msg.sender === username ? msg.receiver : msg.sender;\r\n          if (!threads[otherParty]) {\r\n            threads[otherParty] = [];\r\n          }\r\n          threads[otherParty].push(msg);\r\n        }\r\n      });\r\n    });\r\n\r\n    Object.values(threads).forEach(thread => {\r\n      thread.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());\r\n    });\r\n\r\n    return threads;\r\n  }, [messages, updateTrigger]); // Add updateTrigger to dependencies\r\n\r\n  const getThreadInfo = useCallback((username: string, otherParty: string): ThreadInfo => {\r\n    const conversationKey = getConversationKey(username, otherParty);\r\n    const threadMessages = messages[conversationKey] || [];\r\n\r\n    const unreadCount = threadMessages.filter(\r\n      msg => msg.receiver === username && !msg.read && !msg.isRead\r\n    ).length;\r\n\r\n    const lastMessage = threadMessages.length > 0 ?\r\n      threadMessages[threadMessages.length - 1] : null;\r\n\r\n    return {\r\n      unreadCount,\r\n      lastMessage,\r\n      otherParty\r\n    };\r\n  }, [messages, updateTrigger]); // Add updateTrigger to dependencies\r\n\r\n  const getAllThreadsInfo = useCallback((username: string, role?: 'buyer' | 'seller'): { [otherParty: string]: ThreadInfo } => {\r\n    const threads = getThreadsForUser(username, role);\r\n    const threadInfos: { [otherParty: string]: ThreadInfo } = {};\r\n\r\n    Object.keys(threads).forEach(otherParty => {\r\n      threadInfos[otherParty] = getThreadInfo(username, otherParty);\r\n    });\r\n\r\n    return threadInfos;\r\n  }, [getThreadsForUser, getThreadInfo]);\r\n\r\n  const markMessagesAsRead = useCallback(async (userA: string, userB: string) => {\r\n    try {\r\n      const result = await messagesService.markMessagesAsRead(userA, userB);\r\n      if (result.success) {\r\n        const conversationKey = getConversationKey(userA, userB);\r\n        setMessages(prev => {\r\n          const conversationMessages = prev[conversationKey] || [];\r\n          const updatedMessages = conversationMessages.map(msg =>\r\n            msg.receiver === userA && msg.sender === userB && !msg.read\r\n              ? { ...msg, read: true, isRead: true }\r\n              : msg\r\n          );\r\n\r\n          const updated = {\r\n            ...prev,\r\n            [conversationKey]: updatedMessages,\r\n          };\r\n          \r\n          // Save to storage\r\n          storageService.setItem('panty_messages', updated).catch(err => \r\n            console.error('[MessageContext] Failed to save messages after marking read:', err)\r\n          );\r\n          \r\n          return updated;\r\n        });\r\n\r\n        clearMessageNotifications(userA, userB);\r\n        \r\n        // Force a re-render\r\n        setUpdateTrigger(prev => prev + 1);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error marking messages as read:', error);\r\n    }\r\n  }, []);\r\n\r\n  const clearMessageNotifications = useCallback((seller: string, buyer: string) => {\r\n    setMessageNotifications(prev => {\r\n      const sellerNotifs = prev[seller] || [];\r\n      const filtered = sellerNotifs.filter(n => n.buyer !== buyer);\r\n\r\n      if (filtered.length === sellerNotifs.length) {\r\n        return prev;\r\n      }\r\n\r\n      return {\r\n        ...prev,\r\n        [seller]: filtered\r\n      };\r\n    });\r\n  }, []);\r\n\r\n  const blockUser = useCallback(async (blocker: string, blockee: string) => {\r\n    try {\r\n      const result = await messagesService.blockUser({\r\n        blocker,\r\n        blocked: blockee,\r\n      });\r\n\r\n      if (result.success) {\r\n        setBlockedUsers(prev => {\r\n          const blockerList = prev[blocker] || [];\r\n          if (!blockerList.includes(blockee)) {\r\n            return {\r\n              ...prev,\r\n              [blocker]: [...blockerList, blockee],\r\n            };\r\n          }\r\n          return prev;\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error('Error blocking user:', error);\r\n    }\r\n  }, []);\r\n\r\n  const unblockUser = useCallback(async (blocker: string, blockee: string) => {\r\n    try {\r\n      const result = await messagesService.unblockUser({\r\n        blocker,\r\n        blocked: blockee,\r\n      });\r\n\r\n      if (result.success) {\r\n        setBlockedUsers(prev => {\r\n          const blockerList = prev[blocker] || [];\r\n          return {\r\n            ...prev,\r\n            [blocker]: blockerList.filter(b => b !== blockee),\r\n          };\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error('Error unblocking user:', error);\r\n    }\r\n  }, []);\r\n\r\n  const reportUser = useCallback(async (reporter: string, reportee: string) => {\r\n    const conversationKey = getConversationKey(reporter, reportee);\r\n    const reportMessages = messages[conversationKey] || [];\r\n\r\n    try {\r\n      const result = await messagesService.reportUser({\r\n        reporter,\r\n        reportee,\r\n        messages: reportMessages,\r\n      });\r\n\r\n      if (result.success) {\r\n        setReportedUsers(prev => {\r\n          const reporterList = prev[reporter] || [];\r\n          if (!reporterList.includes(reportee)) {\r\n            return {\r\n              ...prev,\r\n              [reporter]: [...reporterList, reportee],\r\n            };\r\n          }\r\n          return prev;\r\n        });\r\n\r\n        const newReport: ReportLog = {\r\n          id: uuidv4(),\r\n          reporter,\r\n          reportee,\r\n          messages: reportMessages,\r\n          date: new Date().toISOString(),\r\n          processed: false,\r\n          category: 'other'\r\n        };\r\n\r\n        setReportLogs(prev => [...prev, newReport]);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error reporting user:', error);\r\n    }\r\n  }, [messages]);\r\n\r\n  const isBlocked = useCallback((blocker: string, blockee: string): boolean => {\r\n    return blockedUsers[blocker]?.includes(blockee) ?? false;\r\n  }, [blockedUsers]);\r\n\r\n  const hasReported = useCallback((reporter: string, reportee: string): boolean => {\r\n    return reportedUsers[reporter]?.includes(reportee) ?? false;\r\n  }, [reportedUsers]);\r\n\r\n  const getReportCount = useCallback((): number => {\r\n    return reportLogs.filter(report => !report.processed).length;\r\n  }, [reportLogs]);\r\n\r\n  // Add a method to force refresh messages\r\n  const refreshMessages = useCallback(() => {\r\n    console.log('[MessageContext] Force refresh triggered');\r\n    setUpdateTrigger(prev => prev + 1);\r\n  }, []);\r\n\r\n  return (\r\n    <MessageContext.Provider\r\n      value={{\r\n        messages,\r\n        isLoading,\r\n        sendMessage,\r\n        sendCustomRequest,\r\n        getMessagesForUsers,\r\n        getThreadsForUser,\r\n        getThreadInfo,\r\n        getAllThreadsInfo,\r\n        markMessagesAsRead,\r\n        blockUser,\r\n        unblockUser,\r\n        reportUser,\r\n        isBlocked,\r\n        hasReported,\r\n        getReportCount,\r\n        blockedUsers,\r\n        reportedUsers,\r\n        reportLogs,\r\n        messageNotifications,\r\n        clearMessageNotifications,\r\n        refreshMessages,\r\n      }}\r\n    >\r\n      {children}\r\n    </MessageContext.Provider>\r\n  );\r\n};\r\n\r\nexport const useMessages = () => {\r\n  const context = useContext(MessageContext);\r\n  if (!context) {\r\n    throw new Error('useMessages must be used within a MessageProvider');\r\n  }\r\n  return context;\r\n};\r\n\r\n// Enhanced external getReportCount function for header use\r\nexport const getReportCount = async (): Promise<number> => {\r\n  try {\r\n    if (typeof window === 'undefined') return 0;\r\n\r\n    const reports = await storageService.getItem<ReportLog[]>('panty_report_logs', []);\r\n    if (!Array.isArray(reports)) return 0;\r\n\r\n    const pendingReports = reports.filter(report =>\r\n      report &&\r\n      typeof report === 'object' &&\r\n      !report.processed\r\n    );\r\n\r\n    return pendingReports.length;\r\n  } catch (error) {\r\n    console.error('Error getting external report count:', error);\r\n    return 0;\r\n  }\r\n};"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 7938, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/ReviewContext.tsx"],"sourcesContent":["// src/context/ReviewContext.tsx\r\n'use client';\r\n\r\nimport { createContext, useContext, useState, useEffect, ReactNode, useCallback } from 'react';\r\nimport { reviewsService, Review as ServiceReview, ReviewStats } from '@/services/reviews.service';\r\nimport { useAuth } from './AuthContext';\r\nimport { sanitizeStrict } from '@/utils/security/sanitization';\r\nimport { z } from 'zod';\r\n\r\nexport type Review = {\r\n  _id?: string;\r\n  orderId?: string;\r\n  reviewer: string;\r\n  reviewee?: string;\r\n  rating: number;\r\n  comment: string;\r\n  date: string;\r\n  asDescribed?: boolean;\r\n  fastShipping?: boolean;\r\n  wouldBuyAgain?: boolean;\r\n  sellerResponse?: {\r\n    text: string;\r\n    date: string;\r\n  };\r\n};\r\n\r\n// Validation schema for reviews\r\nconst reviewSchema = z.object({\r\n  rating: z.number().int().min(1).max(5),\r\n  comment: z.string().min(10, 'Review must be at least 10 characters').max(500, 'Review must be less than 500 characters'),\r\n});\r\n\r\ntype ReviewContextType = {\r\n  getReviewsForSeller: (sellerUsername: string) => Promise<Review[]>;\r\n  addReview: (sellerUsername: string, orderId: string, review: Omit<Review, 'reviewer' | 'date'>) => Promise<boolean>;\r\n  hasReviewed: (orderId: string) => Promise<boolean>;\r\n  getReviewStats: (sellerUsername: string) => Promise<ReviewStats | null>;\r\n  isLoading: boolean;\r\n  error: string | null;\r\n};\r\n\r\nconst ReviewContext = createContext<ReviewContextType | undefined>(undefined);\r\n\r\nexport const ReviewProvider: React.FC<{ children: ReactNode }> = ({ children }) => {\r\n  const [cachedReviews, setCachedReviews] = useState<{ [seller: string]: Review[] }>({});\r\n  const [cachedStats, setCachedStats] = useState<{ [seller: string]: ReviewStats }>({});\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const { user } = useAuth();\r\n\r\n  // Clear cache when user changes\r\n  useEffect(() => {\r\n    setCachedReviews({});\r\n    setCachedStats({});\r\n  }, [user?.username]);\r\n\r\n  const getReviewsForSeller = useCallback(async (sellerUsername: string): Promise<Review[]> => {\r\n    try {\r\n      setIsLoading(true);\r\n      setError(null);\r\n\r\n      // Check cache first\r\n      if (cachedReviews[sellerUsername]) {\r\n        return cachedReviews[sellerUsername];\r\n      }\r\n\r\n      // Fetch from API\r\n      const response = await reviewsService.getSellerReviews(sellerUsername);\r\n      \r\n      if (response.success && response.data) {\r\n        const reviews: Review[] = response.data.reviews.map(r => ({\r\n          _id: r._id,\r\n          orderId: r.orderId,\r\n          reviewer: r.reviewer,\r\n          reviewee: r.reviewee,\r\n          rating: r.rating,\r\n          comment: r.comment,\r\n          date: r.createdAt,\r\n          asDescribed: r.asDescribed,\r\n          fastShipping: r.fastShipping,\r\n          wouldBuyAgain: r.wouldBuyAgain,\r\n          sellerResponse: r.sellerResponse,\r\n        }));\r\n\r\n        // Update cache\r\n        setCachedReviews(prev => ({\r\n          ...prev,\r\n          [sellerUsername]: reviews\r\n        }));\r\n\r\n        // Cache stats too\r\n        if (response.data.stats) {\r\n          setCachedStats(prev => ({\r\n            ...prev,\r\n            [sellerUsername]: response.data!.stats\r\n          }));\r\n        }\r\n\r\n        return reviews;\r\n      } else {\r\n        setError(response.error?.message || 'Failed to fetch reviews');\r\n        return [];\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching reviews:', error);\r\n      setError('Failed to fetch reviews');\r\n      return [];\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [cachedReviews]);\r\n\r\n  const addReview = useCallback(async (\r\n    sellerUsername: string, \r\n    orderId: string,\r\n    review: Omit<Review, 'reviewer' | 'date'>\r\n  ): Promise<boolean> => {\r\n    try {\r\n      setIsLoading(true);\r\n      setError(null);\r\n\r\n      if (!user?.username) {\r\n        setError('You must be logged in to submit a review');\r\n        return false;\r\n      }\r\n\r\n      // Validate review data\r\n      const validation = reviewSchema.safeParse({\r\n        rating: review.rating,\r\n        comment: review.comment,\r\n      });\r\n\r\n      if (!validation.success) {\r\n        setError(validation.error.errors[0]?.message || 'Invalid review');\r\n        return false;\r\n      }\r\n\r\n      // Create review via API\r\n      const response = await reviewsService.createReview({\r\n        orderId,\r\n        rating: validation.data.rating,\r\n        comment: sanitizeStrict(validation.data.comment),\r\n        asDescribed: review.asDescribed !== false,\r\n        fastShipping: review.fastShipping !== false,\r\n        wouldBuyAgain: review.wouldBuyAgain !== false,\r\n      });\r\n\r\n      if (response.success) {\r\n        // Clear cache for this seller to force refresh\r\n        setCachedReviews(prev => {\r\n          const updated = { ...prev };\r\n          delete updated[sellerUsername];\r\n          return updated;\r\n        });\r\n        setCachedStats(prev => {\r\n          const updated = { ...prev };\r\n          delete updated[sellerUsername];\r\n          return updated;\r\n        });\r\n        \r\n        return true;\r\n      } else {\r\n        setError(response.error?.message || 'Failed to create review');\r\n        return false;\r\n      }\r\n    } catch (error) {\r\n      console.error('Error adding review:', error);\r\n      setError('Failed to add review');\r\n      return false;\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [user?.username]);\r\n\r\n  const hasReviewed = useCallback(async (orderId: string): Promise<boolean> => {\r\n    try {\r\n      setIsLoading(true);\r\n      setError(null);\r\n\r\n      const response = await reviewsService.checkOrderReview(orderId);\r\n      \r\n      if (response.success && response.data) {\r\n        return response.data.hasReview;\r\n      }\r\n      \r\n      return false;\r\n    } catch (error) {\r\n      console.error('Error checking review status:', error);\r\n      return false;\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, []);\r\n\r\n  const getReviewStats = useCallback(async (sellerUsername: string): Promise<ReviewStats | null> => {\r\n    try {\r\n      // Check cache first\r\n      if (cachedStats[sellerUsername]) {\r\n        return cachedStats[sellerUsername];\r\n      }\r\n\r\n      // If not in cache, fetch reviews which will also cache stats\r\n      await getReviewsForSeller(sellerUsername);\r\n      \r\n      return cachedStats[sellerUsername] || null;\r\n    } catch (error) {\r\n      console.error('Error getting review stats:', error);\r\n      return null;\r\n    }\r\n  }, [cachedStats, getReviewsForSeller]);\r\n\r\n  return (\r\n    <ReviewContext.Provider value={{ \r\n      getReviewsForSeller, \r\n      addReview, \r\n      hasReviewed,\r\n      getReviewStats,\r\n      isLoading,\r\n      error\r\n    }}>\r\n      {children}\r\n    </ReviewContext.Provider>\r\n  );\r\n};\r\n\r\nexport const useReviews = () => {\r\n  const context = useContext(ReviewContext);\r\n  if (!context) throw new Error('useReviews must be used within a ReviewProvider');\r\n  return context;\r\n};\r\n"],"names":[],"mappings":"AAAA,gCAAgC;;;;;;AAGhC;AACA;AACA;AACA;AACA;;;AANA;;;;;;AAyBA,gCAAgC;AAChC,MAAM,eAAe,qKAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IAC5B,QAAQ,qKAAA,CAAA,IAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC;IACpC,SAAS,qKAAA,CAAA,IAAC,CAAC,MAAM,GAAG,GAAG,CAAC,IAAI,yCAAyC,GAAG,CAAC,KAAK;AAChF;AAWA,MAAM,8BAAgB,CAAA,GAAA,6JAAA,CAAA,gBAAa,AAAD,EAAiC;AAE5D,MAAM,iBAAoD;QAAC,EAAE,QAAQ,EAAE;;IAC5E,MAAM,CAAC,eAAe,iBAAiB,GAAG,CAAA,GAAA,6JAAA,CAAA,WAAQ,AAAD,EAAkC,CAAC;IACpF,MAAM,CAAC,aAAa,eAAe,GAAG,CAAA,GAAA,6JAAA,CAAA,WAAQ,AAAD,EAAqC,CAAC;IACnF,MAAM,CAAC,WAAW,aAAa,GAAG,CAAA,GAAA,6JAAA,CAAA,WAAQ,AAAD,EAAE;IAC3C,MAAM,CAAC,OAAO,SAAS,GAAG,CAAA,GAAA,6JAAA,CAAA,WAAQ,AAAD,EAAiB;IAClD,MAAM,EAAE,IAAI,EAAE,GAAG,CAAA,GAAA,iIAAA,CAAA,UAAO,AAAD;IAEvB,gCAAgC;IAChC,CAAA,GAAA,6JAAA,CAAA,YAAS,AAAD;oCAAE;YACR,iBAAiB,CAAC;YAClB,eAAe,CAAC;QAClB;mCAAG;QAAC,iBAAA,2BAAA,KAAM,QAAQ;KAAC;IAEnB,MAAM,sBAAsB,CAAA,GAAA,6JAAA,CAAA,cAAW,AAAD;2DAAE,OAAO;YAC7C,IAAI;gBACF,aAAa;gBACb,SAAS;gBAET,oBAAoB;gBACpB,IAAI,aAAa,CAAC,eAAe,EAAE;oBACjC,OAAO,aAAa,CAAC,eAAe;gBACtC;gBAEA,iBAAiB;gBACjB,MAAM,WAAW,MAAM,wIAAA,CAAA,iBAAc,CAAC,gBAAgB,CAAC;gBAEvD,IAAI,SAAS,OAAO,IAAI,SAAS,IAAI,EAAE;oBACrC,MAAM,UAAoB,SAAS,IAAI,CAAC,OAAO,CAAC,GAAG;mFAAC,CAAA,IAAK,CAAC;gCACxD,KAAK,EAAE,GAAG;gCACV,SAAS,EAAE,OAAO;gCAClB,UAAU,EAAE,QAAQ;gCACpB,UAAU,EAAE,QAAQ;gCACpB,QAAQ,EAAE,MAAM;gCAChB,SAAS,EAAE,OAAO;gCAClB,MAAM,EAAE,SAAS;gCACjB,aAAa,EAAE,WAAW;gCAC1B,cAAc,EAAE,YAAY;gCAC5B,eAAe,EAAE,aAAa;gCAC9B,gBAAgB,EAAE,cAAc;4BAClC,CAAC;;oBAED,eAAe;oBACf;2EAAiB,CAAA,OAAQ,CAAC;gCACxB,GAAG,IAAI;gCACP,CAAC,eAAe,EAAE;4BACpB,CAAC;;oBAED,kBAAkB;oBAClB,IAAI,SAAS,IAAI,CAAC,KAAK,EAAE;wBACvB;+EAAe,CAAA,OAAQ,CAAC;oCACtB,GAAG,IAAI;oCACP,CAAC,eAAe,EAAE,SAAS,IAAI,CAAE,KAAK;gCACxC,CAAC;;oBACH;oBAEA,OAAO;gBACT,OAAO;wBACI;oBAAT,SAAS,EAAA,kBAAA,SAAS,KAAK,cAAd,sCAAA,gBAAgB,OAAO,KAAI;oBACpC,OAAO,EAAE;gBACX;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,2BAA2B;gBACzC,SAAS;gBACT,OAAO,EAAE;YACX,SAAU;gBACR,aAAa;YACf;QACF;0DAAG;QAAC;KAAc;IAElB,MAAM,YAAY,CAAA,GAAA,6JAAA,CAAA,cAAW,AAAD;iDAAE,OAC5B,gBACA,SACA;YAEA,IAAI;gBACF,aAAa;gBACb,SAAS;gBAET,IAAI,EAAC,iBAAA,2BAAA,KAAM,QAAQ,GAAE;oBACnB,SAAS;oBACT,OAAO;gBACT;gBAEA,uBAAuB;gBACvB,MAAM,aAAa,aAAa,SAAS,CAAC;oBACxC,QAAQ,OAAO,MAAM;oBACrB,SAAS,OAAO,OAAO;gBACzB;gBAEA,IAAI,CAAC,WAAW,OAAO,EAAE;wBACd;oBAAT,SAAS,EAAA,4BAAA,WAAW,KAAK,CAAC,MAAM,CAAC,EAAE,cAA1B,gDAAA,0BAA4B,OAAO,KAAI;oBAChD,OAAO;gBACT;gBAEA,wBAAwB;gBACxB,MAAM,WAAW,MAAM,wIAAA,CAAA,iBAAc,CAAC,YAAY,CAAC;oBACjD;oBACA,QAAQ,WAAW,IAAI,CAAC,MAAM;oBAC9B,SAAS,CAAA,GAAA,2IAAA,CAAA,iBAAc,AAAD,EAAE,WAAW,IAAI,CAAC,OAAO;oBAC/C,aAAa,OAAO,WAAW,KAAK;oBACpC,cAAc,OAAO,YAAY,KAAK;oBACtC,eAAe,OAAO,aAAa,KAAK;gBAC1C;gBAEA,IAAI,SAAS,OAAO,EAAE;oBACpB,+CAA+C;oBAC/C;iEAAiB,CAAA;4BACf,MAAM,UAAU;gCAAE,GAAG,IAAI;4BAAC;4BAC1B,OAAO,OAAO,CAAC,eAAe;4BAC9B,OAAO;wBACT;;oBACA;iEAAe,CAAA;4BACb,MAAM,UAAU;gCAAE,GAAG,IAAI;4BAAC;4BAC1B,OAAO,OAAO,CAAC,eAAe;4BAC9B,OAAO;wBACT;;oBAEA,OAAO;gBACT,OAAO;wBACI;oBAAT,SAAS,EAAA,kBAAA,SAAS,KAAK,cAAd,sCAAA,gBAAgB,OAAO,KAAI;oBACpC,OAAO;gBACT;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,wBAAwB;gBACtC,SAAS;gBACT,OAAO;YACT,SAAU;gBACR,aAAa;YACf;QACF;gDAAG;QAAC,iBAAA,2BAAA,KAAM,QAAQ;KAAC;IAEnB,MAAM,cAAc,CAAA,GAAA,6JAAA,CAAA,cAAW,AAAD;mDAAE,OAAO;YACrC,IAAI;gBACF,aAAa;gBACb,SAAS;gBAET,MAAM,WAAW,MAAM,wIAAA,CAAA,iBAAc,CAAC,gBAAgB,CAAC;gBAEvD,IAAI,SAAS,OAAO,IAAI,SAAS,IAAI,EAAE;oBACrC,OAAO,SAAS,IAAI,CAAC,SAAS;gBAChC;gBAEA,OAAO;YACT,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,iCAAiC;gBAC/C,OAAO;YACT,SAAU;gBACR,aAAa;YACf;QACF;kDAAG,EAAE;IAEL,MAAM,iBAAiB,CAAA,GAAA,6JAAA,CAAA,cAAW,AAAD;sDAAE,OAAO;YACxC,IAAI;gBACF,oBAAoB;gBACpB,IAAI,WAAW,CAAC,eAAe,EAAE;oBAC/B,OAAO,WAAW,CAAC,eAAe;gBACpC;gBAEA,6DAA6D;gBAC7D,MAAM,oBAAoB;gBAE1B,OAAO,WAAW,CAAC,eAAe,IAAI;YACxC,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,+BAA+B;gBAC7C,OAAO;YACT;QACF;qDAAG;QAAC;QAAa;KAAoB;IAErC,qBACE,6LAAC,cAAc,QAAQ;QAAC,OAAO;YAC7B;YACA;YACA;YACA;YACA;YACA;QACF;kBACG;;;;;;AAGP;GApLa;;QAKM,iIAAA,CAAA,UAAO;;;KALb;AAsLN,MAAM,aAAa;;IACxB,MAAM,UAAU,CAAA,GAAA,6JAAA,CAAA,aAAU,AAAD,EAAE;IAC3B,IAAI,CAAC,SAAS,MAAM,IAAI,MAAM;IAC9B,OAAO;AACT;IAJa","debugId":null}},
    {"offset": {"line": 8182, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/RequestContext.tsx"],"sourcesContent":["// src/context/RequestContext.tsx\r\n\"use client\";\r\n\r\nimport React, { createContext, useContext, useState, useEffect } from \"react\";\r\nimport { storageService } from '@/services';\r\nimport { sanitizeStrict } from '@/utils/security/sanitization';\r\nimport { messageSchemas } from '@/utils/validation/schemas';\r\nimport { z } from 'zod';\r\n\r\nexport type RequestStatus = 'pending' | 'accepted' | 'rejected' | 'edited' | 'paid';\r\n\r\nexport type CustomRequest = {\r\n  id: string;\r\n  buyer: string;\r\n  seller: string;\r\n  title: string;\r\n  description: string;\r\n  price: number;\r\n  tags: string[];\r\n  status: RequestStatus;\r\n  date: string;\r\n  response?: string;\r\n  paid?: boolean;\r\n  // Add these fields to track the message-based flow\r\n  messageThreadId?: string; // Links to the conversation\r\n  lastModifiedBy?: string; // Who made the last edit\r\n  originalMessageId?: string; // Reference to original message\r\n  lastEditedBy?: string; // NEW: Track who last edited (buyer or seller)\r\n  pendingWith?: string; // NEW: Track who needs to respond (buyer or seller)\r\n};\r\n\r\n// Validation schemas\r\nconst requestSchema = z.object({\r\n  title: messageSchemas.customRequest.shape.title,\r\n  description: messageSchemas.customRequest.shape.description,\r\n  price: messageSchemas.customRequest.shape.price,\r\n  tags: z.array(z.string().max(30)).max(10).optional(),\r\n});\r\n\r\nconst responseSchema = z.string().min(1).max(500);\r\n\r\ntype RequestContextType = {\r\n  requests: CustomRequest[];\r\n  setRequests: React.Dispatch<React.SetStateAction<CustomRequest[]>>;\r\n  addRequest: (req: CustomRequest) => void;\r\n  getRequestsForUser: (username: string, role: 'buyer' | 'seller') => CustomRequest[];\r\n  getRequestById: (id: string) => CustomRequest | undefined;\r\n  respondToRequest: (\r\n    id: string,\r\n    status: RequestStatus,\r\n    response?: string,\r\n    updateFields?: Partial<Pick<CustomRequest, 'title' | 'price' | 'tags' | 'description'>>,\r\n    modifiedBy?: string\r\n  ) => void;\r\n  markRequestAsPaid: (id: string) => void;\r\n  // Helper functions for message-based workflow\r\n  getActiveRequestsForThread: (buyer: string, seller: string) => CustomRequest[];\r\n  getLatestRequestInThread: (buyer: string, seller: string) => CustomRequest | undefined;\r\n};\r\n\r\nconst RequestContext = createContext<RequestContextType | undefined>(undefined);\r\n\r\nexport const useRequests = () => {\r\n  const ctx = useContext(RequestContext);\r\n  if (!ctx) throw new Error('useRequests must be used within a RequestProvider');\r\n  return ctx;\r\n};\r\n\r\nexport const RequestProvider = ({ children }: { children: React.ReactNode }) => {\r\n  const [requests, setRequests] = useState<CustomRequest[]>([]);\r\n  const [isInitialized, setIsInitialized] = useState(false);\r\n\r\n  // Load initial data from localStorage using service\r\n  useEffect(() => {\r\n    const loadData = async () => {\r\n      if (typeof window === 'undefined' || isInitialized) return;\r\n      \r\n      try {\r\n        const stored = await storageService.getItem<CustomRequest[]>('panty_custom_requests', []);\r\n        \r\n        // Migrate and sanitize old requests\r\n        const migratedRequests = stored.map((req: any) => ({\r\n          ...req,\r\n          title: sanitizeStrict(req.title || ''),\r\n          description: sanitizeStrict(req.description || ''),\r\n          response: req.response ? sanitizeStrict(req.response) : undefined,\r\n          tags: Array.isArray(req.tags) ? req.tags.map((tag: string) => sanitizeStrict(tag).slice(0, 30)) : [],\r\n          messageThreadId: req.messageThreadId || `${req.buyer}-${req.seller}`,\r\n          lastModifiedBy: req.lastModifiedBy || req.buyer,\r\n          originalMessageId: req.originalMessageId || req.id,\r\n          lastEditedBy: req.lastEditedBy || req.buyer,\r\n          pendingWith: req.pendingWith || req.seller\r\n        }));\r\n        \r\n        setRequests(migratedRequests);\r\n        setIsInitialized(true);\r\n      } catch (error) {\r\n        console.error('Error loading requests from localStorage:', error);\r\n        setIsInitialized(true);\r\n      }\r\n    };\r\n\r\n    loadData();\r\n  }, [isInitialized]);\r\n\r\n  // Save to localStorage whenever requests change using service\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined' && isInitialized) {\r\n      storageService.setItem('panty_custom_requests', requests);\r\n    }\r\n  }, [requests, isInitialized]);\r\n\r\n  const addRequest = (req: CustomRequest) => {\r\n    // Validate request data\r\n    const validation = requestSchema.safeParse({\r\n      title: req.title,\r\n      description: req.description,\r\n      price: req.price,\r\n      tags: req.tags,\r\n    });\r\n\r\n    if (!validation.success) {\r\n      console.error('Invalid request data:', validation.error);\r\n      return;\r\n    }\r\n\r\n    const requestWithDefaults = {\r\n      ...req,\r\n      title: sanitizeStrict(validation.data.title),\r\n      description: sanitizeStrict(validation.data.description),\r\n      price: validation.data.price,\r\n      tags: validation.data.tags?.map(tag => sanitizeStrict(tag).slice(0, 30)) || [],\r\n      messageThreadId: req.messageThreadId || `${req.buyer}-${req.seller}`,\r\n      lastModifiedBy: req.lastModifiedBy || req.buyer,\r\n      originalMessageId: req.originalMessageId || req.id,\r\n      lastEditedBy: req.buyer,\r\n      pendingWith: req.seller\r\n    };\r\n    setRequests((prev) => [...prev, requestWithDefaults]);\r\n  };\r\n\r\n  const getRequestsForUser = (username: string, role: 'buyer' | 'seller') => {\r\n    return requests.filter((r) => r[role] === username);\r\n  };\r\n\r\n  const getRequestById = (id: string) => {\r\n    return requests.find((r) => r.id === id);\r\n  };\r\n\r\n  // Enhanced respond function that tracks who made the last modification\r\n  const respondToRequest = (\r\n    id: string,\r\n    status: RequestStatus,\r\n    response?: string,\r\n    updateFields?: Partial<Pick<CustomRequest, 'title' | 'price' | 'tags' | 'description'>>,\r\n    modifiedBy?: string\r\n  ) => {\r\n    // Validate response if provided\r\n    if (response) {\r\n      const responseValidation = responseSchema.safeParse(response);\r\n      if (!responseValidation.success) {\r\n        console.error('Invalid response:', responseValidation.error);\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Validate update fields if provided\r\n    if (updateFields) {\r\n      const updateValidation = requestSchema.partial().safeParse(updateFields);\r\n      if (!updateValidation.success) {\r\n        console.error('Invalid update fields:', updateValidation.error);\r\n        return;\r\n      }\r\n    }\r\n\r\n    setRequests((prev) =>\r\n      prev.map((r) => {\r\n        if (r.id !== id) return r;\r\n        \r\n        // Determine who it's pending with based on who modified it\r\n        let pendingWith = r.pendingWith;\r\n        let lastEditedBy = r.lastEditedBy;\r\n        \r\n        if (status === 'edited' && modifiedBy) {\r\n          // If edited, it's pending with the other party\r\n          pendingWith = modifiedBy === r.buyer ? r.seller : r.buyer;\r\n          lastEditedBy = modifiedBy;\r\n        } else if (status === 'accepted' || status === 'rejected') {\r\n          // No longer pending with anyone\r\n          pendingWith = undefined;\r\n        }\r\n        \r\n        return {\r\n          ...r,\r\n          status,\r\n          response: response ? sanitizeStrict(response) : r.response,\r\n          lastModifiedBy: modifiedBy || r.lastModifiedBy,\r\n          lastEditedBy: status === 'edited' ? lastEditedBy : r.lastEditedBy,\r\n          pendingWith,\r\n          ...(updateFields ? {\r\n            title: updateFields.title ? sanitizeStrict(updateFields.title) : r.title,\r\n            description: updateFields.description ? sanitizeStrict(updateFields.description) : r.description,\r\n            price: updateFields.price ?? r.price,\r\n            tags: updateFields.tags?.map(tag => sanitizeStrict(tag).slice(0, 30)) || r.tags,\r\n          } : {}),\r\n        };\r\n      })\r\n    );\r\n  };\r\n\r\n  // Mark request as paid (when payment is processed)\r\n  const markRequestAsPaid = (id: string) => {\r\n    setRequests((prev) =>\r\n      prev.map((r) =>\r\n        r.id === id\r\n          ? {\r\n              ...r,\r\n              status: 'paid' as RequestStatus,\r\n              paid: true,\r\n              pendingWith: undefined\r\n            }\r\n          : r\r\n      )\r\n    );\r\n  };\r\n\r\n  // Get all active requests between two users\r\n  const getActiveRequestsForThread = (buyer: string, seller: string) => {\r\n    return requests.filter((r) => \r\n      r.buyer === buyer && \r\n      r.seller === seller && \r\n      r.status !== 'rejected' && \r\n      r.status !== 'paid'\r\n    );\r\n  };\r\n\r\n  // Get the most recent request in a conversation thread\r\n  const getLatestRequestInThread = (buyer: string, seller: string) => {\r\n    const threadRequests = requests\r\n      .filter((r) => r.buyer === buyer && r.seller === seller)\r\n      .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());\r\n    \r\n    return threadRequests[0];\r\n  };\r\n\r\n  return (\r\n    <RequestContext.Provider\r\n      value={{\r\n        requests,\r\n        setRequests,\r\n        addRequest,\r\n        getRequestsForUser,\r\n        getRequestById,\r\n        respondToRequest,\r\n        markRequestAsPaid,\r\n        getActiveRequestsForThread,\r\n        getLatestRequestInThread,\r\n      }}\r\n    >\r\n      {children}\r\n    </RequestContext.Provider>\r\n  );\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 8407, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/LoadingContext.tsx"],"sourcesContent":["// src/context/LoadingContext.tsx\r\n'use client';\r\n\r\nimport React, { createContext, useContext, useState, useCallback, useRef } from 'react';\r\nimport { Loader2 } from 'lucide-react';\r\n\r\ninterface LoadingState {\r\n  isLoading: boolean;\r\n  message?: string;\r\n  progress?: number;\r\n}\r\n\r\ninterface LoadingContextType {\r\n  // Global loading state\r\n  globalLoading: LoadingState;\r\n  setGlobalLoading: (loading: boolean, message?: string, progress?: number) => void;\r\n  \r\n  // Named loading states (for specific features)\r\n  loadingStates: Map<string, LoadingState>;\r\n  setLoading: (key: string, loading: boolean, message?: string, progress?: number) => void;\r\n  isLoading: (key: string) => boolean;\r\n  \r\n  // Utilities\r\n  withLoading: <T>(\r\n    key: string,\r\n    fn: () => Promise<T>,\r\n    message?: string\r\n  ) => Promise<T>;\r\n  clearAllLoading: () => void;\r\n}\r\n\r\nconst LoadingContext = createContext<LoadingContextType | undefined>(undefined);\r\n\r\nexport function LoadingProvider({ children }: { children: React.ReactNode }) {\r\n  const [globalLoading, setGlobalLoadingState] = useState<LoadingState>({\r\n    isLoading: false,\r\n  });\r\n  \r\n  const [loadingStates] = useState<Map<string, LoadingState>>(new Map());\r\n  const [, forceUpdate] = useState({});\r\n  const loadingCountRef = useRef<Map<string, number>>(new Map());\r\n\r\n  // Set global loading\r\n  const setGlobalLoading = useCallback((\r\n    isLoading: boolean,\r\n    message?: string,\r\n    progress?: number\r\n  ) => {\r\n    setGlobalLoadingState({ isLoading, message, progress });\r\n  }, []);\r\n\r\n  // Set named loading state\r\n  const setLoading = useCallback((\r\n    key: string,\r\n    isLoading: boolean,\r\n    message?: string,\r\n    progress?: number\r\n  ) => {\r\n    if (isLoading) {\r\n      // Increment loading count for this key\r\n      const currentCount = loadingCountRef.current.get(key) || 0;\r\n      loadingCountRef.current.set(key, currentCount + 1);\r\n      \r\n      loadingStates.set(key, { isLoading: true, message, progress });\r\n    } else {\r\n      // Decrement loading count\r\n      const currentCount = loadingCountRef.current.get(key) || 0;\r\n      const newCount = Math.max(0, currentCount - 1);\r\n      \r\n      if (newCount === 0) {\r\n        loadingStates.delete(key);\r\n        loadingCountRef.current.delete(key);\r\n      } else {\r\n        loadingCountRef.current.set(key, newCount);\r\n      }\r\n    }\r\n    \r\n    forceUpdate({});\r\n  }, [loadingStates]);\r\n\r\n  // Check if specific key is loading\r\n  const isLoading = useCallback((key: string): boolean => {\r\n    return loadingStates.has(key);\r\n  }, [loadingStates]);\r\n\r\n  // Execute function with loading state\r\n  const withLoading = useCallback(async <T,>(\r\n    key: string,\r\n    fn: () => Promise<T>,\r\n    message?: string\r\n  ): Promise<T> => {\r\n    setLoading(key, true, message);\r\n    try {\r\n      return await fn();\r\n    } finally {\r\n      setLoading(key, false);\r\n    }\r\n  }, [setLoading]);\r\n\r\n  // Clear all loading states\r\n  const clearAllLoading = useCallback(() => {\r\n    loadingStates.clear();\r\n    loadingCountRef.current.clear();\r\n    setGlobalLoadingState({ isLoading: false });\r\n    forceUpdate({});\r\n  }, [loadingStates]);\r\n\r\n  const value: LoadingContextType = {\r\n    globalLoading,\r\n    setGlobalLoading,\r\n    loadingStates,\r\n    setLoading,\r\n    isLoading,\r\n    withLoading,\r\n    clearAllLoading,\r\n  };\r\n\r\n  return (\r\n    <LoadingContext.Provider value={value}>\r\n      {children}\r\n      {globalLoading.isLoading && <GlobalLoadingOverlay {...globalLoading} />}\r\n    </LoadingContext.Provider>\r\n  );\r\n}\r\n\r\n// Global Loading Overlay Component\r\nfunction GlobalLoadingOverlay({ message, progress }: LoadingState) {\r\n  return (\r\n    <div className=\"fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm\">\r\n      <div className=\"bg-[#1a1a1a] border border-gray-800 rounded-lg p-6 shadow-xl\">\r\n        <div className=\"flex flex-col items-center gap-4\">\r\n          <Loader2 className=\"w-10 h-10 text-[#ff950e] animate-spin\" />\r\n          \r\n          {message && (\r\n            <p className=\"text-white text-sm font-medium\">{message}</p>\r\n          )}\r\n          \r\n          {progress !== undefined && (\r\n            <div className=\"w-48\">\r\n              <div className=\"bg-gray-800 rounded-full h-2 overflow-hidden\">\r\n                <div\r\n                  className=\"bg-[#ff950e] h-full transition-all duration-300\"\r\n                  style={{ width: `${Math.min(100, Math.max(0, progress))}%` }}\r\n                />\r\n              </div>\r\n              <p className=\"text-gray-400 text-xs mt-1 text-center\">\r\n                {Math.round(progress)}%\r\n              </p>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// Hook to use loading\r\nexport function useLoading() {\r\n  const context = useContext(LoadingContext);\r\n  if (!context) {\r\n    throw new Error('useLoading must be used within a LoadingProvider');\r\n  }\r\n  return context;\r\n}\r\n\r\n// Loading Spinner Component\r\nexport function LoadingSpinner({ \r\n  size = 'md',\r\n  className = '' \r\n}: { \r\n  size?: 'sm' | 'md' | 'lg';\r\n  className?: string;\r\n}) {\r\n  const sizeClasses = {\r\n    sm: 'w-4 h-4',\r\n    md: 'w-6 h-6',\r\n    lg: 'w-8 h-8',\r\n  };\r\n\r\n  return (\r\n    <Loader2 className={`animate-spin text-[#ff950e] ${sizeClasses[size]} ${className}`} />\r\n  );\r\n}\r\n\r\n// Loading Button Component\r\nexport function LoadingButton({\r\n  isLoading,\r\n  children,\r\n  loadingText,\r\n  className = '',\r\n  ...props\r\n}: React.ButtonHTMLAttributes<HTMLButtonElement> & {\r\n  isLoading: boolean;\r\n  loadingText?: string;\r\n}) {\r\n  return (\r\n    <button\r\n      disabled={isLoading}\r\n      className={`relative ${className}`}\r\n      {...props}\r\n    >\r\n      {isLoading ? (\r\n        <span className=\"flex items-center justify-center gap-2\">\r\n          <LoadingSpinner size=\"sm\" />\r\n          {loadingText || 'Loading...'}\r\n        </span>\r\n      ) : (\r\n        children\r\n      )}\r\n    </button>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 8682, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/FavoritesContext.tsx"],"sourcesContent":["// src/context/FavoritesContext.tsx\r\n'use client';\r\n\r\nimport React, { createContext, useContext, useState, useEffect, ReactNode, useCallback } from 'react';\r\nimport { useAuth } from './AuthContext';\r\nimport { storageService } from '@/services';\r\nimport { favoritesService } from '@/services/favorites.service';\r\nimport { sanitizeUsername, sanitizeStrict } from '@/utils/security/sanitization';\r\nimport { getRateLimiter } from '@/utils/security/rate-limiter';\r\nimport { FEATURES } from '@/services/api.config';\r\n\r\nexport interface FavoriteSeller {\r\n  sellerId: string;\r\n  sellerUsername: string;\r\n  addedAt: string;\r\n  profilePicture?: string;\r\n  tier?: string;\r\n  isVerified: boolean;\r\n}\r\n\r\ninterface FavoritesContextType {\r\n  favorites: FavoriteSeller[];\r\n  favoriteCount: number;\r\n  isFavorited: (sellerId: string) => boolean;\r\n  toggleFavorite: (seller: {\r\n    id: string;\r\n    username: string;\r\n    profilePicture?: string;\r\n    tier?: string;\r\n    isVerified: boolean;\r\n  }) => Promise<boolean>;\r\n  loadingFavorites: boolean;\r\n  error: string | null;\r\n  clearError: () => void;\r\n  refreshFavorites: () => Promise<void>;\r\n}\r\n\r\nconst FavoritesContext = createContext<FavoritesContextType | undefined>(undefined);\r\n\r\nexport function FavoritesProvider({ children }: { children: ReactNode }) {\r\n  const { user } = useAuth();\r\n  const [favorites, setFavorites] = useState<FavoriteSeller[]>([]);\r\n  const [loadingFavorites, setLoadingFavorites] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const rateLimiter = getRateLimiter();\r\n\r\n  // Storage key based on username\r\n  const getStorageKey = useCallback((username: string) => {\r\n    return `favorites_${sanitizeUsername(username)}`;\r\n  }, []);\r\n\r\n  // Load favorites from API or localStorage\r\n  const loadFavorites = useCallback(async () => {\r\n    if (!user?.username) {\r\n      setFavorites([]);\r\n      return;\r\n    }\r\n\r\n    setLoadingFavorites(true);\r\n    try {\r\n      if (FEATURES.USE_API_USERS) {\r\n        // Load from API\r\n        const response = await favoritesService.getFavorites(user.username);\r\n        \r\n        if (response.success && response.data) {\r\n          setFavorites(response.data);\r\n          \r\n          // Also save to localStorage for offline access\r\n          const storageKey = getStorageKey(user.username);\r\n          await storageService.setItem(storageKey, response.data);\r\n        } else if (response.error) {\r\n          setError(response.error.message);\r\n          // Fallback to localStorage\r\n          const storageKey = getStorageKey(user.username);\r\n          const storedFavorites = await storageService.getItem<FavoriteSeller[]>(storageKey, []);\r\n          setFavorites(storedFavorites);\r\n        }\r\n      } else {\r\n        // Load from localStorage only\r\n        const storageKey = getStorageKey(user.username);\r\n        const storedFavorites = await storageService.getItem<FavoriteSeller[]>(storageKey, []);\r\n        \r\n        // Validate and sanitize loaded data\r\n        const validatedFavorites = storedFavorites.filter(fav => \r\n          fav.sellerId && fav.sellerUsername && fav.addedAt\r\n        ).map(fav => ({\r\n          ...fav,\r\n          sellerId: sanitizeStrict(fav.sellerId),\r\n          sellerUsername: sanitizeUsername(fav.sellerUsername),\r\n          addedAt: sanitizeStrict(fav.addedAt),\r\n        }));\r\n\r\n        setFavorites(validatedFavorites);\r\n      }\r\n    } catch (err) {\r\n      console.error('Error loading favorites:', err);\r\n      setError('Failed to load favorites');\r\n      setFavorites([]);\r\n    } finally {\r\n      setLoadingFavorites(false);\r\n    }\r\n  }, [user?.username, getStorageKey]);\r\n\r\n  // Load favorites when user changes\r\n  useEffect(() => {\r\n    loadFavorites();\r\n  }, [loadFavorites]);\r\n\r\n  // Check if seller is favorited\r\n  const isFavorited = useCallback((sellerId: string): boolean => {\r\n    return favorites.some(fav => fav.sellerId === sellerId);\r\n  }, [favorites]);\r\n\r\n  // Toggle favorite status\r\n  const toggleFavorite = useCallback(async (seller: {\r\n    id: string;\r\n    username: string;\r\n    profilePicture?: string;\r\n    tier?: string;\r\n    isVerified: boolean;\r\n  }): Promise<boolean> => {\r\n    if (!user?.username) {\r\n      setError('Please log in to add favorites');\r\n      return false;\r\n    }\r\n\r\n    // Rate limiting\r\n    const rateLimitResult = rateLimiter.check('FAVORITES_TOGGLE', {\r\n      maxAttempts: 30,\r\n      windowMs: 60 * 1000 // 30 toggles per minute\r\n    });\r\n\r\n    if (!rateLimitResult.allowed) {\r\n      setError(`Too many actions. Please wait ${rateLimitResult.waitTime} seconds.`);\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      const storageKey = getStorageKey(user.username);\r\n      const currentFavorites = [...favorites];\r\n      const existingIndex = currentFavorites.findIndex(fav => fav.sellerId === seller.id);\r\n\r\n      if (FEATURES.USE_API_USERS) {\r\n        // Use API\r\n        if (existingIndex >= 0) {\r\n          // Remove from favorites via API\r\n          const response = await favoritesService.removeFavorite(seller.id);\r\n          \r\n          if (response.success) {\r\n            const newFavorites = currentFavorites.filter(fav => fav.sellerId !== seller.id);\r\n            setFavorites(newFavorites);\r\n            await storageService.setItem(storageKey, newFavorites);\r\n            setError(null);\r\n            return true;\r\n          } else {\r\n            setError(response.error?.message || 'Failed to remove favorite');\r\n            return false;\r\n          }\r\n        } else {\r\n          // Add to favorites via API\r\n          const response = await favoritesService.addFavorite({\r\n            sellerId: seller.id,\r\n            sellerUsername: seller.username,\r\n            profilePicture: seller.profilePicture,\r\n            tier: seller.tier,\r\n            isVerified: seller.isVerified\r\n          });\r\n          \r\n          if (response.success && response.data) {\r\n            const newFavorites = [...currentFavorites, response.data];\r\n            setFavorites(newFavorites);\r\n            await storageService.setItem(storageKey, newFavorites);\r\n            setError(null);\r\n            return true;\r\n          } else {\r\n            setError(response.error?.message || 'Failed to add favorite');\r\n            return false;\r\n          }\r\n        }\r\n      } else {\r\n        // LocalStorage only\r\n        let newFavorites: FavoriteSeller[];\r\n\r\n        if (existingIndex >= 0) {\r\n          // Remove from favorites\r\n          newFavorites = currentFavorites.filter(fav => fav.sellerId !== seller.id);\r\n        } else {\r\n          // Add to favorites\r\n          const newFavorite: FavoriteSeller = {\r\n            sellerId: sanitizeStrict(seller.id),\r\n            sellerUsername: sanitizeUsername(seller.username),\r\n            addedAt: new Date().toISOString(),\r\n            profilePicture: seller.profilePicture,\r\n            tier: seller.tier,\r\n            isVerified: seller.isVerified,\r\n          };\r\n          newFavorites = [...currentFavorites, newFavorite];\r\n        }\r\n\r\n        // Save to storage\r\n        const success = await storageService.setItem(storageKey, newFavorites);\r\n        \r\n        if (success) {\r\n          setFavorites(newFavorites);\r\n          setError(null);\r\n          return true;\r\n        } else {\r\n          setError('Failed to update favorites');\r\n          return false;\r\n        }\r\n      }\r\n    } catch (err) {\r\n      console.error('Error toggling favorite:', err);\r\n      setError('Failed to update favorites');\r\n      return false;\r\n    }\r\n  }, [user?.username, favorites, getStorageKey, rateLimiter]);\r\n\r\n  const clearError = useCallback(() => {\r\n    setError(null);\r\n  }, []);\r\n\r\n  const refreshFavorites = useCallback(async () => {\r\n    await loadFavorites();\r\n  }, [loadFavorites]);\r\n\r\n  const contextValue: FavoritesContextType = {\r\n    favorites,\r\n    favoriteCount: favorites.length,\r\n    isFavorited,\r\n    toggleFavorite,\r\n    loadingFavorites,\r\n    error,\r\n    clearError,\r\n    refreshFavorites,\r\n  };\r\n\r\n  return (\r\n    <FavoritesContext.Provider value={contextValue}>\r\n      {children}\r\n    </FavoritesContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useFavorites() {\r\n  const context = useContext(FavoritesContext);\r\n  if (context === undefined) {\r\n    throw new Error('useFavorites must be used within a FavoritesProvider');\r\n  }\r\n  return context;\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 8962, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/gerom/OneDrive/Documents/pantypost/src/context/NotificationContext.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, { createContext, useContext, useState, useEffect, useCallback, useRef } from 'react';\r\nimport { useAuth } from './AuthContext';\r\nimport { useWebSocket } from './WebSocketContext';\r\nimport { notificationService } from '@/services/notification.service';\r\nimport type { Notification } from '@/types/notification';\r\nimport { WebSocketEvent } from '@/types/websocket';\r\n\r\ninterface NotificationContextType {\r\n  activeNotifications: Notification[];\r\n  clearedNotifications: Notification[];\r\n  unreadCount: number;\r\n  totalCount: number;\r\n  clearNotification: (notificationId: string) => Promise<void>;\r\n  clearAllNotifications: () => Promise<void>;\r\n  restoreNotification: (notificationId: string) => Promise<void>;\r\n  deleteNotification: (notificationId: string) => Promise<void>;\r\n  deleteAllCleared: () => Promise<void>;\r\n  markAsRead: (notificationId: string) => Promise<void>;\r\n  markAllAsRead: () => Promise<void>;\r\n  refreshNotifications: () => Promise<void>;\r\n  isLoading: boolean;\r\n  error: string | null;\r\n  addLocalNotification: (message: string, type?: string) => void;\r\n}\r\n\r\nconst NotificationContext = createContext<NotificationContextType | undefined>(undefined);\r\n\r\nexport const useNotifications = () => {\r\n  const ctx = useContext(NotificationContext);\r\n  if (!ctx) throw new Error('useNotifications must be used within NotificationProvider');\r\n  return ctx;\r\n};\r\n\r\nexport const NotificationProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n  const { user } = useAuth();\r\n  const ws = useWebSocket();\r\n  const subscribe = ws?.subscribe;\r\n\r\n  const [activeNotifications, setActiveNotifications] = useState<Notification[]>([]);\r\n  const [clearedNotifications, setClearedNotifications] = useState<Notification[]>([]);\r\n  const [unreadCount, setUnreadCount] = useState(0);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const isMountedRef = useRef(true);\r\n  const lastFetchRef = useRef<number>(0);\r\n  const FETCH_COOLDOWN = 1000;\r\n  \r\n  // Track processed notification IDs to prevent duplicates\r\n  const processedNotificationIds = useRef<Set<string>>(new Set());\r\n\r\n  const loadNotifications = useCallback(async () => {\r\n    if (!user || !isMountedRef.current) return;\r\n    const now = Date.now();\r\n    if (now - lastFetchRef.current < FETCH_COOLDOWN) return;\r\n    lastFetchRef.current = now;\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n    try {\r\n      const activeRes = await notificationService.getActiveNotifications(50);\r\n      if (activeRes.success && Array.isArray(activeRes.data) && isMountedRef.current) {\r\n        setActiveNotifications(activeRes.data);\r\n        setUnreadCount(activeRes.data.filter(n => !n.read).length);\r\n        \r\n        // Track all loaded notification IDs\r\n        activeRes.data.forEach(n => {\r\n          const id = n._id || n.id;\r\n          if (id) processedNotificationIds.current.add(id);\r\n        });\r\n      }\r\n      const clearedRes = await notificationService.getClearedNotifications(50);\r\n      if (clearedRes.success && Array.isArray(clearedRes.data) && isMountedRef.current) {\r\n        setClearedNotifications(clearedRes.data);\r\n      }\r\n    } catch (e) {\r\n      if (isMountedRef.current) setError('Failed to load notifications');\r\n    } finally {\r\n      if (isMountedRef.current) setIsLoading(false);\r\n    }\r\n  }, [user]);\r\n\r\n  useEffect(() => {\r\n    isMountedRef.current = true;\r\n    if (user) {\r\n      loadNotifications();\r\n    } else {\r\n      setActiveNotifications([]);\r\n      setClearedNotifications([]);\r\n      setUnreadCount(0);\r\n    }\r\n    return () => { isMountedRef.current = false; };\r\n  }, [user, loadNotifications]);\r\n\r\n  // FIXED: Only listen to the primary notification:new event from backend\r\n  useEffect(() => {\r\n    if (!subscribe || !user) return;\r\n    const unsubs: Array<() => void> = [];\r\n\r\n    // PRIMARY: This is the ONLY source for tip notifications\r\n    // The backend's Notification.createTipNotification automatically emits this\r\n    unsubs.push(subscribe('notification:new' as WebSocketEvent, (data: any) => {\r\n      if (!isMountedRef.current) return;\r\n      \r\n      console.log('[NotificationContext] notification:new received', data);\r\n      \r\n      // Check if we've already processed this notification\r\n      const notificationId = data.id || data._id;\r\n      if (notificationId && processedNotificationIds.current.has(notificationId)) {\r\n        console.log('[NotificationContext] Skipping duplicate notification:', notificationId);\r\n        return;\r\n      }\r\n      \r\n      // Add to processed set\r\n      if (notificationId) {\r\n        processedNotificationIds.current.add(notificationId);\r\n        \r\n        // Clean up old IDs to prevent memory leak\r\n        if (processedNotificationIds.current.size > 200) {\r\n          const idsArray = Array.from(processedNotificationIds.current);\r\n          processedNotificationIds.current = new Set(idsArray.slice(-100));\r\n        }\r\n      }\r\n      \r\n      const n: Notification = {\r\n        id: notificationId,\r\n        _id: notificationId,\r\n        recipient: data.recipient || user.username,\r\n        type: data.type,\r\n        title: data.title,\r\n        message: data.message,\r\n        data: data.data,\r\n        read: false,\r\n        cleared: false,\r\n        priority: data.priority || 'normal',\r\n        createdAt: data.createdAt || new Date().toISOString()\r\n      };\r\n      \r\n      // Check if notification already exists in state\r\n      setActiveNotifications(prev => {\r\n        const exists = prev.some(existing => \r\n          (existing._id || existing.id) === notificationId\r\n        );\r\n        \r\n        if (exists) {\r\n          console.log('[NotificationContext] Notification already in state:', notificationId);\r\n          return prev;\r\n        }\r\n        \r\n        return [n, ...prev];\r\n      });\r\n      \r\n      setUnreadCount(c => c + 1);\r\n    }));\r\n\r\n    // REMOVED: Legacy tip_received listener - no longer needed\r\n    // REMOVED: message:new tip listener - no longer needed\r\n    \r\n    // Clear/restore/delete event handlers remain the same\r\n    unsubs.push(subscribe('notification:cleared' as WebSocketEvent, (data: any) => {\r\n      const id = data?.notificationId;\r\n      setActiveNotifications(prev => {\r\n        const found = prev.find(n => (n._id || n.id) === id);\r\n        if (found) {\r\n          setClearedNotifications(c => [found, ...c]);\r\n          if (!found.read) setUnreadCount(u => Math.max(0, u - 1));\r\n        }\r\n        return prev.filter(n => (n._id || n.id) !== id);\r\n      });\r\n    }));\r\n\r\n    unsubs.push(subscribe('notification:all_cleared' as WebSocketEvent, () => {\r\n      setActiveNotifications(prevActive => {\r\n        setClearedNotifications(prevCleared => [\r\n          ...prevActive.map(n => ({ ...n, cleared: true })),\r\n          ...prevCleared\r\n        ]);\r\n        setUnreadCount(0);\r\n        return [];\r\n      });\r\n    }));\r\n\r\n    unsubs.push(subscribe('notification:restored' as WebSocketEvent, (data: any) => {\r\n      const id = data?.notificationId;\r\n      setClearedNotifications(prev => {\r\n        const found = prev.find(n => (n._id || n.id) === id);\r\n        if (found) {\r\n          setActiveNotifications(active => {\r\n            // Check if already exists to prevent duplicates\r\n            const exists = active.some(n => (n._id || n.id) === id);\r\n            if (exists) return active;\r\n            return [found, ...active];\r\n          });\r\n          if (!found.read) setUnreadCount(c => c + 1);\r\n        }\r\n        return prev.filter(n => (n._id || n.id) !== id);\r\n      });\r\n    }));\r\n\r\n    unsubs.push(subscribe('notification:deleted' as WebSocketEvent, (data: any) => {\r\n      const id = data?.notificationId;\r\n      setClearedNotifications(prev => prev.filter(n => (n._id || n.id) !== id));\r\n    }));\r\n\r\n    return () => unsubs.forEach(fn => fn());\r\n  }, [subscribe, user]);\r\n\r\n  // Actions\r\n  const clearNotification = useCallback(async (id: string) => {\r\n    try {\r\n      const res = await notificationService.clearNotification(id);\r\n      if (res.success) {\r\n        setActiveNotifications(prev => {\r\n          const found = prev.find(n => (n._id || n.id) === id);\r\n          if (found) {\r\n            setClearedNotifications(c => [{ ...found, cleared: true }, ...c]);\r\n            if (!found.read) setUnreadCount(u => Math.max(0, u - 1));\r\n          }\r\n          return prev.filter(n => (n._id || n.id) !== id);\r\n        });\r\n      } else setError('Failed to clear notification');\r\n    } catch {\r\n      setError('Failed to clear notification');\r\n    }\r\n  }, []);\r\n\r\n  const clearAllNotifications = useCallback(async () => {\r\n    try {\r\n      const res = await notificationService.clearAll();\r\n      if (res.success) {\r\n        setActiveNotifications(prevActive => {\r\n          setClearedNotifications(prevCleared => [\r\n            ...prevActive.map(n => ({ ...n, cleared: true })),\r\n            ...prevCleared\r\n          ]);\r\n          setUnreadCount(0);\r\n          return [];\r\n        });\r\n      } else setError('Failed to clear all notifications');\r\n    } catch {\r\n      setError('Failed to clear all notifications');\r\n    }\r\n  }, []);\r\n\r\n  const restoreNotification = useCallback(async (id: string) => {\r\n    try {\r\n      const res = await notificationService.restoreNotification(id);\r\n      if (res.success) {\r\n        setClearedNotifications(prev => {\r\n          const found = prev.find(n => (n._id || n.id) === id);\r\n          if (found) {\r\n            setActiveNotifications(active => {\r\n              // Check if already exists to prevent duplicates\r\n              const exists = active.some(n => (n._id || n.id) === id);\r\n              if (exists) return active;\r\n              return [found, ...active];\r\n            });\r\n            if (!found.read) setUnreadCount(u => u + 1);\r\n          }\r\n          return prev.filter(n => (n._id || n.id) !== id);\r\n        });\r\n      } else setError('Failed to restore notification');\r\n    } catch {\r\n      setError('Failed to restore notification');\r\n    }\r\n  }, []);\r\n\r\n  const deleteNotification = useCallback(async (id: string) => {\r\n    try {\r\n      const res = await notificationService.deleteNotification(id);\r\n      if (res.success) {\r\n        setClearedNotifications(prev => prev.filter(n => (n._id || n.id) !== id));\r\n      } else setError('Failed to delete notification');\r\n    } catch {\r\n      setError('Failed to delete notification');\r\n    }\r\n  }, []);\r\n\r\n  const deleteAllCleared = useCallback(async () => {\r\n    try {\r\n      const res = await notificationService.deleteAllCleared();\r\n      if (res.success) {\r\n        setClearedNotifications([]);\r\n      } else setError('Failed to delete cleared notifications');\r\n    } catch {\r\n      setError('Failed to delete cleared notifications');\r\n    }\r\n  }, []);\r\n\r\n  const markAsRead = useCallback(async (id: string) => {\r\n    try {\r\n      const res = await notificationService.markAsRead(id);\r\n      if (res.success) {\r\n        setActiveNotifications(prev =>\r\n          prev.map(n => (n._id || n.id) === id ? { ...n, read: true } : n)\r\n        );\r\n        const found = activeNotifications.find(n => (n._id || n.id) === id);\r\n        if (found && !found.read) setUnreadCount(u => Math.max(0, u - 1));\r\n      }\r\n    } catch {}\r\n  }, [activeNotifications]);\r\n\r\n  const markAllAsRead = useCallback(async () => {\r\n    try {\r\n      const res = await notificationService.markAllAsRead();\r\n      if (res.success) {\r\n        setActiveNotifications(prev => prev.map(n => ({ ...n, read: true })));\r\n        setUnreadCount(0);\r\n      }\r\n    } catch {}\r\n  }, []);\r\n\r\n  const addLocalNotification = useCallback((message: string, type: string = 'system') => {\r\n    if (!user) return;\r\n    const n: Notification = {\r\n      id: `local_${Date.now()}`,\r\n      recipient: user.username,\r\n      type: type as any,\r\n      title: 'Notification',\r\n      message,\r\n      read: false,\r\n      cleared: false,\r\n      createdAt: new Date().toISOString(),\r\n      priority: 'normal'\r\n    };\r\n    setActiveNotifications(prev => [n, ...prev]);\r\n    setUnreadCount(c => c + 1);\r\n  }, [user]);\r\n\r\n  const value: NotificationContextType = {\r\n    activeNotifications,\r\n    clearedNotifications,\r\n    unreadCount,\r\n    totalCount: activeNotifications.length + clearedNotifications.length,\r\n    clearNotification,\r\n    clearAllNotifications,\r\n    restoreNotification,\r\n    deleteNotification,\r\n    deleteAllCleared,\r\n    markAsRead,\r\n    markAllAsRead,\r\n    refreshNotifications: loadNotifications,\r\n    isLoading,\r\n    error,\r\n    addLocalNotification\r\n  };\r\n\r\n  return (\r\n    <NotificationContext.Provider value={value}>\r\n      {children}\r\n    </NotificationContext.Provider>\r\n  );\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}}]
}